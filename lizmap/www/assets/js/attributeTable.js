lizMap.events.on({uicreated:function(e){var t=lizMap.config,a=(lizMap.layers,!1),r={},i={},l=OpenLayers.Util.urlAppend(lizUrls.media,OpenLayers.Util.getParameterString(lizUrls.params)),n=!1;"undefined"!=typeof lizLayerFilter&&(n=!0,lizMap.lizmapLayerFilterActive=!0);var s=!1;if("limitDataToBbox"in t.options&&"True"==t.options.limitDataToBbox&&(s=!0),!("attributeLayers"in t))return-1;OpenLayers.Util.urlAppend(lizUrls.wms,OpenLayers.Util.getParameterString(lizUrls.params));var u=lizMap.getVectorLayerFeatureTypes();if(0==u.length)return-1;$("body").css("cursor","wait");var o=[];for(var d in t.attributeLayers)(p=t.attributeLayers[d]).name=d,o.push(p);o.sort((function(e,t){return e.order-t.order}));for(var b=0;b<o.length;b++){var p=o[b];r[lizMap.cleanName(p.name)]=p.name}for(const e of u){var y=e.getElementsByTagName("Name")[0].textContent,f=lizMap.getNameByTypeName(y);if(f&&null!=f){var v=lizMap.cleanName(f),m=r[v];if(i[v]=y,m in t.attributeLayers){a=!0;var h=t.attributeLayers[m];t.layers[m].features={},t.layers[m].featureCrs=null,t.layers[m].featuresFullSet=!1,t.layers[m].selectedFeatures=[],t.layers[m].highlightedFeature=null,t.layers[m].filteredFeatures=[],t.layers[m].request_params={filter:null,exp_filter:null,selection:null};var g=lizMap.map.getLayersByName(v)[0];g&&"FILTER"in g.params&&g.params.FILTER&&(t.layers[m].request_params.filter=g.params.FILTER,lizMap.events.triggerEvent("layerFilterParamChanged",{featureType:r[v],filter:t.layers[m].request_params.filter,updateDrawing:!1})),void 0===t.layers[m].geometryType&&(t.layers[m].geometryType="unknown"),t.layers[m].crs=e.getElementsByTagName("SRS")[0].textContent,""!==t.layers[m].crs&&lizMap.loadProjDefinition(t.layers[m].crs,(function(e){new OpenLayers.Projection(t.layers[m].crs)}));var z=e.getElementsByTagName("LatLongBoundingBox")[0];h.bbox=[parseFloat(z.getAttribute("minx")),parseFloat(z.getAttribute("miny")),parseFloat(z.getAttribute("maxx")),parseFloat(z.getAttribute("maxy"))]}}}if(!a)return $("#mapmenu li.attributeLayers").hide(),-1;var L=!1,T='<table id="attribute-layer-list-table" class="table table-condensed table-hover table-striped" style="width:auto;">';for(var F in r)v=F,"pivot"in t.attributeLayers[r[v]]&&"True"==t.attributeLayers[r[v]].pivot||"hideLayer"in t.attributeLayers[r[v]]&&"True"==t.attributeLayers[r[v]].hideLayer||(T+="<tr>",T+="   <td>"+t.layers[r[v]].title+"</td><td><button value="+v+' class="btn btn-open-attribute-layer">'+lizDict["attributeLayers.toolbar.btn.detail"]+"</button></td>",T+="</tr>",L=!0);function M(e,a){if("relations"in t&&e in t.relations){var r=t.relations[e];for(var i in r){var l=r[i];if(l.referencingLayer==a)return l}}return null}function C(e){var a={},r=lizMap.getLayerConfigById(e,t.attributeLayers,"layerId");if(!r)return!1;a.name=r[0];var i=t.layers[r[0]].selectedFeatures;if(!(i.length>0))return!1;var l=[],n=t.layers[r[0]].features;if(!n||Object.keys(n).length<=0)return!1;var s=r[1].primaryKey,u=/^[0-9]+$/;for(var o in i){var c=n[i[o]];if(void 0!==c){var d=c.properties[s];u.test(d)||(d=" '"+d+"' "),l.push(d)}}return a.selected=l,a}function k(e){var a=null,r=[],i=[],l="",n=[],s="",u=[],o=t.layers[e];if(!o)return a;var c=o.id;if("relations"in t&&c in t.relations){var d=t.relations[c],b=0,p="active";for(var y in d){var f=d[y],v=lizMap.getLayerConfigById(f.referencingLayer,t.layers,"id");if(v&&v[0]in t.attributeLayers){(b+=1)>1&&(p="");var m=v[1],h=v[0],g=t.attributeLayers[h];if("hideAsChild"in g&&"True"==g.hideAsChild)continue;var $="attribute-child-tab-"+lizMap.cleanName(e)+"-"+lizMap.cleanName(h),z='<div class="tab-pane attribute-layer-child-content '+p+'" id="'+$+'" >',L="attribute-layer-table-"+lizMap.cleanName(e)+"-"+lizMap.cleanName(h),T="attribute-table-table table table-hover table-condensed table-striped cell-border child-of-"+lizMap.cleanName(e);z+='    <input type="hidden" class="attribute-table-hidden-parent-layer" value="'+lizMap.cleanName(e)+'">',z+='    <input type="hidden" class="attribute-table-hidden-layer" value="'+lizMap.cleanName(h)+'">',z+='    <table id="'+L+'" class="'+T+'" width="100%"></table>',z+="</div>",r.push(z);var F='<li id="nav-tab-'+$+'" class="'+p+'"><a href="#'+$+'" data-toggle="tab">'+m.title+"</a></li>";i.push(F);var M=!1;"editionLayers"in t&&(lizMap.getLayerConfigById(f.referencingLayer,t.editionLayers,"layerId"),h in t.editionLayers&&"True"==t.editionLayers[h].capabilities.createFeature&&(M=!0)),M&&(n.push('<li><a href="#'+lizMap.cleanName(h)+'" class="btn-createFeature-attributeTable">'+m.title+"</a></li>"),u.push('<li><a href="#'+lizMap.cleanName(h)+'" class="btn-linkFeatures-attributeTable">'+m.title+"</a></li>"))}}}if(i.length){if(n.length>0){for(var C in l+='&nbsp;<div class="btn-group" role="group" >',l+='    <button type="button" class="btn btn-mini dropdown-toggle" data-toggle="dropdown" aria-expanded="false">',l+=lizDict["attributeLayers.toolbar.btn.data.createChildFeature.title"],l+='      <span class="caret"></span>',l+="    </button>",l+='    <ul class="dropdown-menu" role="menu">',n)l+=n[C];l+="    </ul>",l+="</div>"}if(u.length>0){for(var C in s+='&nbsp;<div class="btn-group" role="group" >',s+='    <button type="button" class="btn btn-mini dropdown-toggle" data-toggle="dropdown" aria-expanded="false">',s+=lizDict["attributeLayers.toolbar.btn.data.linkFeatures.title"],s+='      <span class="caret"></span>',s+="    </button>",s+='    <ul class="dropdown-menu" role="menu">',u)s+=u[C];s+="    </ul>",s+="</div>"}a={"tab-content":r,"tab-li":i,childCreateButton:l,layerLinkButton:s}}return a}function w(e,t,a){O(e,t,null,"extent",(function(e,t,r,i){E(e,a,r,i)}))}T+="</table>",L?($("#attribute-layer-list").html(T),$("button.btn-open-attribute-layer").click((function(){var e=$(this).val();if(s){var a=lizMap.map.getLayersByName(e)[0],i=lizMap.map.getScale();if(a&&!(a.maxScale<i&&i<a.minScale)){var l=lizDict["attributeLayers.msg.layer.not.visible"];return lizMap.addMessage(l,"info",!0).attr("id","lizmap-attribute-message"),!1}}var u=r[e];$("#nav-tab-attribute-layer-"+e).length||function(e){t.attributeLayers[e];var a=lizMap.cleanName(e),i='<li id="nav-tab-attribute-layer-'+a+'">';i+='<a href="#attribute-layer-'+a+'" data-toggle="tab">'+t.layers[e].title,i+='&nbsp;<i class="btn-close-attribute-tab icon-remove icon-white" style="cursor:pointer"></i>',i+="</a>",i+="</li>",$("#attributeLayers-tabs").append(i);var l='<div id="attribute-layer-'+a+'" class="tab-pane attribute-content bottom-content" >';l+='    <div class="attribute-layer-main" id="attribute-layer-main-'+a+'" >',t.layers[e].selectedFeatures||(t.layers[e].selectedFeatures=[]),t.layers[e].filteredFeatures||(t.layers[e].filteredFeatures=[]);var u="";0==t.layers[e].selectedFeatures.length&&(u=" hidden");var o;o=t.layers[e].filteredFeatures.length>0?" active btn-warning":u,l+='<div class="attribute-layer-action-bar">',l+='<div class="btn-group">',l+='  <input id="attribute-layer-search-'+a+'" type="search" class="form-control" placeholder="'+lizDict["attributeLayers.toolbar.input.search.title"]+'">',l+='  <i class="clear-layer-search icon-remove" style="position:absolute;right:4px;top:4px;cursor:pointer;"></i>',l+="</div>",l+='<button class="btn-select-searched btn btn-mini" value="'+a+'" title="'+lizDict["attributeLayers.toolbar.btn.select.searched.title"]+'"><i class="icon-star"></i></button>',l+='    <button class="btn-unselect-attributeTable btn btn-mini'+u+'" value="'+a+'" title="'+lizDict["attributeLayers.toolbar.btn.data.unselect.title"]+'"><i class="icon-star-empty"></i></button>',l+='    <button class="btn-moveselectedtotop-attributeTable btn btn-mini'+u+'" value="'+a+'" title="'+lizDict["attributeLayers.toolbar.btn.data.moveselectedtotop.title"]+'"><i class="icon-arrow-up"></i></button>',n||lizMap.lizmapLayerFilterActive&&lizMap.lizmapLayerFilterActive!=a||(l+='    <button class="btn-filter-attributeTable btn btn-mini'+o+'" value="'+a+'" title="'+lizDict["attributeLayers.toolbar.btn.data.filter.title"]+'"><i class="icon-filter"></i></button>'),l+='<lizmap-selection-invert tooltip-placement="bottom" feature-type="'+a+'"></lizmap-selection-invert>';var c=!1;t.layers[e]&&"True"==t.layers[e].popup&&"none"!=t.layers[e].geometryType&&"unknown"!=t.layers[e].geometryType&&(c=!0),c&&(l+='<button type="checkbox" class="btn-detail-attributeTable btn btn-mini" value="'+a+'" title="'+lizDict["attributeLayers.toolbar.cb.data.detail.title"]+'">',l+='<i class="icon-info-sign"></i>',l+="</button>");var d=!1;"editionLayers"in t&&a in t.editionLayers&&"True"==t.editionLayers[r[a]].capabilities.createFeature&&(d=!0),d&&(l+='    <button class="btn-createFeature-attributeTable btn btn-mini" value="'+a+'" title="'+lizDict["attributeLayers.toolbar.btn.data.createFeature.title"]+'"><i class="icon-plus-sign"></i></button>'),s&&"none"!=t.layers[e].geometryType&&"unknown"!=t.layers[e].geometryType&&(l+='    <button class="btn-refresh-table btn btn-mini" value="'+a+'" title="'+lizDict["attributeLayers.toolbar.btn.refresh.table.tooltip"]+'">'+lizDict["attributeLayers.toolbar.btn.refresh.table.title"]+"</button>");var b=k(e),p="";if(b&&(l+='    <button class="btn-toggle-children btn btn-mini" value="'+a+'" >'+lizDict["attributeLayers.toolbar.btn.toggle.children.title"]+"</button>",b.childCreateButton&&(l+=b.childCreateButton),b.layerLinkButton&&(l+=b.layerLinkButton)),"exportLayers"in t.options&&"True"==t.options.exportLayers){l+='&nbsp;<div class="export-formats btn-group pull-right" role="group" >',l+='    <button type="button" class="btn btn-mini dropdown-toggle" data-toggle="dropdown" aria-expanded="false">',l+=lizDict["attributeLayers.toolbar.btn.data.export.title"],l+='      <span class="caret"></span>',l+="    </button>",l+='    <ul class="dropdown-menu" role="menu">',l+='        <li><a href="#" class="btn-export-attributeTable">GeoJSON</a></li>',l+='        <li><a href="#" class="btn-export-attributeTable">GML</a></li>';for(var y=lizMap.getVectorLayerResultFormat(),f=0,v=y.length;f<v;f++){var m=y[f].toLowerCase();"gml2"!=m&&"gml3"!=m&&"geojson"!=m&&(l+='        <li><a href="#" class="btn-export-attributeTable">'+m+"</a></li>")}l+="    </ul>",l+="</div>"}if(l+="</div>",b&&(p=" showChildren"),l+='<div class="attribute-layer-content'+p+'">',l+='    <input type="hidden" class="attribute-table-hidden-layer" value="'+a+'">',l+='    <table id="attribute-layer-table-'+a+'" class="attribute-table-table table table-hover table-condensed table-striped order-column cell-border" width="100%"></table>',l+="</div>",b){for(var f in l+='<div class="tabbable attribute-layer-child-content">',l+='    <ul class="nav nav-tabs">',b["tab-li"])l+=b["tab-li"][f];for(var f in l+="    </ul>",l+='    <div class="tab-content">',b["tab-content"])l+=b["tab-content"][f];l+="    </div>",l+="</div>"}l+="</div>",l+='    <div class="attribute-layer-feature-panel" id="attribute-table-panel-'+a+'" ></div>',l+="</div>",$("#attribute-table-container").append(l),$("#attribute-layer-"+a+" button").tooltip({placement:"bottom"}),$(".btn-close-attribute-tab").click((function(){var e=$(this).parent().attr("href");$(this).parent().parent().remove(),$("#attributeLayers-tabs a:last").tab("show"),$(e).remove()})),b&&$("#attribute-layer-"+a+' div.attribute-layer-child-content ul li a[data-toggle="tab"]').on("shown.bs.tab",(function(e){var t=$(e.target).attr("href");$(t).find("table.dataTable").DataTable().tables().columns.adjust()})),s&&$("#attribute-layer-"+a+" button.btn-refresh-table").click((function(){$(this).attr("data-original-title",lizDict["attributeLayers.toolbar.btn.refresh.table.tooltip"]).removeClass("btn-warning");var t=lizMap.map.getLayersByName(a)[0],r=lizMap.map.getScale();if(!t)return!1;if(!(t.maxScale<r&&r<t.minScale)){var i=lizDict["attributeLayers.msg.layer.not.visible"];return lizMap.addMessage(i,"info",!0).attr("id","lizmap-attribute-message"),!1}var l="#attribute-layer-table-"+a;return $("#attribute-layer-main-"+a+" > div.attribute-layer-content").hide(),O(e,null,null,"extent",(function(e,t,r,i){E(e,l,r,i),$("#attribute-layer-main-"+a+" > div.attribute-layer-content").show(),W("#attribute-layer-main-"+a)})),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),b&&$("#attribute-layer-"+a+" button.btn-toggle-children").click((function(){var e=$(this).parents("div.attribute-layer-main");return e.find("div.attribute-layer-content").toggleClass("showChildren"),e.find("div.tabbable.attribute-layer-child-content").toggle(),W("#attribute-layer-main-"+a),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),c&&$("#attribute-layer-"+a+" button.btn-detail-attributeTable").click((function(){return r[$(this).val()],$(this).hasClass("active")?($(this).removeClass("active btn-warning"),$("#attribute-layer-main-"+a).removeClass("reduced"),$("#attribute-table-panel-"+a).removeClass("visible")):($(this).addClass("active btn-warning"),$("#attribute-layer-main-"+a).addClass("reduced"),$("#attribute-table-panel-"+a).addClass("visible")),W("#attribute-layer-main-"+a),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),$("#attribute-layer-"+a+" button.btn-unselect-attributeTable").click((function(){var e=r[$(this).val()];return lizMap.events.triggerEvent("layerfeatureunselectall",{featureType:e,updateDrawing:!0}),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),$("#attribute-layer-"+a+" button.btn-moveselectedtotop-attributeTable").click((function(){var e="#attribute-layer-table-"+$(this).val(),t=$(e).DataTable(),a=t.order();a=$.grep(a,(function(e){return 0!=e[0]}));var r=[[0,"asc"]].concat(a);return t.order(r).draw(),$(e).parents("div.attribute-layer-content").scrollTop(0),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),n||$("#attribute-layer-"+a+" button.btn-filter-attributeTable").click((function(){var e=r[$(this).val()];return $(this).hasClass("active")?(lizMap.events.triggerEvent("layerfeatureremovefilter",{featureType:e}),lizMap.lizmapLayerFilterActive=null):(lizMap.events.triggerEvent("layerfeaturefilterselected",{featureType:e}),lizMap.lizmapLayerFilterActive=e),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),$("#attribute-layer-"+a+" a.btn-export-attributeTable").click((function(){var e=$(this).text();"GML"==e&&(e="GML3");var t=$(this).parents("div.attribute-layer-main:first").attr("id").replace("attribute-layer-main-",""),a=r[t];return lizMap.exportVectorLayer(a,e,s),$(this).blur(),!1})),$("#attribute-layer-"+a+" button.btn-createFeature-attributeTable").click((function(){if(1!=$("#attribute-layer-"+a+" tr.active").length)return $("#lizmap-edition-message").remove(),lizMap.addMessage(lizDict["attributeLayers.toolbar.btn.data.createChildFeature.no.actived"],"info",!0).attr("id","lizmap-edition-message"),!1;var e=$("#attribute-layer-"+a+" tr.active button.attribute-layer-feature-select").val(),i=r[a],l=t.layers[i].id,n=r[$(this).val()];return lizMap.getLayerFeature(i,e,(function(e){var a=t.layers[n].id;lizMap.launchEdition(a,null,{layerId:l,feature:e})})),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),$("#attribute-layer-"+a+" a.btn-createFeature-attributeTable").click((function(){if(1!=$("#attribute-layer-"+a+" tr.active").length)return $("#lizmap-edition-message").remove(),lizMap.addMessage(lizDict["attributeLayers.toolbar.btn.data.createChildFeature.no.actived"],"info",!0).attr("id","lizmap-edition-message"),!1;var e=$("#attribute-layer-"+a+" tr.active button.attribute-layer-feature-select").val(),i=r[a],l=t.layers[i].id,n=$(this).attr("href").replace("#",""),s=r[n];return lizMap.getLayerFeature(i,e,(function(e){var a=t.layers[s].id;lizMap.launchEdition(a,null,{layerId:l,feature:e}),$(this).blur()})),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),$("#attribute-layer-"+a+" a.btn-linkFeatures-attributeTable").click((function(){var e=$(this).attr("href").replace("#","");$(this).blur();var i=r[e],l=t.layers[i].id,n=t.attributeLayers[i],s=[],u=r[a],o=t.layers[u].id,c=!1;if("pivot"in n&&"True"==n.pivot&&l in t.relations.pivot){for(var d in t.relations.pivot[l]){if(!(p=C(d)))return!1;p.id=d;var b=t.relations.pivot[l][d];p.fkey=b,s.push(p)}if(2!=s.length)return!1;c="pivot"}else{var p=C(o),y=C(l);if(!p||!y)return!1;if(p.id=o,p.fkey=t.attributeLayers[i].primaryKey,y.id=l,!(o in t.relations))return!1;for(var f in t.relations[o]){var v=t.relations[o][f];v.referencingLayer==l&&(y.fkey=v.referencingField)}if(!("fkey"in y))return!1;s.push(p),s.push(y),c="1n"}if(c){var m=OpenLayers.Util.urlAppend(lizUrls.edition,OpenLayers.Util.getParameterString(lizUrls.params));$.post(m.replace("getFeature","linkFeatures"),{features1:s[0].id+":"+s[0].fkey+":"+s[0].selected.join(),features2:s[1].id+":"+s[1].fkey+":"+s[1].selected.join(),pivot:l},(function(e){$("#lizmap-edition-message").remove(),lizMap.addMessage(e,"info",!0).attr("id","lizmap-edition-message"),"pivot"==c?(lizMap.events.triggerEvent("layerfeatureunselectall",{featureType:r[a],updateDrawing:!0}),lizMap.events.triggerEvent("lizmapeditionfeaturecreated",{layerId:l})):(lizMap.events.triggerEvent("layerfeatureunselectall",{featureType:i,updateDrawing:!0}),lizMap.events.triggerEvent("lizmapeditionfeaturemodified",{layerId:l}))}))}return!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),$("#attribute-layer-"+a+" button.btn-select-searched").click((function(){var e=r[$(this).val()];return lizMap.events.triggerEvent("layerfeatureselectsearched",{featureType:e,updateDrawing:!0}),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")}))}(u);var o="#attribute-layer-table-"+e;return O(u,null,null,"extent",(function(e,t,a,r){E(e,o,a,r)})),$("#nav-tab-attribute-layer-"+e+" a").tab("show"),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),$('#jforms_view_attribute_layers_option_cascade_label input[name="cascade"]').change((function(){var e=$('#jforms_view_attribute_layers_option_cascade_label input[name="cascade"]').prop("checked");if(lizMap.lizmapLayerFilterActive){var a=lizMap.lizmapLayerFilterActive;if(t.layers[a].filteredFeatures){V(a);var r=!0;e||(r="removeChildrenFilter"),K(a,r)}}}))):$("#mapmenu li.attributeLayers").hide(),lizMap.events.triggerEvent("attributeLayersReady",{layers:r}),s&&lizMap.map.events.on({moveend:function(){var e;e=lizDict["attributeLayers.toolbar.btn.refresh.table.tooltip.changed"],e+=" "+lizDict["attributeLayers.toolbar.btn.refresh.table.tooltip"],$("button.btn-refresh-table").attr("data-original-title",e).addClass("btn-warning").tooltip()}}),$("#attributeLayers-tabs li").click((function(){W("#"+$("#bottom-dock div.bottom-content.active div.attribute-layer-main").attr("id"))})),$("body").css("cursor","auto");var D,I=(D=0,function(e,t){clearTimeout(D),D=setTimeout(e,t)});function N(e,a,r,i){var l=t.layers[e],n=lizMap.cleanName(e),s=!0;let u="";if(["#attribute-layer-table-","#edition-table-"].includes(a.replace(n,"")))s=!1;else{let e="";a.startsWith("#attribute-layer-table-")?e=a.replace("#attribute-layer-table-","").split("-")[0]:a.startsWith("#edition-table-")&&(e=a.replace("#edition-table-","").split("-")[0]),e&&(u=t.layers[e].id)}var o=!1;s&&"pivot"in t.attributeLayers[e]&&"True"==t.attributeLayers[e].pivot&&(o=!0);var c=[];e in t.attributeLayers&&"hiddenFields"in t.attributeLayers[e]&&t.attributeLayers[e].hiddenFields&&(c=t.attributeLayers[e].hiddenFields.trim().split(/[\s,]+/));var d,b=!1,p=!1;if("editionLayers"in t&&e in t.editionLayers){var y=t.editionLayers[e];"True"!=y.capabilities.modifyAttribute&&"True"!=y.capabilities.modifyGeometry||(b=!0),"True"==y.capabilities.deleteFeature&&(p=!0)}if(!(r=void 0!==r?r:null)){var f=t.layers[e].features;r=Object.keys(f).map((function(e){return f[e]}))}if(r&&r.length>0){var v=x(r,l.geometryType,b,p,s,o,c,l.selectedFeatures),m=v.foundFeatures,h=v.dataSet;$.fn.dataTable.isDataTable(a)&&((d=$(a).dataTable()).fnClearTable(),d.fnAddData(h)),l.features=m}return r&&0!=r.length?$(a).show():($.fn.dataTable.isDataTable(a)&&(d=$(a).dataTable()).fnClearTable(),$(a).hide(),$("#attribute-layer-"+n+" span.attribute-layer-msg").html(lizDict["attributeLayers.toolbar.msg.data.nodata"]+" "+lizDict["attributeLayers.toolbar.msg.data.extent"]).addClass("failure")),i&&i(e,a),!1}function E(e,a,r,i,n){var s=t.layers[e],u=lizMap.cleanName(e);(i=void 0!==i?i:null)||(i=s.alias);for(const e in i)""==i[e]&&(i[e]=e);var o={};"types"in t.layers[e]&&(o=t.layers[e].types);var c=!0;"#attribute-layer-table-"==a.replace(u,"")&&(c=!1);var d=!1;c&&"pivot"in t.attributeLayers[e]&&"True"==t.attributeLayers[e].pivot&&(d=!0);var b=[];e in t.attributeLayers&&"hiddenFields"in t.attributeLayers[e]&&t.attributeLayers[e].hiddenFields&&(b=t.attributeLayers[e].hiddenFields.trim().split(/[\s,]+/));var p=!1,y=!1;if("editionLayers"in t&&e in t.editionLayers){var f=t.editionLayers[e];"True"!=f.capabilities.modifyAttribute&&"True"!=f.capabilities.modifyGeometry||(p=!0),"True"==f.capabilities.deleteFeature&&(y=!0)}if(!(r=void 0!==r?r:null)){var v=t.layers[e].features;r=Object.keys(v).map((function(e){return v[e]}))}var m=r,h=m.length;if(r&&r.length>0){var g=function(e,a,r,i,n,s,u,o,c,d){var b=[],p=0;for(var y in b.push({data:"lizSelected",width:"25px",searchable:!1,sortable:!0,visible:!1}),p+=1,b.push({data:"select",width:"25px",searchable:!1,sortable:!1}),p+=1,i&&(b.push({data:"edit",width:"25px",searchable:!1,sortable:!1}),p+=1),n&&(b.push({data:"delete",width:"25px",searchable:!1,sortable:!1}),p+=1),i&&s&&!u&&(b.push({data:"unlink",width:"25px",searchable:!1,sortable:!1}),p+=1),"none"!=r&&"unknown"!=r&&(b.push({data:"zoom",width:"25px",searchable:!1,sortable:!1}),b.push({data:"center",width:"25px",searchable:!1,sortable:!1}),p+=2),a[0].properties)if(!($.inArray(y,o)>-1)){var f={mData:y,title:c[y]};if(y in d)switch(d[y]){case"integer":case"int":case"unsignedInt":case"long":case"unsignedLong":f.mRender=function(t,a,r,i){return _(e,t,0,0,i)},f.className="text-right";break;case"decimal":case"double":f.mRender=function(e,t,a,r){return parseFloat(e)},f.className="text-right";break;case"date":f.className="text-center";break;default:f.mRender=function(t,a,r,i){var n=_(e,t,0,0,i);if(!n||"string"!=typeof n)return n;if("media/"==n.substr(0,6)||"/media/"==n.substr(0,7)||"../media/"==n.substr(0,9)){var s=n,u=i.settings.aoColumns[i.col];return"/media/"==n.substr(0,7)&&(s=n.slice(1)),'<a href="'+l+"&path="+s+'" target="_blank">'+u.title+"</a>"}return"http"==n.substr(0,4)||"www"==n.substr(0,3)?(s=n,"www"==n.substr(0,3)&&(s="http://"+n),'<a href="'+s+'" target="_blank">'+n+"</a>"):n}}b.push(f)}var v={columns:b,firstDisplayedColIndex:p};if("attributetableconfig"in t.attributeLayers[e]&&t.attributeLayers[e].attributetableconfig&&!$.isEmptyObject(t.attributeLayers[e].attributetableconfig.columns)){var m=t.attributeLayers[e].attributetableconfig.columns.column;if(0==m.length)return v;var h=b.slice(0,p),g=b.slice(p),z=0;for(var L in m){var T=m[L];if("field"==T.attributes.type)for(var F=T.attributes.name,M=T.attributes.hidden,C=0;C<g.length;C++)if("mData"in g[C]&&g[C].mData===F){if("1"==M)g.splice(C,1);else{var k=C;g.splice(z,0,g.splice(k,1)[0]),z+=1}break}}var w=h.concat(g);v.columns=w}else if("columns"in t.layers[e]&&t.layers[e].columns&&Object.keys(t.layers[e].columns).length>0){h=b.slice(0,p),g=b.slice(p),z=0;for(const a in t.layers[e].columns){const r=t.layers[e].columns[a];for(C=0;C<g.length;C++)"mData"in g[C]&&g[C].mData===r&&(k=C,g.splice(z,0,g.splice(k,1)[0]),z+=1)}w=h.concat(g),v.columns=w}return v}(e,m,s.geometryType,p,y,c,d,b,i,o),z=g.columns,L=g.firstDisplayedColIndex,T=x(m,s.geometryType,p,y,c,d,b,s.selectedFeatures),F=T.foundFeatures,M=T.dataSet,C=!1;if(0==(s.features?Object.keys(s.features).length:0)?(C=!0,c||(s.featuresFullSet=!0)):c?s.featuresFullSet||(C=!0):(s.featuresFullSet=!0,C=!0),C&&(s.features=F),s.alias=i,$.fn.dataTable.isDataTable(a))(D=$(a).dataTable()).fnClearTable(),D.fnAddData(M);else{var k=!0;h>5e4&&(k=!1);var w="<<t>ipl>";k?$("#attribute-layer-search-"+u).on("keyup",(function(e){var t=this.value;I((function(){D.fnFilter(t)}),500)})):w="<<t>ipl>",$(a).dataTable({data:M,columns:z,drawCallback(e){const t=new $.fn.dataTable.Api(e);(p||y)&&$.post(lizUrls.edition.replace("getFeature","editableFeatures"),{repository:lizUrls.params.repository,project:lizUrls.params.project,layerId:s.id},(function(e){if("success"in e&&e.success&&"status"in e&&"restricted"==e.status){let a=[];for(const t of e.features)a.push("#"+t.id.split(".")[1]);t.table().cells(":not("+a.join(",")+")",[2,3]).nodes().to$().children("button").prop("disabled",!0)}}))},initComplete:function(e,t){const a=new $.fn.dataTable.Api(e).table().node().id.split("attribute-layer-table-")[1];lizMap.events.triggerEvent("attributeLayerContentReady",{featureType:a})},order:[[L,"asc"]],language:{url:lizUrls.dataTableLanguage},deferRender:!0,createdRow:function(e,t,a){-1!=$.inArray(t.DT_RowId.toString(),s.selectedFeatures)&&($(e).addClass("selected"),t.lizSelected="a")},dom:w,pageLength:50,scrollY:"95%",scrollX:"100%"});var D=$(a).dataTable();k||$("#attribute-layer-search-"+u).hide(),$("#attribute-layer-search-"+u).next(".clear-layer-search").click((function(){$("#attribute-layer-search-"+u).val("").focus().keyup()})),$(a).on("page.dt",(function(){$(a+" tr").unbind("click"),$(a+" tr td button").unbind("click")})),$(a).on("draw.dt",(function(){return $(a+" tr").unbind("click"),$(a+" tr td button").unbind("click"),function(e,a){$(a+" tr").click((function(){$(a+" tr").removeClass("active"),$(this).addClass("active");var r=$(this).find("button.attribute-layer-feature-select").val();lizMap.events.triggerEvent("layerfeaturehighlighted",{sourceTable:a,featureType:e,fid:r});var i=t.layers[e];if(i&&"True"==i.popup){var l=i.features[r],n=a.replace("#attribute-layer-table-","").split("-");n=n[0],$("#attribute-table-panel-"+n).html(""),lizMap.getFeaturePopupContent(e,l,(function(e){$("#attribute-table-panel-"+n).html(e),lizMap.events.triggerEvent("lizmappopupdisplayed_inattributetable");$("#attribute-table-panel-"+n+" h4").append('<a class="close-attribute-feature-panel pull-right" href="#"><i class="icon-remove"></i></a>'),$("#attribute-table-panel-"+n+" h4 a.close-attribute-feature-panel").click((function(){$("#attribute-layer-main-"+n).removeClass("reduced"),$("#attribute-table-panel-"+n).removeClass("visible").html(""),$("#attribute-layer-"+n+" button.btn-detail-attributeTable").removeClass("active btn-warning")}))}))}}))}(e,a),B(e,a),"none"!=t.layers[e].geometryType&&"unknown"!=t.layers[e].geometryType&&function(e,t){$(t+" tr td button.attribute-layer-feature-focus").click((function(){var t=$(this).val(),a="zoom";return $(this).hasClass("center")&&(a="center"),lizMap.zoomToFeature(e,t,a),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")}))}(e,a),p&&function(e,a){$(a+" tr td button.attribute-layer-feature-edit").click((function(){var a=$(this).val(),r=t.layers[e].id;return lizMap.launchEdition(r,a,null),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")}))}(e,a),y&&A(e,a),p&&c&&!d&&function(e,a){$(a+" tr td button.attribute-layer-feature-unlink").click((function(){var r=$(this).val(),i=t.layers[e].id,l=$(a).parents("div.attribute-layer-main:first").attr("id").replace("attribute-layer-main-",""),n=t.layers[l].id,s=null;if(!(n in t.relations))return!1;for(var u in t.relations[n]){var o=t.relations[n][u];o.referencingLayer==i&&(s=o.referencingField)}if(!s)return!1;var c=t.layers[e].features;if(!c||Object.keys(c).length<=0)return!1;var d=lizMap.getLayerConfigById(i,t.attributeLayers,"layerId");if(!d)return!1;var b=d[1].primaryKey,p=c[r];if(void 0===p)return!1;var y=p.properties[b];/^[0-9]+$/.test(y)||(y=" '"+y+"' ");var f=OpenLayers.Util.urlAppend(lizUrls.edition,OpenLayers.Util.getParameterString(lizUrls.params));return $.post(f.replace("getFeature","unlinkChild"),{lid:i,pkey:b,pkeyval:y,fkey:s},(function(e){$("#lizmap-edition-message").remove(),lizMap.addMessage(e,"info",!0).attr("id","lizmap-edition-message"),lizMap.events.triggerEvent("lizmapeditionfeaturemodified",{layerId:i})})),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")}))}(e,a),W("#"+$("#bottom-dock div.bottom-content.active div.attribute-layer-main").attr("id")),!1}))}}return r&&0!=r.length?$(a).show():($.fn.dataTable.isDataTable(a)&&(D=$(a).dataTable()).fnClearTable(),$(a).hide(),$("#attribute-layer-"+u+" span.attribute-layer-msg").html(lizDict["attributeLayers.toolbar.msg.data.nodata"]+" "+lizDict["attributeLayers.toolbar.msg.data.extent"]).addClass("failure")),n&&n(e,a),!1}function _(e,t,a,r,i){var l=i.settings.aoColumns[i.col].mData,n=t;return(t||0===t)&&(n=lizMap.translateWfsFieldValues(e,l,t.toString(),null)),n!=t&&null!==n||(n=t),n}function x(e,t,a,r,i,l,n,s){var u=[],o={};return e.forEach((function(e){var c={},d=e.id.split(".")[1];o[d]=e,c.DT_RowId=d,c.lizSelected="z",s&&-1!=$.inArray(d,s)&&(c.lizSelected="a");var b='<button class="btn btn-mini attribute-layer-feature-select checkbox" value="'+d+'" title="'+lizDict["attributeLayers.btn.select.title"]+'"><i class="icon-ok"></i></button>';if(c.select=b,a){var p='<button class="btn btn-mini attribute-layer-feature-edit" value="'+d+'" title="'+lizDict["attributeLayers.btn.edit.title"]+'"><i class="icon-pencil"></i></button>';c.edit=p}if(r){var y="icon-trash",f=lizDict["attributeLayers.btn.delete.title"];i&&l&&(y="icon-minus",f=lizDict["attributeLayers.btn.remove.link.title"]);var v='<button class="btn btn-mini attribute-layer-feature-delete" value="'+d+'" title="'+f+'"><i class="'+y+'"></i></button>';c.delete=v}if(a&&i&&!l){var m='<button class="btn btn-mini attribute-layer-feature-unlink" value="'+d+'" title="'+lizDict["attributeLayers.btn.remove.link.title"]+'"><i class="icon-minus"></i></button>';c.unlink=m}if("none"!=t&&"unknown"!=t){var h='<button class="btn btn-mini attribute-layer-feature-focus zoom" value="'+d+'" title="'+lizDict["attributeLayers.btn.zoom.title"]+'"><i class="icon-zoom-in"></i></button>';c.zoom=h;var g='<button class="btn btn-mini attribute-layer-feature-focus center" value="'+d+'" title="'+lizDict["attributeLayers.btn.center.title"]+'"><i class="icon-screenshot"></i></button>';c.center=g}for(var z in e.properties)if(!($.inArray(z,n)>-1)){var L=e.properties[z];c[z]=L}u.push(c)})),{dataSet:u,foundFeatures:o}}function B(e,t,a){$(t+" tr td button.attribute-layer-feature-select").click((function(){$(this).parents("tr:first").click();var a=$(this).val();return lizMap.events.triggerEvent("layerfeatureselected",{featureType:e,fid:a,updateDrawing:!0}),lizMap.events.triggerEvent("layerfeaturehighlighted",{sourceTable:t,featureType:e,fid:a}),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")}))}function A(e,a){$(a+" tr td button.attribute-layer-feature-delete").click((function(){var a=$(this).val();return function(e,a){var r=lizMap.getLayerConfigById(e,t.editionLayers,"layerId"),i="";if(r&&(i+=t.layers[r[0]].title),t.layers[r[0]]&&t.layers[r[0]].features&&t.layers[r[0]].features[a]){var l=t.layers[r[0]].features[a].properties;for(var n in l)i+='  \n"'+n+'": '+l[n]}lizMap.deleteEditionFeature(e,a,i,(function(e,a){var i=r[0],l=$('#jforms_view_attribute_layers_option_cascade_label input[name="cascade"]').prop("checked"),n=!1;("filteredFeatures"in t.layers[i]&&t.layers[i].filteredFeatures.length>0||"request_params"in t.layers[i]&&t.layers[i].request_params.filter||"request_params"in t.layers[i]&&t.layers[i].request_params.exp_filter)&&(n=!0),n&&lizMap.lizmapLayerFilterActive&&l&&K(lizMap.lizmapLayerFilterActive,l)}))}(t.layers[e].id,a),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")}))}function S(e,a,r){O(e,a,null,"extent",(function(e,a,i,l){E(e,r,i,l,(function(){var a=!1,i=!1,l=!1;if("editionLayers"in t&&e in t.editionLayers){var n=t.editionLayers[e];"True"==n.capabilities.createFeature&&(a=!0),"True"!=n.capabilities.modifyAttribute&&"True"!=n.capabilities.modifyGeometry||(i=!0),"True"==n.capabilities.deleteFeature&&(l=!0)}$(r).on("page.dt",(function(){$(r+" tr").unbind("click"),$(r+" tr td button").unbind("click")})),$(r).on("draw.dt",(function(){var n;$(r+" tr").unbind("click"),$(r+" tr td button").unbind("click"),B(e,r),l&&A(e,r),i&&(n=e,$(r+" tr td button.attribute-layer-feature-edit").click((function(){var e=$(this).val(),a=t.layers[n].id,r=$('#edition-form-container form input[name="liz_featureId"]').val(),i=$('#edition-form-container form input[name="liz_layerId"]').val(),l=lizMap.getLayerConfigById(i)[0];if(n in t.attributeLayers){var s=t.attributeLayers[n];null!=M(i,s.layerId)&&lizMap.getLayerFeature(l,r,(function(t){lizMap.launchEdition(a,e,{layerId:i,feature:t})}))}return!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")}))),$(r+" tr td button.attribute-layer-feature-focus").remove(),$(r+" tr td button.attribute-layer-feature-unlink").remove();var s=$(r).DataTable();for(c=2;c<7;c++){var u=s.column(c).dataSrc();if("unlink"!=u&&"zoom"!=u&&"center"!=u||s.column(c).visible(!1),"edit"==u&&a){var o=$(s.column(c).header());0==o.find("button.attribute-layer-feature-create").length&&(o.append('<button class="btn btn-mini attribute-layer-feature-create" value="-1" title="'+lizDict["attributeLayers.toolbar.btn.data.createFeature.title"]+'"><i class="icon-plus"></i></button>').css("padding","10px 5px"),o.children("button.attribute-layer-feature-create").click((function(){var e=$(this).parents("div.tab-pane.attribute-layer-child-content"),a=e.find("input.attribute-table-hidden-parent-feature-id").val(),r=e.find("input.attribute-table-hidden-parent-layer").val(),i=e.find("input.attribute-table-hidden-layer").val();return lizMap.getLayerFeature(r,a,(function(e){var a=t.layers[lizMap.getLayerNameByCleanName(r)].id,l=t.layers[lizMap.getLayerNameByCleanName(i)].id;lizMap.launchEdition(l,null,{layerId:a,feature:e})})),!1})))}}if(0==$(r).parents(".edition-children-content").children("ul.nav-tabs").children("li.active").length){var d=$(r).parents(".tab-pane.attribute-layer-child-content").attr("id");$(r).parents(".edition-children-content").find('ul.nav-tabs > li > a[href="#'+d+'"]').click()}return!1}))}))}))}function O(e,a,r,i,l){if(a=void 0!==a?a:null,r=void 0!==r?r:null,i=void 0!==i?i:"extent",l=void 0!==l?l:null,!(e in t.layers)){var n=lizMap.getNameByCleanName(e);if(!n||!(n in t.layers))return console.log('getAttributeFeatureData: "'+e+'" and "'+n+'" not found in config'),!1;e=n}t.layers[e],e in t.attributeLayers&&t.attributeLayers[e];var s=!1;return"limitDataToBbox"in t.options&&"True"==t.options.limitDataToBbox&&(s=!0),lizMap.getFeatureData(e,a,r,i,s,null,null,l),!0}function P(e,a){a=void 0===a||a,t.layers[e].selectedFeatures=[],lizMap.events.triggerEvent("layerSelectionChanged",{featureType:e,featureIds:t.layers[e].selectedFeatures,updateDrawing:a})}function q(e,a,i,l){if(0!=e.length){l=void 0===l||l;var n=e.shift(),s=lizMap.cleanName(n),u=a[n];u?function(e,a,i,l,n,s){if(a){n.push(e);lizMap.getFeatureData(e,a,null,"extent",!1,null,null,(function(u,o,c,d){var b=t.layers[e];b.features={};var p={},y=c,f=b.id,v=t.attributeLayers[e].primaryKey,m=[],h={},g=lizMap.getLayerConfigById(f,t.attributeLayers,"layerId"),z=null;if(g&&(z=g[1]),"relations"in t&&f in t.relations&&s){var L=t.relations[f];for(var T in L){var F=U(L[T],n);F&&(h[F[0]]=F[1])}}var M=R(f,z,n),C=[];y.forEach((function(e){var t=e.id.split(".")[1];p[t]=e;var r=e.properties[v];if("types"in b&&v in b.types&&"string"==b.types[v]?r=" '"+r+"' ":/^[0-9]+$/.test(r)||(r=" '"+r+"' "),m.push(r),C.push(t),s&&a)for(var i in h){var l=h[i];h[i].parentValues.push("'"+e.properties[l.parentField]+"'")}if(M&&a){var n=M.otherParentRelation.referencingField;M.otherParentValues.push("'"+e.properties[n]+"'")}})),b.features=p,b.alias=d;var k=r[lizMap.cleanName(e)],w=null,D=lizMap.map.getLayersByName(lizMap.cleanName(e))[0];if(D&&D.params&&(k=D.params.LAYERS),0==m.length&&m.push("-99999"),a&&(w=k+':"'+v+'" IN ( '+m.join(" , ")+" ) ",!a.startsWith("$id"))){var I=a;a.startsWith(k)||(I=k+":"+a),w=I}if(b.request_params.filter=w,b.request_params.exp_filter=a,D&&D.params)if(a){var E=OpenLayers.Util.urlAppend(lizUrls.wms,OpenLayers.Util.getParameterString(lizUrls.params)),_={service:"WMS",request:"GETFILTERTOKEN",typename:e,filter:w};$.post(E,_,(function(e){D.params.FILTERTOKEN=e.token,delete D.params.FILTER,b.request_params.filtertoken=e.token,b.geometryType&&"none"!=b.geometryType&&"unknown"!=b.geometryType&&D.redraw(!0)}))}else delete D.params.FILTER,delete D.params.FILTERTOKEN,b.request_params.filtertoken=null;D&&"none"!=b.geometryType&&"unknown"!=b.geometryType&&D.redraw(!0);var x="#attribute-layer-table-"+lizMap.cleanName(e);if($(x).length&&N(e,x,y),lizMap.events.triggerEvent("layerFilterParamChanged",{featureType:e,filter:w,updateDrawing:!0}),s)for(var B in h){var A=B,S=h[B],O=null,P=A,j=lizMap.map.getLayersByName(lizMap.cleanName(A))[0];j&&j.params&&(P=j.params.LAYERS),a&&S.parentValues.length>0&&"removeChildrenFilter"!=s?O=P+':"'+S.fieldToFilter+'" IN ( '+S.parentValues.join()+" )":a&&"removeChildrenFilter"!=s&&(O=P+':"'+S.fieldToFilter+'" IN ( -99999 )'),t.layers[A].request_params.filter=O,l[B]=O,i.push(B)}if(M){O=null;var K=M.otherParentTypeName,V=lizMap.map.getLayersByName(lizMap.cleanName(K))[0];V&&V.params&&(K=V.params.LAYERS),a&&(M.otherParentValues.length>0?(O=K+':"',O+=M.otherParentRelation.referencedField,O+='" IN ( '+M.otherParentValues.join()+" )",M.otherParentRelation.referencedField,M.otherParentValues):(O=K+':"'+M.otherParentRelation.referencedField+"\" IN ( '-999999' )",M.otherParentRelation.referencedField)),t.layers[M.otherParentTypeName].request_params.filter=O,l[M.otherParentTypeName]=O,i.push(M.otherParentTypeName)}i.length>0&&q(i,l,n,s)}))}else j(e,i,l,n,s)}(n,u,e,a,i,l):j(n,e,a,i,l);var o="inherit";u&&(o="rgba(255, 171, 0, 0.4)"),$("#switcher .treeTable tr#group-"+s).css("background-color",o),$("#switcher .treeTable tr#layer-"+s).css("background-color",o),$("#layerActionUnfilter").toggle(null!==lizMap.lizmapLayerFilterActive).css("background-color","rgba(255, 171, 0, 0.4)")}}function U(e,a){var r=lizMap.getLayerConfigById(e.referencingLayer,t.attributeLayers,"layerId");if(!r)return null;var i=r[0],l=r[1];if(-1!=$.inArray(i,a))return null;var n=!1;return"pivot"in l&&"True"==l.pivot&&l.layerId in t.relations.pivot&&(n=!0),[i,{filter:null,fieldToFilter:e.referencingField,parentField:e.referencedField,parentValues:[],pivot:n,otherParentTypeName:null,otherParentRelation:null,otherParentValues:[]}]}function R(e,a,r){var i=!1,l=null;if("pivot"in a&&"True"==a.pivot&&a.layerId in t.relations.pivot&&(i=!0),!i)return l;var n=null,s=null,u=null;for(var o in t.relations)if("pivot"!=o&&o!=e&&(!(b=lizMap.getLayerConfigById(o,t.attributeLayers,"layerId"))||-1==$.inArray(b[0],r))){var c=t.relations[o];for(var d in c){var b;c[d].referencingLayer==a.layerId&&(n=o,s=c[d],u=(b=lizMap.getLayerConfigById(o,t.attributeLayers,"layerId"))[0])}}return n&&s&&((l={}).otherParentTypeName=u,l.otherParentRelation=s,l.otherParentValues=[]),l}function j(e,a,r,i,l){i.push(e);var n=t.layers[e];n.features={};var s=n.id,u={},o=lizMap.getLayerConfigById(s,t.attributeLayers,"layerId"),c=null;if(o&&(c=o[1]),"relations"in t&&s in t.relations&&l){var d=t.relations[s];for(var b in d){var p=U(d[b],i);p&&(u[p[0]]=p[1])}}var y=R(s,c,c),f=lizMap.map.getLayersByName(lizMap.cleanName(e))[0];n.request_params.filter=null,n.request_params.exp_filter=null,n.request_params.filtertoken=null,f&&(delete f.params.FILTER,delete f.params.FILTERTOKEN),f&&"none"!=n.geometryType&&"unknown"!=n.geometryType&&f.redraw(!0);var v="#attribute-layer-table-"+lizMap.cleanName(e);if($(v).length&&function(e,a,r,i){var l=!1;"limitDataToBbox"in t.options&&"True"==t.options.limitDataToBbox&&(l=!0),lizMap.getFeatureData(e,null,null,"extent",l,null,null,(function(t,a,i,l){N(e,r,i),document.body.style.cursor="default"}))}(e,0,v),lizMap.events.triggerEvent("layerFilterParamChanged",{featureType:e,filter:null,updateDrawing:!0}),l)for(var m in u)r[m]=null,a.push(m);y&&(t.layers[y.otherParentTypeName].request_params.filter=null,r[y.otherParentTypeName]=null,a.push(y.otherParentTypeName)),a.length>0&&q(a,r,i,l)}function K(e,a){a=void 0===a||a;var i=lizMap.map.getLayersByName(lizMap.cleanName(e))[0],l=null;t.layers[e].filteredFeatures&&t.layers[e].filteredFeatures.length>0&&(l="$id IN ( "+t.layers[e].filteredFeatures.join()+" ) ");var n=r[e];if(t.layers[e]&&t.layers[e].selectedFeatures&&t.layers[e].selectedFeatures.length){t.layers[e].request_params.selection=n+":"+t.layers[e].selectedFeatures.join();var s=OpenLayers.Util.urlAppend(lizUrls.wms,OpenLayers.Util.getParameterString(lizUrls.params)),u={service:"WMS",request:"GETSELECTIONTOKEN",typename:e,ids:t.layers[e].selectedFeatures.join()};$.post(s,u,(function(a){t.layers[e].request_params.selectiontoken=a.token,i&&(i.params.SELECTIONTOKEN=a.token)}))}else i&&delete i.params.SELECTIONTOKEN,t.layers[e].request_params.selection=null,t.layers[e].request_params.selectiontoken=null;var o=[e],c={};c[e]=l,q(o,c,[],a)}function V(e){var a=t.layers[e].selectedFeatures,r=t.layers[e].filteredFeatures,i=lizMap.cleanName(e);a&&a.length>0?($('button.btn-unselect-attributeTable[value="'+i+'"]').removeClass("hidden"),$('button.btn-moveselectedtotop-attributeTable[value="'+i+'"]').removeClass("hidden")):($('button.btn-unselect-attributeTable[value="'+i+'"]').addClass("hidden"),$('button.btn-moveselectedtotop-attributeTable[value="'+i+'"]').addClass("hidden")),$('button.btn-filter-attributeTable[value="'+i+'"]').addClass("hidden").removeClass("active btn-warning"),(!lizMap.lizmapLayerFilterActive&&a&&a.length>0||lizMap.lizmapLayerFilterActive==e)&&($('button.btn-filter-attributeTable[value="'+i+'"]').removeClass("hidden"),r&&r.length>0&&$('button.btn-filter-attributeTable[value="'+i+'"]').addClass("active btn-warning"))}function G(e){$(".attribute-table-table[id]").each((function(){var a=$(this).attr("id");if(!a)return!0;var i=$(this).parents("div.dataTables_wrapper:first").prev("input.attribute-table-hidden-layer").val();if(i&&$.fn.dataTable.isDataTable($(this))&&lizMap.cleanName(e)==i){for(var l="#"+a,n=l,s=i,u=e,o=$(l).attr("class").split(" "),c=0;c<o.length;c++)if(o[c].match("child-of-")){n="#attribute-layer-table-"+(s=o[c].substring("child-of-".length)),u=r[s];break}if(n!=l)if(l.match("edition-table-")){var d=$('#edition-form-container form input[name="liz_featureId"]').val(),b=$('#edition-form-container form input[name="liz_layerId"]').val(),p=lizMap.getLayerConfigById(b);if(e in t.attributeLayers&&u==p[0]){var y=M(b,t.attributeLayers[e].layerId);null!=y&&lizMap.getLayerFeature(u,d,(function(t){var a=t.properties;filter='"'+y.referencingField+"\" = '"+a[y.referencedField]+"'",S(e,filter,l)}))}}else{var f=t.layers[u].highlightedFeature;f&&$(n+" tr#"+f).click()}else O(e,null,null,"extent",(function(e,t,a){E(e,l,a)}))}}))}function W(e){var t=$(e).find("table.dataTable"),a=$(e+" div.attribute-layer-content").height()?$(e+" div.attribute-layer-content").height():0;a-=$(e+" thead").height()?$(e+" thead").height():0,a-=$(e+" div.dataTables_paginate").height()?$(e+" div.dataTables_paginate").height():0,a-=$(e+" div.dataTables_filter").height()?$(e+" div.dataTables_filter").height():0,a-=20,t.parent("div.dataTables_scrollBody").height(a),t.DataTable().tables().columns.adjust()}lizMap.refreshDatatableSize=function(e){return W(e)},lizMap.events.on({layerfeaturehighlighted:function(e){t.layers[e.featureType].highlightedFeature=e.fid,function(e,a,r){var i=t.layers[a].features[r];if(!i)return!1;var l=i.properties,n=t.layers[a];if(!n)return!1;var s=n.id;if("relations"in t&&s in t.relations){var u=t.relations[s];for(var o in u){var c=u[o],d=lizMap.getLayerConfigById(c.referencingLayer,t.layers,"id");if(d&&d[0]in t.attributeLayers){var b=d[0],p=d[1],y="";c.referencingLayer==p.id&&(y='"'+c.referencingField+"\" = '"+l[c.referencedField]+"'");var f=e.replace(" table:first","")+"-"+lizMap.cleanName(b);if(b in t.attributeLayers&&"hideAsChild"in t.attributeLayers[b]&&"True"==t.attributeLayers[b].hideAsChild)continue;w(b,y,f)}}}}(e.sourceTable,e.featureType,e.fid)},layerfeatureselected:function(e){!function(e,a,r){if(r=void 0!==r?r:null,t.layers[e].selectedFeatures||(t.layers[e].selectedFeatures=[]),-1==$.inArray(a,t.layers[e].selectedFeatures))t.layers[e].selectedFeatures.push(a);else{var i=$.inArray(a,t.layers[e].selectedFeatures);t.layers[e].selectedFeatures.splice(i,1)}lizMap.events.triggerEvent("layerSelectionChanged",{featureType:e,featureIds:t.layers[e].selectedFeatures,updateDrawing:r})}(e.featureType,e.fid,e.updateDrawing)},layerfeatureunselectall:function(e){P(e.featureType,e.updateDrawing)},layerfeatureselectsearched:function(e){!function(e,a){a=void 0===a||a,t.layers[e].selectedFeatures||(t.layers[e].selectedFeatures=[]);var r=!1;$(".attribute-table-table[id]").each((function(){$(this).attr("id");var a=$(this).parents("div.dataTables_wrapper:first").prev("input.attribute-table-hidden-layer").val();if(a&&$.fn.dataTable.isDataTable($(this))&&lizMap.cleanName(e)==a){for(var i=[],l=$(this).DataTable().rows({filter:"applied"}).ids(),n=0;n<l.length;n++)i.push(l[n]);t.layers[e].selectedFeatures=i,r=!0}})),r&&lizMap.events.triggerEvent("layerSelectionChanged",{featureType:e,featureIds:t.layers[e].selectedFeatures,updateDrawing:a})}(e.featureType,e.updateDrawing)},layerfeaturefilterselected:function(e){!function(e){if(!t.attributeLayers[e])return!1;t.layers[e].selectedFeatures||(t.layers[e].selectedFeatures=[]),t.layers[e].filteredFeatures=t.layers[e].selectedFeatures.slice(),P(e,!1),lizMap.lizmapLayerFilterActive=e,lizMap.events.triggerEvent("layerFilteredFeaturesChanged",{featureType:e,featureIds:t.layers[e].filteredFeatures,updateDrawing:!0})}(e.featureType)},layerfeatureremovefilter:function(e){!function(e){t.layers[e].filteredFeatures=[],lizMap.lizmapLayerFilterActive=null;var a=lizMap.map.getLayersByName(lizMap.cleanName(e))[0];a&&delete a.params.FILTER,t.layers[e].request_params.filter=null,t.layers[e].request_params.exp_filter=null,lizMap.events.triggerEvent("layerFilteredFeaturesChanged",{featureType:e,featureIds:t.layers[e].filteredFeatures,updateDrawing:!0})}(e.featureType)},layerSelectionChanged:function(e){var a;V(e.featureType),a=e.featureType,e.featureIds,$(".attribute-table-table[id]").each((function(){$(this).attr("id");var e=$(this).parents("div.dataTables_wrapper:first").prev("input.attribute-table-hidden-layer").val();if(e&&$.fn.dataTable.isDataTable($(this))&&lizMap.cleanName(a)==e){if(!r){t.layers[a].selectedFeatures||(t.layers[a].selectedFeatures=[]);var r=t.layers[a].selectedFeatures}var i=$(this).DataTable(),l=$(this).dataTable();i.rows($(this).find("tr.selected")).every((function(){l.fnUpdate("z",this,0,!1,!1)})).nodes().to$().removeClass("selected"),r.length>0&&((i=$(this).DataTable()).data().each((function(e){-1!=$.inArray(e.DT_RowId.toString(),r)&&(e.lizSelected="a")})),i.rows((function(e,t,a){return"a"==t.lizSelected})).nodes().to$().addClass("selected"))}})),e.updateDrawing&&function(e){var a=lizMap.cleanName(e),r=lizMap.map.getLayersByName(a)[0];if(r){var i=t.layers[e];if(i)if(i.selectedFeatures&&i.selectedFeatures.length){"request_params"in i||(i.request_params={}),i.request_params.selection=e+":"+i.selectedFeatures.join();var l=OpenLayers.Util.urlAppend(lizUrls.wms,OpenLayers.Util.getParameterString(lizUrls.params)),n={service:"WMS",request:"GETSELECTIONTOKEN",typename:e,ids:i.selectedFeatures.join()};$.post(l,n,(function(e){i.request_params.selectiontoken=e.token,r&&(r.params.SELECTIONTOKEN=e.token),i.geometryType&&"none"!=i.geometryType&&"unknown"!=i.geometryType&&r.redraw(!0)}))}else r&&delete r.params.SELECTIONTOKEN,"request_params"in i||(i.request_params={}),i.request_params.selection=null,i.request_params.selectiontoken=null,i.geometryType&&"none"!=i.geometryType&&"unknown"!=i.geometryType&&r.redraw(!0)}}(e.featureType)},layerFilteredFeaturesChanged:function(e){V(e.featureType);var t=$('#jforms_view_attribute_layers_option_cascade_label input[name="cascade"]').prop("checked");"cascade"in e&&(t=e.cascade),K(e.featureType,t)},lizmappopupdisplayed:function(e){var a=!1,r=e.popup,i="div.lizmapPopupContent input.lizmap-popup-layer-feature-id";e.containerId&&(i="#"+e.containerId+" "+i),$(i).each((function(){var e=$(this),i=e.val(),l="",s=i.split(".").pop(),u=i.replace("."+s,""),o=lizMap.getLayerConfigById(u,t.attributeLayers,"layerId"),c=lizMap.getLayerConfigById(u);if(o&&c&&0==e.next("span.popupButtonBar").find("button.popup-layer-feature-select").length){var d=c[1],b="";if(-1!=$.inArray(s,d.selectedFeatures)&&(b="btn-warning"),l+='<button class="btn btn-mini popup-layer-feature-select '+b+'" value="',l+=o[0]+"."+s,l+='" title="'+lizDict["attributeLayers.btn.select.title"]+'"><i class="icon-ok"></i>&nbsp;</button>',!(n||lizMap.lizmapLayerFilterActive!=c[0]&&lizMap.lizmapLayerFilterActive)){var p="";-1!=$.inArray(s,d.filteredFeatures)&&(p="btn-warning"),l+='<button class="btn btn-mini popup-layer-feature-filter '+p+'" value="',l+=o[0]+"."+s,l+='" title="'+lizDict["attributeLayers.toolbar.btn.data.filter.title"]+'"><i class="icon-filter"></i>&nbsp;</button>'}}var y=e.next("span.popupButtonBar"),f=y.find("button.popup-layer-feature-zoom");0==f.length&&(f=y.find("button.popup-layer-feature-bbox-zoom")),o&&c&&0==f.length&&(d=c[1],l+='<button class="btn btn-mini popup-layer-feature-zoom" value="',l+=o[0]+"."+s,l+='" title="'+lizDict["attributeLayers.btn.zoom.title"]+'"><i class="icon-zoom-in"></i>&nbsp;</button>'),""!=l&&(0!=y.length?0==f.length?y.append(l):f.before(l):(l='<span class="popupButtonBar">'+l+"</span></br>",e.after(l)),e.find("button.btn").tooltip({placement:"bottom"}),a=!0,r&&r.verifySize())})),a&&($("div.lizmapPopupContent button").tooltip(),$("div.lizmapPopupContent button.popup-layer-feature-select").unbind("click").click((function(){var e=$(this).val().split(".").pop(),a=$(this).val().replace("."+e,""),r=t.layers[a],i=!1;return r.selectedFeatures&&-1!=$.inArray(e,r.selectedFeatures)&&(i=!0,$(this).removeClass("btn-warning")),lizMap.events.triggerEvent("layerfeatureselected",{featureType:a,fid:e,updateDrawing:!0}),i||$(this).addClass("btn-warning"),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),$("div.lizmapPopupContent button.popup-layer-feature-zoom").unbind("click").click((function(){var e=$(this).val().split(".").pop(),t=$(this).val().replace("."+e,"");return 0!=lizMap.map.popups.length&&lizMap.map.removePopup(lizMap.map.popups[0]),lizMap.zoomToFeature(t,e,"zoom"),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),n||$("div.lizmapPopupContent button.popup-layer-feature-filter").unbind("click").click((function(){var e=$(this).val().split(".").pop(),a=$(this).val().replace("."+e,""),r=t.layers[a],i=!1;return r.filteredFeatures&&-1!=$.inArray(e,r.filteredFeatures)&&(i=!0),lizMap.events.triggerEvent("layerfeatureunselectall",{featureType:a,updateDrawing:!1}),i?(lizMap.events.triggerEvent("layerfeatureremovefilter",{featureType:a}),$(this).removeClass("btn-warning"),lizMap.lizmapLayerFilterActive=null):(lizMap.events.triggerEvent("layerfeatureselected",{featureType:a,fid:e,updateDrawing:!1}),lizMap.events.triggerEvent("layerfeaturefilterselected",{featureType:a}),lizMap.lizmapLayerFilterActive=a,$(this).addClass("btn-warning")),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})))},lizmapeditionfeaturecreated:function(e){var a=lizMap.getLayerConfigById(e.layerId,t.attributeLayers,"layerId");if(a){var r=a[0];if(!(r in t.attributeLayers))return!1;G(r)}},lizmapeditionfeaturemodified:function(e){var a=lizMap.getLayerConfigById(e.layerId);if(a){var r=a[0];if(!(r in t.attributeLayers))return!1;G(r)}},lizmapeditionfeaturedeleted:function(e){var a=lizMap.getLayerConfigById(e.layerId);if(a){var r=a[0];if(!(r in t.attributeLayers))return!1;G(r)}},lizmaplocatefeaturechanged:function(e){if(!(e.featureType in t.attributeLayers)||n)return!1;var a=t.locateByLayer[e.featureType],r=!1;if("filterOnLocate"in a&&"True"==a.filterOnLocate&&(r=!0),!r)return!1;lizMap.events.triggerEvent("layerfeatureselected",{featureType:e.featureType,fid:e.featureId,updateDrawing:!1}),lizMap.events.triggerEvent("layerfeaturefilterselected",{featureType:e.featureType})},lizmaplocatefeaturecanceled:function(e){lizMap.events.triggerEvent("layerfeatureremovefilter",{featureType:e.featureType})},lizmapeditionformdisplayed:function(e){$("#edition-children-container").hide().html("");var a=e.featureId;if(a&&""!=a){var i=e.layerId,l=lizMap.getLayerConfigById(i);if(l&&"relations"in lizMap.config&&i in lizMap.config.relations){var n=lizMap.config.relations[i],s=l[0];if(n.length>0){var u=k(s),o="";if(u){for(var c in u.childCreateButton&&(o+='<div class="attribute-layer-action-bar">',o+=u.childCreateButton,o+="</div>"),o+='<div class="tabbable edition-children-content">',o+='    <ul class="nav nav-tabs">',u["tab-li"])o+=u["tab-li"][c];for(var c in o+="    </ul>",o+='    <div class="tab-content">',u["tab-content"])o+=u["tab-content"][c];o+="    </div>",o+="</div>"}$("#edition-children-container").show().append(o),$("#edition-children-container div.tabbable div.tab-pane input.attribute-table-hidden-parent-layer").after('<input class="attribute-table-hidden-parent-feature-id" value="'+a+'" type="hidden">'),$("#edition-children-container div.tabbable ul.nav-tabs li").each((function(){$(this).attr("id",$(this).attr("id").replace(/nav-tab-attribute-child-tab-/g,"nav-tab-edition-child-tab-"))})),$("#edition-children-container div.tabbable ul.nav-tabs li a").each((function(){$(this).attr("href",$(this).attr("href").replace(/attribute-child-tab-/g,"edition-child-tab-"))})),$("#edition-children-container div.tabbable div.tab-content div.tab-pane").each((function(){$(this).attr("id",$(this).attr("id").replace(/attribute-child-tab-/g,"edition-child-tab-"))})),$("#edition-children-container div.tabbable div.tab-content table").each((function(){$(this).attr("id",$(this).attr("id").replace(/attribute-layer-/g,"edition-"))})),$("#edition-children-container button.btn-createFeature-attributeTable").click((function(){var e=i,l=r[$(this).val()];return lizMap.getLayerFeature(s,a,(function(a){var r=t.layers[l].id;lizMap.launchEdition(r,null,{layerId:e,feature:a})})),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),$("#edition-children-container a.btn-createFeature-attributeTable").click((function(){var e=i,l=$(this).attr("href").replace("#",""),n=r[l];return lizMap.getLayerFeature(s,a,(function(a){var r=t.layers[n].id;lizMap.launchEdition(r,null,{layerId:e,feature:a}),$(this).blur()})),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})),lizMap.getLayerFeature(s,a,(function(e){for(var a=e.properties,r=0,i=n.length;r<i;r++){var l=n[r],u=l.referencingLayer,o=lizMap.getLayerConfigById(u);if(o){var c=o[0];o[1],filter='"'+l.referencingField+"\" = '"+a[l.referencedField]+"'";var d="#edition-table-"+lizMap.cleanName(s)+"-"+lizMap.cleanName(c);c in t.attributeLayers&&S(c,filter,d)}}}))}}}},bottomdocksizechanged:function(e){W("#"+$("#bottom-dock div.bottom-content.active div.attribute-layer-main").attr("id"))},dockopened:function(e){$("#mapmenu li.attributeLayers").hasClass("active")&&W("#"+$("#bottom-dock div.bottom-content.active div.attribute-layer-main").attr("id"))},dockclosed:function(e){$("#mapmenu li.attributeLayers").hasClass("active")&&W("#"+$("#bottom-dock div.bottom-content.active div.attribute-layer-main").attr("id"))},rightdockopened:function(e){$("#mapmenu li.attributeLayers").hasClass("active")&&W("#"+$("#bottom-dock div.bottom-content.active div.attribute-layer-main").attr("id"))},rightdockclosed:function(e){$("#mapmenu li.attributeLayers").hasClass("active")&&W("#"+$("#bottom-dock div.bottom-content.active div.attribute-layer-main").attr("id"))}}),lizMap.getAttributeFeatureData=O}});
//# sourceMappingURL=attributeTable.js.map