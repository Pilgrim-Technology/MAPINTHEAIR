(()=>{function e(){this.message=""}!function(){function e(e,t,i){this.layerId=e,this.config=null,this.feature=t,this.relation=i,this.parent=null,this.backToParent=!1,this.newfeatures=[]}function t(){this.spatial=!1,this.drawControl=null,this.submitActor="submit",this.ol=null,this.currentFeature=null,this.splitOl=null,this.olStyleCustomRules=[],this.splitOlStyleCustomRules=[]}e.prototype={setParentToEditAfterSave:function(e){this.backToParent=!!e,this.parent=e},get geometryType(){return this.config?this.config.geometryType:""}},t.prototype={get config(){return this.currentFeature.config},get geometryType(){return this.currentFeature&&this.currentFeature.config?this.currentFeature.config.geometryType:""},get newfeatures(){return this.currentFeature.newfeatures},get id(){return this.currentFeature.layerId},get parent(){return this.currentFeature.parent},get projCode(){return this.ol.projection.projCode},deactivateControl:function(){this.drawControl&&this.drawControl.active&&this.drawControl.deactivate()},clearLayers:function(){this.ol&&this.ol.destroyFeatures(),this.splitOl&&this.splitOl.destroyFeatures()},clear:function(){this.currentFeature=null,this.spatial=!1,this.drawControl=null,this.submitActor="submit",this.clearLayers()},createLayers:function(){var e,t;0==n.getLayersByName("editSplitLayer").length&&((e=new OpenLayers.Style).addRules([new OpenLayers.Rule({symbolizer:{Point:{pointRadius:6},Line:{strokeWidth:4,fillColor:"#1353ac",strokeColor:"#d6eeff"},Polygon:{strokeWidth:2}}})]),this.splitOlStyleCustomRules.length&&e.addRules(this.splitOlStyleCustomRules),t=new OpenLayers.StyleMap({default:e}),this.splitOl=new OpenLayers.Layer.Vector("editSplitLayer",{styleMap:t}),n.addLayer(this.splitOl)),0==n.getLayersByName("editLayer").length&&((e=new OpenLayers.Style).addRules([new OpenLayers.Rule({symbolizer:{Point:{pointRadius:6},Line:{strokeWidth:4},Polygon:{strokeWidth:2}}})]),this.olStyleCustomRules.length&&e.addRules(this.olStyleCustomRules),t=new OpenLayers.StyleMap({default:e}),this.ol=new OpenLayers.Layer.Vector("editLayer",{styleMap:t}),n.addLayer(this.ol))},getFeature:function(){return this.spatial&&this.ol&&0!=this.ol.features.length?this.ol.features[0]:null},removeEditedFeature:function(e){this.ol.removeFeatures([e])},moveEditedFeatureToSplitLayer:function(e,t){this.ol.removeFeatures([e]),this.splitOl.addFeatures([e]),this.currentFeature.newfeatures.push([e,t])},setDrawControl:function(e){this.drawControl=e,this.spatial=!0},replaceFeature:function(e){this.clearLayers(),this.ol.addFeatures([e])},canEditParentFeature:function(){return null!=this.currentFeature.parent&&this.currentFeature.backToParent},restoreSplitFeatures:function(){var e=this.splitOl;e.destroyFeatures();var t=this.currentFeature.newfeatures.map((function(e){return e[0]}));t.length&&e.addFeatures(t)}};var i=null,n=null,o=null,r=null,a=new t,l=null,d=null;function s(){var e=$("#lizmap-edition-message");0!=e.length&&e.remove(),d=null}function p(e,t,i){d&&(window.clearTimeout(d),d=null);var n=$("#lizmap-edition-message");0!=n.length&&n.remove(),lizMap.addMessage(e,t,i).attr("id","lizmap-edition-message"),d=window.setTimeout(s,5e3)}function c(e){var t=e.features,i=a.geometryType,n=null;"line"==i?n=t[0].geometry.getLength()<t[1].geometry.getLength()?t[0]:t[1]:"polygon"==i&&(n=t[0].geometry.getArea()<t[1].geometry.getArea()?t[0]:t[1]),n&&a.removeEditedFeature(n);var o=a.getFeature();return o&&T(o),$("#edition-geomtool-nodetool").click(),!1}function u(e){var t=$("#edition-form-container form");return"ok"!==E(t)?(p(lizDict["edition.splitfeat.form.error"],"error",!0),!1):!!t.attr("data-new-feature-action")||(p(lizDict["edition.splitfeat.tech.error"],"error",!0),!1)}function f(e){var t=e.features,i=a.geometryType,n=null;if("line"==i?n=t[0].geometry.getLength()<t[1].geometry.getLength()?t[0]:t[1]:"polygon"==i&&(n=t[0].geometry.getArea()<t[1].geometry.getArea()?t[0]:t[1]),n){var o=$("#edition-form-container form"),r=o.find('input[name="liz_geometryColumn"]').val(),l="",d=new FormData(o.get(0));if("set"in d)d.set("liz_featureId",""),d.set("__JFORMS_TOKEN__",""),r&&(l=I(n),d.set(r,l));else{var s=o.find('input[name="liz_featureId"]'),p=o.find('input[name="'+r+'"]'),c=o.find('input[name="__JFORMS_TOKEN__"]'),u=s.val(),f=p.val(),m=c.val();s.val(""),c.val(""),r&&(l=I(n),p.val(l)),d=new FormData(o.get(0)),s.val(u),p.val(f),c.val(m)}a.moveEditedFeatureToSplitLayer(n,d)}var y=a.getFeature();return y&&T(y),$("#edition-geomtool-nodetool").click(),!1}function m(){$("#edition-point-coord-crs-layer").html(lizDict["edition.point.coord.crs.layer"]).val("").hide(),$("#edition-point-coord-crs-map").html(lizDict["edition.point.coord.crs.map"]).val("").hide(),$("#edition-point-coord-x").val(""),$("#edition-point-coord-y").val(""),$("#edition-point-coord-geolocation").is(":checked")&&$("#edition-point-coord-geolocation").click(),$("#edition-point-coord-add").hide(),$("#edition-segment-length").parents(".control-group").addClass("hidden"),$("#edition-segment-angle").parents(".control-group").addClass("hidden"),lizMap.events.triggerEvent("lizmapeditiondrawfeaturedeactivated",{layerId:a.id,editionConfig:a.config})}function y(){var e=$("#edition-form-container form"),t=e.find('input[name="liz_srid"]').val();""==t||"EPSG:"+t in Proj4js.defs||(Proj4js.defs["EPSG:"+t]=e.find('input[name="liz_proj4"]').val()),$("#edition-point-coord-crs-layer").html(lizDict["edition.point.coord.crs.layer"]+" - EPSG:"+t).val(t).show();var i=a.projCode.replace("EPSG:","");$("#edition-point-coord-crs-map").html(lizDict["edition.point.coord.crs.map"]+" - EPSG:"+i).val(i).show(),"point"==a.geometryType?$("#edition-point-coord-add").hide():$("#edition-point-coord-add").show(),$("#handle-point-coord").show(),lizMap.events.triggerEvent("lizmapeditiondrawfeatureactivated",{layerId:a.id,editionConfig:a.config,drawControl:a.drawControl})}function g(){var e=parseFloat($("#edition-point-coord-x").val()),t=parseFloat($("#edition-point-coord-y").val());if(!isNaN(e)&&!isNaN(t)){var i=new OpenLayers.Geometry.Point(e,t),n=$("#edition-point-coord-crs").val();i.transform("EPSG:"+n,a.ol.projection);var o=a.geometryType;if(r[o].handler.point)r[o].handler.point.geometry.x=i.x,r[o].handler.point.geometry.y=i.y,r[o].handler.point.geometry.clearBounds(),w(r[o].handler.layer.features[0].geometry);else{var l=r[o].handler.layer.getViewPortPxFromLonLat({lon:i.x,lat:i.y});r[o].handler.createFeature(l),r[o].handler.point.geometry.x=i.x,r[o].handler.point.geometry.y=i.y,r[o].handler.point.geometry.clearBounds()}r[o].handler.drawFeature()}}function v(e){var t=[e];if("relations"in i)for(var o in i.relations)if(o==e){var r=i.relations[e];for(var a in r){var l=r[a];-1==$.inArray(l.referencingLayer,t)&&t.push(l.referencingLayer)}}else if("pivot"==o&&e in i.relations.pivot){var d=i.relations.pivot[e];for(var s in d)-1==$.inArray(s,t)&&t.push(s)}else{if(-1!=$.inArray(o,t))continue;for(var a in r=i.relations[o])(l=r[a]).referencingLayer==e&&t.push(o)}for(var p=[];t.length>0;)if(a=t.shift(),c=lizMap.getLayerConfigById(a,i.layers,"id")){var c,u=c[0];if("geometryType"in(c=c[1])&&"none"!=c.geometryType){var f=n.getLayersByName(u);0==f.length&&(f=n.getLayersByName(lizMap.cleanName(u))),0!=f.length&&(f=f[0]).getVisibility()&&(p.push(c.id),f.redraw(!0))}}return p}function h(){lizMap.editionPending=!1,$("#mapmenu .edition").removeClass("edition-pending"),r&&(a.deactivateControl(),$("#edition-geomtool-container button i").removeClass("line"),$("#edition-geomtool-container").hide(),r.modify.mode=OpenLayers.Control.ModifyFeature.RESHAPE,r.modify.createVertices=!0,r.panel.deactivate()),$("#lizmap-edition-message").remove(),$("#edition-children-container").hide().html(""),$("#edition-form-container").hide().html(""),$("#edition-waiter").hide(),z()?$("#edition-creation").show():($("#edition-modification-msg").show(),$("#dock-close").click()),$(".edition-tabs").hide(),$('.edition-tabs a[href="#tabdigitization"]').show()}function z(){if("editionLayers"in i)for(const e in i.editionLayers)if("True"===i.editionLayers[e].capabilities.createFeature)return!0;return!1}function b(e){var t=$("#edition-point-coord-crs").val(),i=new OpenLayers.Projection("EPSG:"+t);e.transform(a.ol.projection,i),"degrees"===i.getUnits()?($("#edition-point-coord-x").val(e.x.toFixed(6)),$("#edition-point-coord-y").val(e.y.toFixed(6))):($("#edition-point-coord-x").val(e.x.toFixed(3)),$("#edition-point-coord-y").val(e.y.toFixed(3)))}function F(e,t,i){$("#edition-segment-length").parents(".control-group").removeClass("hidden");const n=e.length,o=new OpenLayers.Geometry.LineString([e[n-2],e[n-1]]).getGeodesicLength(t);if(i){let i=0;if(n>1)for(let o=0;o<n-1;o++)i+=new OpenLayers.Geometry.LineString([e[o],e[o+1]]).getGeodesicLength(t);else i=o;$("#edition-segment-length").text(o.toFixed(3)+" / "+i.toFixed(3))}else $("#edition-segment-length").text(o.toFixed(3));lizMap.mainLizmap.edition.lastSegmentLength=o.toFixed(3)}function L(e,t,i){$("#edition-segment-angle").parents(".control-group").removeClass("hidden");const n=Math.sqrt(Math.pow(t.x-e.x,2)+Math.pow(t.y-e.y,2)),o=Math.sqrt(Math.pow(t.x-i.x,2)+Math.pow(t.y-i.y,2)),r=Math.sqrt(Math.pow(i.x-e.x,2)+Math.pow(i.y-e.y,2));let a=180*Math.acos((o*o+n*n-r*r)/(2*o*n))/Math.PI;isNaN(a)&&(a=0),$("#edition-segment-angle").text(a.toFixed(2))}function w(e){if("OpenLayers.Geometry.LineString"===e.CLASS_NAME&&e.components&&e.components.length>1){const t=e.components,i=t.length;F(t,a.ol.projection,!0),i>2&&L(t[i-1],t[i-2],t[i-3])}else if("OpenLayers.Geometry.Polygon"===e.CLASS_NAME&&e.components&&e.components[0].components.length>2){const t=e.clone().components[0].components;t.pop();const i=t.length;F(t,a.ol.projection,!1),i>2&&L(t[i-1],t[i-2],t[i-3])}}function C(t,n,o,r){var l=new e(t,null,null),d=null;if(null!=o&&"layerId"in o&&"feature"in o){var s=o.layerId,p=o.feature;if("relations"in i&&s in i.relations){var c=function(e,t){if("relations"in i&&e in i.relations){var n=i.relations[e];for(var o in n){var r=n[o];if(r.referencingLayer==t)return r}}return null}(s,t);if(null!=c&&c.referencingLayer==t){if(lizMap.editionPending&&a.id==s){var u=$('#edition-form-container form input[name="liz_featureId"]').val();$('#edition-form-container form input[name="liz_layerId"]').val()==s&&u==p.id.split(".").pop()&&((d=a.currentFeature).relation=c,d.feature=p,l.setParentToEditAfterSave(d),h())}d||(d=new e(s,p,c),l.parent=d)}}}return _(l,n,r)}function M(){var e=a.parent;return _(e,e.feature.id.split(".").pop())}function _(e,t,n){if(lizMap.editionPending){if(!confirm(lizDict["edition.confirm.cancel"]))return!1;h()}if(a.clear(),!("editionLayers"in i))return!1;if(!r)return!1;lizMap.editionPending=!0,$("#mapmenu .edition").addClass("edition-pending"),a.createLayers();var o=lizMap.getLayerConfigById(e.layerId,i.editionLayers,"layerId");if(!o)return lizMap.editionPending=!1,$("#mapmenu .edition").removeClass("edition-pending"),!1;e.config=o[1],a.currentFeature=e;var d=e.geometryType;return d in r&&a.setDrawControl(r[d]),function(e,t){$("#edition-waiter").show(),$("#edition-form-container").hide(),l=e?"modifyFeature":"createFeature";var i=$("#edition-form-container form");0!=i.length&&i.unbind("submit");var n=OpenLayers.Util.urlAppend(lizUrls.edition,OpenLayers.Util.getParameterString(lizUrls.params));$.get(n.replace("getFeature",l),{layerId:a.id,featureId:e},(function(i){return!!r&&!!a.id&&($("#edition-modification-msg").hide(),$("#edition-creation").hide(),$(".edition-tabs").show(),x(i),void(t&&t(a.id,e)))}))}(t,n),a.restoreSplitFeatures(),$("#bottom-dock").trigger("mouseleave"),!0}function P(e){var t=$("<span>").addClass("custom-autocomplete").insertAfter(e),i=e.children(":selected"),n=i.val()?i.text():"",o=$("<input>").appendTo(t).val(n).attr("title","").addClass("custom-autocomplete-input").autocomplete({source:function(t,i){var n=new RegExp($.ui.autocomplete.escapeRegex(t.term),"i");i(e.children("option").map((function(){var e=$(this).text();if(this.value&&(!t.term||n.test(e)))return{label:e,value:e,option:this}})))}});o.autocomplete("widget").css("z-index","1050"),o.attr("name",e.attr("name")),e.attr("name",o.attr("name")+"_source"),e.hide()}function x(e){var t=$("#edition-form-container form").serializeArray(),i=$("#edition-form-container");i.html(e);var n,d=$("#edition-form-container form");if(0!=d.length){d.serializeArray();var s=d.find('input[name="liz_featureId"]').val();if(l=s?"modifyFeature":"createFeature",a.spatial&&"modifyFeature"==l){var c=d.find('input[name="liz_geometryColumn"]').val();if(""!=c){var u=d.find('input[name="'+c+'"]').val();$('#edition-hidden-form input[name="liz_wkt"]').val(u)}}if(null!=a.parent){var f=a.parent,m=f.relation,y=m.referencingField,g=f.feature.properties[m.referencedField],z=d.find('select[name="'+y+'"]');if(1==z.length){z.val(g).attr("disabled","disabled");var b=$('<input type="hidden"></input>').attr("id",z.attr("id")+"_hidden").attr("name",y).attr("value",g);d.find("div.jforms-hiddens").append(b),jFormsJQ.getForm(d.attr("id")).getControl(y).required=!1}else{var F=d.find('input[name="'+y+'"]');1==F.length&&"hidden"!=F.attr("type")?(F.val(g).attr("disabled","disabled"),b=$('<input type="hidden"></input>').attr("id",F.attr("id")+"_hidden").attr("name",y).attr("value",g),d.find("div.jforms-hiddens").append(b),jFormsJQ.getForm($("#edition-form-container form").attr("id")).getControl(y).required=!1):F.val(g)}}for(var L=d.find("select.combobox:not(:disabled)"),w=0,C=L.length;w<C;w++)(n=$(L[w])).combobox({minLength:1,position:{my:"left bottom",position:"flip"},selected:function(e,t){if(t.item){var i=$(this),n=$(t.item);window.setTimeout((function(){i.val(n.val()).change()}),1)}}}),n.parent().find("span > input").removeClass("label ui-corner-left ui-state-default ui-widget-content ui-widget");var _=d.find("select.autocomplete:not(:disabled)");for(w=0,C=_.length;w<C;w++)P($(_[w]));if("0"==d.find('input[name="liz_status"]').val()){if(0!=t.length){var I=a.id,k="lizmapeditionfeaturecreated";"modifyFeature"==l&&(k="lizmapeditionfeaturemodified"),lizMap.events.triggerEvent(k,{layerId:I}),v(I)}var A=a.geometryType;let e=j();if("createFeature"!=l&&e)"True"==a.config.capabilities.modifyGeometry&&A in r?(e=function(){var e=j();return null==e&&(e=new OpenLayers.Feature.Vector),e.fid=$("#edition-form-container form").find('input[name="liz_featureId"]').val(),a.replaceFeature(e),e}(),e&&(r.modify.activate(),$("#edition-geomtool-nodetool").click(),r.modify.selectFeature(e),"line"==A&&$("#edition-geomtool-container button i").addClass("line"),"point"!=A&&$("#edition-geomtool-container").show())):$('.edition-tabs a[href="#tabdigitization"]').hide(),p(lizDict["edition.select.modify.activate"],"info",!0);else if(("True"==a.config.capabilities.createFeature||!e&&"True"==a.config.capabilities.modifyGeometry)&&A in r){$("#edition-geomtool-container button i").removeClass("line"),$("#edition-geomtool-container").hide(),r.modify.mode=OpenLayers.Control.ModifyFeature.RESHAPE,r.modify.createVertices=!0,r.modify.deactivate(),a.clearLayers();var R=r[A];R.active||(R.activate(),lizMap.checkMobile()?p(lizDict["edition.draw.activate.mobile"],"info",!0):p(lizDict["edition.draw.activate"],"info",!0)),e&&(a.ol.addFeatures([e]),r.modify.activate(),$("#edition-geomtool-nodetool").click(),r.modify.selectFeature(e),"line"==A&&$("#edition-geomtool-container button i").addClass("line"),"point"!=A&&$("#edition-geomtool-container").show())}else $('.edition-tabs a[href="#tabdigitization"]').hide()}i.show(),0==d.children("ul.nav-tabs").find("li").filter((function(){return"none"!==$(this).css("display")})).length?$("#"+d.attr("id")+"-tab-content").hide():d.children("ul.nav-tabs").find("li:first a").click().blur(),function(e){var t=jFormsJQ.getForm(e.attr("id"));if(t.groupDependencies)for(var i=t.groupDependencies,n=0,o=i.length;n<o;n++){var r=i[n];elt=e.find("#"+e.attr("id")+"_"+r),0!=elt.length&&elt.change((function(){S(e)}))}}(d),$("#"+d.attr("id")+"_liz_future_action_label").removeClass("control-label"),function(e){a.submitActor="submit",e.find('input[type="submit"]').click((function(t){var i=e.attr("id")+"__submit_",n=$(this).attr("id").replace(i,"");if(a.submitActor=n,"cancel"==n)return t.stopPropagation(),confirm(lizDict["edition.confirm.cancel"])&&x(""),!1}));var t=a.getFeature();t&&T(t),e.submit((function(t){if("cancel"==a.submitActor)return h(),a.canEditParentFeature()?M():(a.clear(),lizMap.events.triggerEvent("lizmapeditionformclosed")),!1;var i=E(e,t);if(!1===i)return!1;if("ok"!=i)return p(i,"info",!0),!1;var n=e.attr("id")+"__submit";$("#"+n).val(a.submitActor),$("#edition-waiter").show();var o=e.attr("data-new-feature-action"),r=e.attr("action"),l=new FormData(e.get(0)),d="",s=O(r,l);return s.then((function(e){d=e})),a.newfeatures.forEach((function(e){s=s.then((()=>O(o,e[1])))})),s.then((()=>{x(d)})),!1}))}(d),lizMap.events.triggerEvent("lizmapeditionformdisplayed",{layerId:a.id,featureId:s,editionConfig:a.config})}0==d.length&&(o.edition.deactivate(),o.edition.activate(),I=a.id,k="lizmapeditionfeaturecreated","modifyFeature"==l&&(k="lizmapeditionfeaturemodified"),lizMap.events.triggerEvent(k,{layerId:I}),v(I),h(),""!=e&&p(e,"info",!0)),$("#edition-waiter").hide(),$("li.edition:not(.active) #button-edition").click(),$("#liz_layer_popup_close").length&&$("#liz_layer_popup_close").click(),$("#mapmenu .nav-list > li.popupcontent > a").length&&$("#mapmenu .nav-list > li.popupcontent").hasClass("active")&&($("#button-popupcontent").click(),$("div.lizmapPopupContent").remove()),0==d.length&&(a.canEditParentFeature()?M():(a.clear(),lizMap.clearDrawLayer("locatelayer"),lizMap.events.triggerEvent("lizmapeditionformclosed")))}function S(e){const t=jFormsJQ.getForm(e.attr("id")),i=new FormData(t.element),n=new FormData;n.append("__form",t.selector),n.append("__formid",t.formId),n.append("__JFORMS_TOKEN__",i.get("__JFORMS_TOKEN__"));for(const e of t.groupDependencies)for(const t of i.getAll(e))n.append(e,t);fetch(jFormsJQ.groupVisibilitiesUrl,{method:"POST",body:n}).then((function(e){return e.json()})).then((function(t){for(groupId in t){var i=$("#"+groupId);if(i.hasClass("tab-pane")){var n=e.children("ul.nav-tabs").find('li a[href="#'+groupId+'"]'),o=n.parent();if(t[groupId]){o.is(":visible")||o.show();var r=$("#"+e.attr("id")+"-tab-content");r.is(":hidden")&&(r.show(),n.click().blur())}else o.hasClass("active")?o.prev(":visible").length>0?(o.prev().children("a").first().click().blur(),o.hide()):o.next(":visible").length>0?(o.next().children("a").first().click().blur(),o.hide()):(o.hide(),$("#"+e.attr("id")+"-tab-content").hide()):o.hide()}else t[groupId]?i.show():i.hide()}}))}function O(e,t){return new Promise((function(i,n){var o=new XMLHttpRequest;o.open("POST",e),o.onload=function(e){200==o.status?i(o.responseText):n()},o.send(t)}))}function E(e,t){if(t){if(!jFormsJQ._submitListener(t))return!1}else if(e.trigger("jFormsUpdateFields"),!jFormsJQ.verifyForm(e.get(0)))return!1;var i="ok";if(a.spatial&&"allow_without_geom"in a.config.capabilities&&"False"==a.config.capabilities.allow_without_geom){var n=e.find('input[name="liz_geometryColumn"]').val();""==e.find('input[name="'+n+'"]').val().trim()&&(i=lizDict["edition.message.error.no.geometry"])}return i}function I(e){if(null==e.geometry)return"";if(!a.ol)return"";var t=e.geometry.clone(),i=$("#edition-form-container form"),n=i.find('input[name="liz_srid"]').val();return""==n||"EPSG:"+n in Proj4js.defs||(Proj4js.defs["EPSG:"+n]=i.find('input[name="liz_proj4"]').val()),t.transform(a.ol.projection,"EPSG:"+n),t}function T(e){var t=I(e);if(""===t)return!1;var i=$("#edition-form-container form"),n=i.find('input[name="liz_srid"]').val();""==n||"EPSG:"+n in Proj4js.defs||(Proj4js.defs["EPSG:"+n]=i.find('input[name="liz_proj4"]').val());var o=i.find('input[name="liz_geometryColumn"]').val();i.find('input[name="'+o+'"]').val(t).change();var r=i.find('input[name="liz_featureId"]').val(),a=i.find('input[name="liz_layerId"]').val();return lizMap.events.triggerEvent("lizmapeditiongeometryupdated",{layerId:a,featureId:r,geometry:t,srid:n}),!0}function j(){if(!a.ol)return null;var e=$("#edition-form-container form"),t=e.find('input[name="liz_geometryColumn"]').val(),i=e.find('input[name="liz_srid"]').val();if(""==i||"EPSG:"+i in Proj4js.defs||(Proj4js.defs["EPSG:"+i]=e.find('input[name="liz_proj4"]').val()),""!=t){var n=e.find('input[name="'+t+'"]').val();if(""!=n)return new OpenLayers.Format.WKT({externalProjection:"EPSG:"+i,internalProjection:a.ol.projection}).read(n)}return null}function k(e,t,n,o){if(!("editionLayers"in i))return!1;var r=lizMap.getLayerConfigById(e,i.editionLayers,"layerId");if(!r||"False"==r[1].capabilities.deleteFeature)return!1;var a=r[0],l=i.layers[a];r[0].split(" ").join("_"),"shortname"in l&&""!=l.shortname&&l.shortname;var d=lizDict["edition.confirm.delete"];if(n&&(d+="\n"+n),!confirm(d))return!1;var s=OpenLayers.Util.urlAppend(lizUrls.edition,OpenLayers.Util.getParameterString(lizUrls.params));return $.get(s.replace("getFeature","deleteFeature"),{layerId:e,featureId:t},(function(i){p(i,"info",!0),o&&o(e,t),lizMap.events.triggerEvent("lizmapeditionfeaturedeleted",{layerId:e,featureId:t,featureType:a,updateDrawing:!0}),v(e)})),!1}OpenLayers.Geometry.pointOnSegment=function(e,t){return!(e.x<Math.min(t.x1,t.x2)||e.x>Math.max(t.x1,t.x2)||e.y<Math.min(t.y1,t.y2)||e.y>Math.max(t.y1,t.y2))&&(t.x1==t.x2||t.y1==t.y2||e.x==t.x1&&e.y==t.y1||e.x==t.x2&&e.y==t.y2||((t.x1-e.x)/(t.y1-e.y)).toFixed(5)==((t.x2-e.x)/(t.y2-e.y)).toFixed(5))},lizMap.events.on({uicreated:function(e){i=lizMap.config,lizMap.layers,n=lizMap.map,o=lizMap.controls;var t={addStyleRulesToSplitLayers:function(e){a.splitOlStyleCustomRules=a.splitOlStyleCustomRules.concat(e)},addStyleRulesToEditLayers:function(e){a.olStyleCustomRules=a.olStyleCustomRules.concat(e)}};lizMap.events.triggerEvent("lizmapeditionfeatureinit",{editorOptions:t}),function(){if("editionLayers"in i){var e={},t=[];for(var l in i.editionLayers){var d=i.editionLayers[l];if("False"!=d.capabilities.createFeature||"False"!=d.capabilities.modifyAttribute||"False"!=d.capabilities.deleteFeature||"False"!=d.capabilities.modifyGeometry){if(l in i.layers&&"True"==d.capabilities.createFeature){var s=i.layers[l];e[d.order]={id:s.id,title:s.title,order:d.order},t.push(d.order)}}else delete i.editionLayers[l]}for(var v in t.sort((function(e,t){return e-t})),t)s=e[t[v]],$("#edition-layer").append('<option value="'+s.id+'">'+s.title+"</option>");z()?$("#edition-modification-msg").hide():$("#edition-creation").hide(),a.createLayers();var F=a.ol;for(var L in r={panel:new OpenLayers.Control({type:OpenLayers.Control.TYPE_TOOL,eventListeners:{activate:function(e){lizMap.deactivateToolControls(e),null!==lizMap.controls.featureInfo&&lizMap.controls.featureInfo.deactivate()},deactivate:function(e){for(var t in r)"panel"!=t&&r[t].active&&r[t].deactivate();null!==lizMap.controls.featureInfo&&lizMap.controls.featureInfo.activate()}}}),point:new OpenLayers.Control.DrawFeature(F,OpenLayers.Handler.Point,{eventListeners:{activate:y,deactivate:m}}),line:new OpenLayers.Control.DrawFeature(F,OpenLayers.Handler.Path,{eventListeners:{activate:y,deactivate:m}}),polygon:new OpenLayers.Control.DrawFeature(F,OpenLayers.Handler.Polygon,{eventListeners:{activate:y,deactivate:m}}),modify:new OpenLayers.Control.ModifyFeature(F),reshape:new OpenLayers.Control.Split({layer:F,eventListeners:{aftersplit:c}}),featsplit:new OpenLayers.Control.Split({layer:F,eventListeners:{beforesplit:u,aftersplit:f}})})"panel"!=L&&r[L].events.on({activate:function(e){e.object.layer.setVisibility(!0)},deactivate:function(e){e.object.layer.setVisibility(!1)}}),n.addControls([r[L]]);o.edition=r.panel,F.events.on({featureadded:function(){if(!r)return!1;var e=a.geometryType,t=r[e].active;t&&r[e].deactivate();var i=F.features[0];T(i),(t||"True"==a.config.capabilities.modifyGeometry)&&(r.panel.activate(),r.modify.activate(),$("#edition-geomtool-nodetool").click(),r.modify.selectFeature(i),"line"===e&&$("#edition-geomtool-container button i").addClass("line"),"point"!==e&&$("#edition-geomtool-container").show()),"point"===e&&($('.edition-tabs a[href="#tabform"]').tab("show"),$("#handle-point-coord").hide()),p(lizDict["edition.select.modify.activate"],"info",!0)},featuremodified:function(e){null!=e.feature.geometry&&T(e.feature)},featureselected:function(e){e.feature.geometry},featureunselected:function(e){null!=e.feature.geometry&&T(e.feature)},sketchmodified:function(e){if($("#edition-point-coord-geolocation").is(":checked")){var[t,i]=lizMap.mainLizmap.geolocation.getPositionInCRS(a.ol.projection);e.vertex.x=t,e.vertex.y=i}else b(e.vertex.clone());w(e.feature.geometry)},vertexmodified:function(e){}}),$("#edition-draw").click((function(){if($(this).hasClass("disabled"))return!1;if(lizMap.editionPending){if(!confirm(lizDict["edition.confirm.cancel"]))return!1;h(),a.clear()}return r.panel.activate(),C($("#edition-layer").val(),null),!1})),$("#edition-point-coord-form").submit((function(){return!1})),$("#edition-point-coord-crs").change((function(){null!==r[a.geometryType].handler.point&&b(r[a.geometryType].handler.point.geometry.clone())})),$("#edition-point-coord-x").keyup(g),$("#edition-point-coord-y").keyup(g),$("#edition-point-coord-geolocation").change((function(){if($(this).is(":checked")){if($("#edition-point-coord-x").attr("disabled","disabled"),$("#edition-point-coord-y").attr("disabled","disabled"),lizMap.mainLizmap.geolocation.isTracking){var e=a.geometryType,[t,i]=lizMap.mainLizmap.geolocation.getPositionInCRS(a.ol.projection);if(t&&i){var n=r[e].handler.layer.getViewPortPxFromLonLat({lon:t,lat:i});r[e].handler.modifyFeature(n),b(new OpenLayers.Geometry.Point(t,i))}}}else $("#edition-point-coord-x").removeAttr("disabled"),$("#edition-point-coord-y").removeAttr("disabled");lizMap.mainLizmap.geolocation.isLinkedToEdition=$(this).is(":checked")})),$("#edition-point-coord-add").click((function(){var e=a.geometryType;if("point"!=e&&r[e].handler.point){var t=r[e].handler.point.geometry;r[e].handler.insertXY(t.x,t.y)}})),$("#edition-point-coord-submit").click((function(){var e=a.geometryType;r[e].handler.getGeometry()&&("point"===e?(lizMap.mainLizmap.geolocationSurvey.averageRecordMode&&void 0!==lizMap.mainLizmap.geolocationSurvey.positionAverageInMapCRS&&(r[e].handler.point.geometry.x=lizMap.mainLizmap.geolocationSurvey.positionAverageInMapCRS[0],r[e].handler.point.geometry.y=lizMap.mainLizmap.geolocationSurvey.positionAverageInMapCRS[1],r[e].handler.drawFeature()),r[e].handler.finalize()):r[e].handler.finishGeometry())})),$("#edition-geomtool-nodetool").click((function(){r.reshape.deactivate(),r.featsplit.deactivate(),r.modify.mode=OpenLayers.Control.ModifyFeature.RESHAPE,r.modify.createVertices=!0,r.modify.activate();var e=a.getFeature();e.geometry&&(r.modify.feature&&r.modify.unselectFeature(e),r.modify.selectFeature(e))})),$("#edition-geomtool-drag").click((function(){r.reshape.deactivate(),r.featsplit.deactivate(),r.modify.mode=OpenLayers.Control.ModifyFeature.DRAG,r.modify.createVertices=!1,r.modify.activate();var e=a.getFeature();e&&(r.modify.feature&&r.modify.unselectFeature(e),r.modify.selectFeature(e))})),$("#edition-geomtool-rotate").click((function(){r.reshape.deactivate(),r.featsplit.deactivate(),r.modify.mode=OpenLayers.Control.ModifyFeature.ROTATE,r.modify.createVertices=!1,r.modify.activate();var e=a.getFeature();e&&(r.modify.feature&&r.modify.unselectFeature(e),r.modify.selectFeature(e))})),$("#edition-geomtool-reshape").click((function(){var e=a.getFeature();e&&r.modify.feature&&r.modify.unselectFeature(e),r.modify.deactivate(),r.featsplit.deactivate(),r.reshape.activate()})),$("#edition-geomtool-split").click((function(){var e=a.getFeature();e&&r.modify.feature&&r.modify.unselectFeature(e),r.modify.deactivate(),r.reshape.deactivate(),r.featsplit.activate()})),$("#edition-geomtool-container button, lizmap-reverse-geom").tooltip({placement:"top"}),lizMap.mainEventDispatcher.addListener((()=>{const e=lizMap.mainLizmap.geolocation.isTracking;$("#edition-point-coord-geolocation-group").toggle(e),e?$("#edition-point-coord-geolocation").is(":checked")&&($("#edition-point-coord-x").attr("disabled","disabled"),$("#edition-point-coord-y").attr("disabled","disabled")):($("#edition-point-coord-x").removeAttr("disabled"),$("#edition-point-coord-y").removeAttr("disabled"))}),"geolocation.isTracking"),lizMap.mainEventDispatcher.addListener((()=>{if(a&&"config"in a){$("#edition-point-coord-geolocation").removeAttr("disabled");var e=a.geometryType;if($("#edition-point-coord-geolocation").is(":checked")&&r[e].active){var[t,i]=lizMap.mainLizmap.geolocation.getPositionInCRS(a.ol.projection),n=r[e].handler.layer.getViewPortPxFromLonLat({lon:t,lat:i});r[e].handler.modifyFeature(n),b(new OpenLayers.Geometry.Point(t,i))}}}),"geolocation.position")}else $("#edition").parent().remove(),$("#button-edition").remove(),$("#edition-form-container").hide()}(),lizMap.launchEdition=function(e,t,i,n){return C(e,t,i,n)},lizMap.deleteEditionFeature=function(e,t,i,n){return k(e,t,i,n)},lizMap.events.on({lizmappopupdisplayed:function(e){var t=!1,n=e.popup,o="div.lizmapPopupContent input.lizmap-popup-layer-feature-id";if(e.containerId&&(o="#"+e.containerId+" "+o),$(o).val()){var r={},a=[],l=[];$(o).each((function(){var e=$(this).val(),t=e.split(".").pop(),n=e.replace("."+t,"");if(lizMap.getLayerConfigById(n),"editionLayers"in i&&!(n in r)){var o=null;"editionLayers"in i&&(o=lizMap.getLayerConfigById(n,i.editionLayers,"layerId"),a.push(n),r[n]={edition_config:o})}}));for(const e in a){var d=a[e],s={repository:lizUrls.params.repository,project:lizUrls.params.project,layerId:d},p=OpenLayers.Util.urlAppend(lizUrls.edition.replace("getFeature","editableFeatures"),OpenLayers.Util.getParameterString(s));const t=fetch(p).then((function(e){return e.json()}));l.push(t)}Promise.all(l).then((e=>{for(const t in a){var i=e[t],l=a[t];let n=!1,o=[];if("success"in i&&i.success&&"status"in i&&"restricted"==i.status){n=!0;for(const e of i.features)o.push(e.id.split(".")[1])}r[l].editable_feature_ids=o,r[l].has_restriction=n}$(o).each((function(){var e=$(this),i=e.val(),o=i.split(".").pop(),a=i.replace("."+o,""),l=lizMap.getLayerConfigById(a),d=null,s=null;if(a in r&&(s=(d=r[a]).edition_config),d&&(!d.has_restriction||d.editable_feature_ids.includes(o))){var p="";if(!s||"True"!=s[1].capabilities.modifyAttribute&&"True"!=s[1].capabilities.modifyGeometry||0!=e.next("span.popupButtonBar").find("button.popup-layer-feature-edit").length||(p+='<button class="btn btn-mini popup-layer-feature-edit"',p+=' value="'+i+'"',p+=' title="'+lizDict["attributeLayers.btn.edit.title"]+'"><i class="icon-pencil"></i>&nbsp;</button>'),s&&"True"==s[1].capabilities.deleteFeature&&0==e.next("span.popupButtonBar").find("button.popup-layer-feature-delete").length&&(p+='<button class="btn btn-mini popup-layer-feature-delete"',p+=' value="'+i+'"',p+=' title="'+lizDict["attributeLayers.btn.delete.title"]+'"><i class="icon-trash"></i>&nbsp;</button>'),""!=p){var c=e.next("span.popupButtonBar");0!=c.length?c.append(p):(p='<span class="popupButtonBar">'+p+"</span><br/>",e.after(p)),e.find("button.btn").tooltip({placement:"bottom"}),t=!0,n&&n.verifySize()}}lizMap.events.triggerEvent("lizmappopuplayerfeaturedisplayed",{popup:n,fid:o,layerId:a,eConfig:s,layerName:l[0],layerConfig:l[1],div:e.parent()})})),t&&($("div.lizmapPopupContent button.popup-layer-feature-edit").unbind("click").click((function(){var e=$(this).val().split(".").pop(),t=$(this).val().replace("."+e,"");return lizMap.launchEdition(t,e),0!=lizMap.map.popups.length&&lizMap.map.removePopup(lizMap.map.popups[0]),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})).tooltip(),$("div.lizmapPopupContent button.popup-layer-feature-delete").unbind("click").click((function(){var e=$(this).val().split(".").pop();return k($(this).val().replace("."+e,""),e),0!=lizMap.map.popups.length&&lizMap.map.removePopup(lizMap.map.popups[0]),!1})).hover((function(){$(this).addClass("btn-primary")}),(function(){$(this).removeClass("btn-primary")})).tooltip(),lizMap.events.triggerEvent("lizmappopupupdated",{popup:n}))}))}}})}})}(),e.prototype={start:function(e){this.message="",this.form=e,$("#"+e.name+" .jforms-error").removeClass("jforms-error"),$("#"+e.name+"_errors").empty().hide()},addError:function(e,t){var i=this.form.element.elements[e.name];i&&i.nodeType&&$(i).addClass("jforms-error");var n=e.name.replace(/\[\]/,"");$("#"+this.form.name+"_"+n+"_label").addClass("jforms-error"),this.message+=1==t?'<p class="error"> '+e.errRequired+"</p>":2==t?'<p class="error"> '+e.errInvalid+"</p>":'<p class="error"> Error on \''+e.label+"' </p>"},end:function(){var e=this.form.name+"_errors",t=document.getElementById(e);""!=this.message?(t||((t=document.createElement("div")).setAttribute("class","jforms-error-list alert alert-block alert-error"),t.setAttribute("id",e),$(this.form.element).first().before(t)),$(t).hide().html(this.message).fadeIn()):t&&$(t).hide()}},window.lizEditionErrorDecorator=e})();
//# sourceMappingURL=edition.js.map