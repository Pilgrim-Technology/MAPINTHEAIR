{"version":3,"file":"../../lizmap/www/assets/js/map.js","mappings":"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","sources":["webpack://assets/./src/legacy/map.js"],"sourcesContent":["/**\n* Class: lizMap\n* @package   lizmap\n* @subpackage view\n* @author    3liz\n* @copyright 2011 3liz\n* @link      http://3liz.com\n* @license    Mozilla Public License : http://www.mozilla.org/MPL/\n*/\n\n\nwindow.lizMap = function() {\n  /**\n   * PRIVATE Property: config\n   * {object} The map config\n   */\n  var config = null;\n  /**\n   * PRIVATE Property: capabilities\n   * {object} The wms capabilities\n   */\n  var capabilities = null;\n  /**\n   * PRIVATE Property: wmtsCapabilities\n   * {object} The wmts capabilities\n   */\n  var wmtsCapabilities = null;\n  /**\n   * PRIVATE Property: wfsCapabilities\n   * {object} The wfs capabilities\n   */\n  var wfsCapabilities = null;\n  /**\n   * PRIVATE Property: map\n   * {<OpenLayers.Map>} The map\n   */\n  var map = null;\n  /**\n   * PRIVATE Property: baselayers\n   * {Array(<OpenLayers.Layer>)} Ordered list of base layers\n   */\n  var baselayers = [];\n  /**\n   * PRIVATE Property: layers\n   * {Array(<OpenLayers.Layer>)} Ordered list of layers\n   */\n  var layers = [];\n  /**\n   * PRIVATE Property: controls\n   * {Object({key:<OpenLayers.Control>})} Dictionary of controls\n   */\n  var controls = {};\n  /**\n   * PRIVATE Property: printCapabilities\n   * {Object({scales:[Float],layouts:[Object]})} Print capabilities\n   */\n  var printCapabilities = {scales:[],layouts:[]};\n  /**\n   * PRIVATE Property: tree\n   * {object} The layer's tree\n   */\n  var tree = {config:{type:'group'}};\n\n  /**\n   * PRIVATE Property: getFeatureInfoVendorParams\n   * {object} Additional QGIS Server parameter for click tolerance in pixels\n   */\n  var defaultGetFeatureInfoTolerances = {\n    'FI_POINT_TOLERANCE': 25,\n    'FI_LINE_TOLERANCE': 10,\n    'FI_POLYGON_TOLERANCE': 5\n  };\n\n  /**\n   * PRIVATE Property: externalBaselayersReplacement\n   *\n   */\n  var externalBaselayersReplacement = {\n    'osm': 'osm-mapnik',\n    'osm-toner': 'osm-stamen-toner',\n    'osm-cycle': 'osm-cyclemap',\n    'gsat': 'google-satellite',\n    'ghyb': 'google-hybrid',\n    'gphy': 'google-terrain',\n    'gmap': 'google-street',\n    'bmap': 'bing-road',\n    'baerial': 'bing-aerial',\n    'bhybrid': 'bing-hybrid',\n    'ignmap': 'ign-scan',\n    'ignplan': 'ign-plan',\n    'ignphoto': 'ign-photo',\n    'igncadastral': 'ign-cadastral'\n  };\n\n  /**\n   * PRIVATE Property: externalBaselayersReplacement\n   *\n   */\n  var startupBaselayersReplacement = {\n    'osm-mapnik': 'osm',\n    'osm-stamen-toner': 'osm-toner',\n    'osm-cyclemap': 'osm-cycle',\n    'google-satellite': 'gsat',\n    'google-hybrid': 'ghyb',\n    'google-terrain': 'gphy',\n    'google-street': 'gmap',\n    'bing-road': 'bmap',\n    'bing-aerial': 'baerial',\n    'bing-hybrid': 'bhybrid',\n    'ign-scan': 'ignmap',\n    'ign-plan': 'ignplan',\n    'ign-photo': 'ignphoto',\n    'ign-cadastral': 'igncadastral',\n    'empty': 'emptyBaselayer'\n  };\n\n  /**\n   * PRIVATE Property: cleanNameMap\n   *\n   */\n  var cleanNameMap = {\n  };\n\n  /**\n   * PRIVATE Property: layerIdMap\n   *\n   */\n  var layerIdMap = {\n  };\n  /**\n   * PRIVATE Property: shortNameMap\n   *\n   */\n  var shortNameMap = {\n  };\n  /**\n   * PRIVATE Property: typeNameMap\n   *\n   */\n  var typeNameMap = {\n  };\n\n  /**\n   * Permalink args\n   */\n  var permalinkArgs = null;\n\n  /**\n   * PRIVATE Property: layerCleanNames\n   *\n   */\n  var layerCleanNames = {};\n\n  /**\n   * PRIVATE Property: lizmapLayerFilterActive. Contains layer name if filter is active\n   *\n   */\n  var lizmapLayerFilterActive = null;\n\n  /**\n   * PRIVATE Property: editionPending. True when an edition form has already been displayed. Used to prevent double-click on launchEdition button\n   *\n   */\n  var editionPending = false;\n\n  function performCleanName(aName) {\n    var accentMap = {\n        \"à\": \"a\",    \"á\": \"a\",    \"â\": \"a\",    \"ã\": \"a\",    \"ä\": \"a\",    \"ç\": \"c\",    \"è\": \"e\",    \"é\": \"e\",    \"ê\": \"e\",    \"ë\": \"e\",    \"ì\": \"i\",    \"í\": \"i\",    \"î\": \"i\",    \"ï\": \"i\",    \"ñ\": \"n\",    \"ò\": \"o\",    \"ó\": \"o\",    \"ô\": \"o\",    \"õ\": \"o\",    \"ö\": \"o\",    \"ù\": \"u\",    \"ú\": \"u\",    \"û\": \"u\",    \"ü\": \"u\",    \"ý\": \"y\",    \"ÿ\": \"y\",\n        \"À\": \"A\",    \"Á\": \"A\",    \"Â\": \"A\",    \"Ã\": \"A\",    \"Ä\": \"A\",    \"Ç\": \"C\",    \"È\": \"E\",    \"É\": \"E\",    \"Ê\": \"E\",    \"Ë\": \"E\",    \"Ì\": \"I\",    \"Í\": \"I\",    \"Î\": \"I\",    \"Ï\": \"I\",    \"Ñ\": \"N\",    \"Ò\": \"O\",    \"Ó\": \"O\",    \"Ô\": \"O\",    \"Õ\": \"O\",    \"Ö\": \"O\",    \"Ù\": \"U\",    \"Ú\": \"U\",    \"Û\": \"U\",    \"Ü\": \"U\",    \"Ý\": \"Y\",\n        \"-\":\" \", \"'\": \" \", \"(\": \" \", \")\": \" \"};\n    var normalize = function( term ) {\n        var ret = \"\";\n        for ( var i = 0; i < term.length; i++ ) {\n            ret += accentMap[ term.charAt(i) ] || term.charAt(i);\n        }\n        return ret;\n    };\n    var theCleanName = normalize(aName);\n    var reg = new RegExp('\\\\W', 'g');\n    return theCleanName.replace(reg, '_');\n  }\n\n  /**\n   * PRIVATE function: cleanName\n   * cleaning layerName for class and layer\n   */\n  function cleanName(aName){\n    if ( aName in cleanNameMap )\n        return aName;\n\n    if ( aName == undefined ) {\n        console.log( \"An undefined name has been clean\" );\n        return '';\n    }\n\n    var theCleanName = performCleanName( aName );\n    if ( (theCleanName in cleanNameMap) && cleanNameMap[theCleanName] != aName ){\n        var i = 1;\n        var nCleanName = theCleanName+i;\n        while( (nCleanName in cleanNameMap) && cleanNameMap[nCleanName] != aName ){\n          i += 1;\n          nCleanName = theCleanName+i;\n        }\n        theCleanName = nCleanName;\n    }\n    cleanNameMap[theCleanName] = aName;\n    return theCleanName;\n  }\n\n  function getNameByCleanName( cleanName ){\n    var name = null;\n    if( cleanName in cleanNameMap )\n      name = cleanNameMap[cleanName];\n    return name;\n  }\n\n  function getNameByShortName( shortName ){\n    var name = null;\n    if( shortName in shortNameMap )\n      name = shortNameMap[shortName];\n    return name;\n  }\n\n  function getNameByTypeName( typeName ){\n    var name = null;\n    if( typeName in typeNameMap )\n      name = typeNameMap[typeName];\n    return name;\n  }\n\n  function getLayerNameByCleanName( cleanName ){\n    var layerName = null;\n    if( cleanName in layerCleanNames )\n      layerName = layerCleanNames[cleanName];\n    if ( layerName == null && cleanName in cleanNameMap ) {\n      layerName = cleanNameMap[cleanName];\n      layerCleanNames[cleanName] = layerName;\n    }\n    return layerName;\n  }\n\n\n  /**\n   * PRIVATE function: updateMobile\n   * Determine if we should display the mobile version.\n   */\n  function updateMobile(){\n    var isMobile = mCheckMobile();\n    var contentIsMobile = $('#content').hasClass('mobile');\n    if (isMobile == contentIsMobile)\n      return;\n\n    if (isMobile) {\n      // Add mobile class to content\n      $('#content, #headermenu').addClass('mobile');\n\n      // Hide switcher\n      if( $('#button-switcher').parent().hasClass('active') )\n        $('#button-switcher').click();\n\n      // Hide tooltip-layer\n      if( $('#button-tooltip-layer').parent().hasClass('active') )\n        $('#button-tooltip-layer').click();\n\n      if( $('#menu').is(':visible'))\n        $('#menu').hide();\n\n      $('#map-content').append($('#toolbar'));\n\n      $('#toggleLegend')\n        .attr('data-original-title',$('#toggleLegendOn').attr('value'))\n        .parent().attr('class','legend');\n\n      // autocompletion items for locatebylayer feature\n      $('div.locate-layer select').show();\n      $('span.custom-combobox').hide();\n    }\n    else\n    {\n      // Remove mobile class to content\n      $('#content, #headermenu').removeClass('mobile');\n\n      // Show switcher\n      if( !( $('#button-switcher').parent().hasClass('active') ) )\n        $('#button-switcher').click();\n\n      if( !$('#menu').is(':visible'))\n        $('#content span.ui-icon-open-menu').click();\n      else\n        $('#map-content').show();\n\n      $('#toolbar').insertBefore($('#switcher-menu'));\n\n      $('#toggleLegend')\n        .attr('data-original-title',$('#toggleMapOnlyOn').attr('value'))\n        .parent().attr('class','map');\n\n      // autocompletion items for locatebylayer feature\n      $('div.locate-layer select').hide();\n      $('span.custom-combobox').show();\n    }\n\n  }\n\n\n  /**\n   * PRIVATE function: updateContentSize\n   * update the content size\n   */\n  function updateContentSize(){\n\n    updateMobile();\n\n    // calculate height height\n    var h = $(window).innerHeight();\n    h = h - $('#header').height();\n    $('#map').height(h);\n\n    // Update body padding top by summing up header+headermenu\n    $('body').css('padding-top', $('#header').outerHeight() );\n\n    // calculate map width depending on theme configuration\n    // (fullscreen map or not, mobile or not)\n    var w = $('body').parent()[0].offsetWidth;\n    w -= parseInt($('#map-content').css('margin-left'));\n    w -= parseInt($('#map-content').css('margin-right'));\n    if ($('#menu').is(':hidden') || $('#map-content').hasClass('fullscreen')) {\n      $('#map-content').css('margin-left','auto');\n    } else {\n      w -= $('#menu').width();\n      $('#map-content').css('margin-left', $('#menu').width());\n    }\n    $('#map').width(w);\n\n    if ( $('#right-dock-tabs').is(':visible') ){\n      $('#right-dock-content').css( 'max-height', $('#right-dock').height() - $('#right-dock-tabs').height() );\n    }\n\n    if(map){\n      updateMapSize();\n    }\n  }\n\n\n  /**\n   * PRIVATE function: updateMapSize\n   * query OpenLayers to update the map size\n   */\n function updateMapSize(){\n    //manage WMS max width and height\n    var wmsMaxWidth = 3000;\n    var wmsMaxHeight = 3000;\n    if( ('wmsMaxWidth' in config.options) && config.options.wmsMaxWidth )\n        wmsMaxWidth = Number(config.options.wmsMaxWidth);\n    if( ('wmsMaxHeight' in config.options) && config.options.wmsMaxHeight )\n        wmsMaxHeight = Number(config.options.wmsMaxHeight);\n    var removeSingleTile = false;\n    var newMapSize = map.getCurrentSize();\n    var replaceSingleTileSize = newMapSize.clone();\n    if( newMapSize.w > wmsMaxWidth || newMapSize.h > wmsMaxHeight ){\n        removeSingleTile = true;\n        var wmsMaxMax = Math.max(wmsMaxWidth, wmsMaxHeight);\n        var wmsMinMax = Math.min(wmsMaxWidth, wmsMaxHeight);\n        var mapMax = Math.max(newMapSize.w, newMapSize.h);\n        var mapMin = Math.min(newMapSize.w, newMapSize.h);\n        if( mapMax/2 > mapMin )\n          replaceSingleTileSize = new OpenLayers.Size(Math.round(mapMax/2), Math.round(mapMax/2));\n        else if( wmsMaxMax/2 > mapMin )\n          replaceSingleTileSize = new OpenLayers.Size(Math.round(wmsMaxMax/2), Math.round(wmsMaxMax/2));\n        else\n          replaceSingleTileSize = new OpenLayers.Size(Math.round(wmsMinMax/2), Math.round(wmsMinMax/2));\n    }\n    // Update singleTile layers\n    for(var i=0, len=map.layers.length; i<len; ++i) {\n        var layer = map.layers[i];\n        if( !(layer instanceof OpenLayers.Layer.WMS) )\n            continue;\n        var qgisName = null;\n        if ( layer.name in cleanNameMap )\n            qgisName = getLayerNameByCleanName(layer.name);\n        var configLayer = null;\n        if ( qgisName )\n            configLayer = config.layers[qgisName];\n        if ( !configLayer )\n            configLayer = config.layers[layer.params['LAYERS']];\n        if ( !configLayer )\n            configLayer = config.layers[layer.name];\n        if ( !configLayer )\n            continue;\n        if( configLayer.singleTile != \"True\" )\n            continue;\n        if( removeSingleTile && layer.singleTile) {\n          layer.addOptions({singleTile:false, tileSize: replaceSingleTileSize});\n        } else if( !removeSingleTile && !layer.singleTile) {\n          replaceSingleTileSize.h = parseInt(replaceSingleTileSize.h * layer.ratio, 10);\n          replaceSingleTileSize.w = parseInt(replaceSingleTileSize.w * layer.ratio, 10);\n          layer.addOptions({singleTile:true, tileSize: replaceSingleTileSize});\n        }\n    }\n\n    var center = map.getCenter();\n    map.updateSize();\n    map.setCenter(center);\n    map.baseLayer.redraw();\n\n    updateMiniDockSize();\n  }\n\n  /**\n   * PRIVATE function: updateMiniDockSize\n   * update the minidock size\n   */\n  function updateMiniDockSize() {\n      if ( $('#mini-dock .tab-pane:visible').length == 0 )\n        return 0;\n      // the mini-dock menu-content visible\n      var mdmcv = $('#mini-dock .tab-pane:visible h3 ~ .menu-content:first');\n      mdmcv.css( 'max-height', '100%' )\n      var h = $('#mini-dock').height();\n      h -= $('#mini-dock .tab-pane:visible h3').height();\n      h -= (parseInt(mdmcv.css('margin-top')) ? parseInt(mdmcv.css('margin-top')) : 0 ) ;\n      h -= (parseInt(mdmcv.css('margin-bottom')) ? parseInt(mdmcv.css('margin-bottom')) : 0 ) ;\n      h -= (parseInt(mdmcv.css('padding-top')) ? parseInt(mdmcv.css('padding-top')) : 0 ) ;\n      h -= (parseInt(mdmcv.css('padding-bottom')) ? parseInt(mdmcv.css('padding-bottom')) : 0 ) ;\n\n      mdmcv.css( 'max-height', h ).css('overflow-x', 'hidden').css('overflow-y', 'auto');\n  }\n\n  /**\n   * PRIVATE function: getLayerLegendGraphicUrl\n   * get the layer legend graphic\n   *\n   * Parameters:\n   * name - {text} the layer name\n   * withScale - {boolean} url with scale parameter\n   *\n   * Dependencies:\n   * lizUrls.wms\n   *\n   * Returns:\n   * {text} the url\n   */\n  function getLayerLegendGraphicUrl(name, withScale) {\n    var layer = null\n    $.each(layers,function(i,l) {\n      if (layer == null && l.name == name)\n        layer = l;\n    });\n    if (layer == null )\n      return null;\n    var qgisName = null;\n    if ( name in cleanNameMap )\n        qgisName = getLayerNameByCleanName(name);\n    var layerConfig = null;\n    if ( qgisName )\n        layerConfig = config.layers[qgisName];\n    if ( !layerConfig )\n        layerConfig = config.layers[layer.params['LAYERS']];\n    if ( !layerConfig )\n        layerConfig = config.layers[layer.name];\n    if ( !layerConfig )\n        return null;\n    if ( 'externalWmsToggle' in layerConfig && layerConfig.externalWmsToggle == 'True'\n      && 'externalAccess' in layerConfig && layerConfig.externalAccess\n      && 'layers' in layerConfig.externalAccess && 'url' in layerConfig.externalAccess) {\n        var externalAccess = layerConfig.externalAccess;\n        var legendParams = {SERVICE: \"WMS\",\n                      VERSION: \"1.3.0\",\n                      REQUEST: \"GetLegendGraphic\",\n                      LAYER: externalAccess.layers,\n                      STYLE: externalAccess.styles,\n                      SLD_VERSION: \"1.1.0\",\n                      EXCEPTIONS: \"application/vnd.ogc.se_inimage\",\n                      FORMAT: \"image/png\",\n                      TRANSPARENT: \"TRUE\",\n                      WIDTH: 150,\n                      DPI: 96};\n\n        var legendParamsString = OpenLayers.Util.getParameterString(\n             legendParams\n            );\n        return OpenLayers.Util.urlAppend(externalAccess.url, legendParamsString);\n    }\n    var legendParams = {SERVICE: \"WMS\",\n                  VERSION: \"1.3.0\",\n                  REQUEST: \"GetLegendGraphic\",\n                  LAYER: layer.params['LAYERS'],\n                  STYLE: layer.params['STYLES'],\n                  EXCEPTIONS: \"application/vnd.ogc.se_inimage\",\n                  FORMAT: \"image/png\",\n                  TRANSPARENT: \"TRUE\",\n                  WIDTH: 150,\n                  LAYERFONTSIZE: 9,\n                  ITEMFONTSIZE: 9,\n                  SYMBOLSPACE: 1,\n                  ICONLABELSPACE: 2,\n                  DPI: 96,\n                  RULELABEL:\"AUTO\"\n                };\n    if (layerConfig.id==layerConfig.name)\n      legendParams['LAYERFONTBOLD'] = \"TRUE\";\n    else {\n      legendParams['LAYERFONTSIZE'] = 0;\n      legendParams['LAYERSPACE'] = 0;\n      legendParams['LAYERFONTBOLD'] = \"FALSE\";\n      legendParams['LAYERTITLE'] = \"FALSE\";\n    }\n    if (withScale)\n      legendParams['SCALE'] = map.getScale();\n    var legendParamsString = OpenLayers.Util.getParameterString(\n         legendParams\n        );\n    var service = OpenLayers.Util.urlAppend(lizUrls.wms\n        ,OpenLayers.Util.getParameterString(lizUrls.params)\n    );\n    return OpenLayers.Util.urlAppend(service, legendParamsString);\n  }\n\n  /**\n   * PRIVATE function: getLayerScale\n   * get the layer scales based on children layer\n   *\n   * Parameters:\n   * nested - {Object} a capability layer\n   * minScale - {Float} the nested min scale\n   * maxScale - {Float} the nested max scale\n   *\n   * Dependencies:\n   * config\n   *\n   * Returns:\n   * {Object} the min and max scales\n   */\n  function getLayerScale(nested,minScale,maxScale) {\n    for (var i = 0, len = nested.nestedLayers.length; i<len; i++) {\n      var layer = nested.nestedLayers[i];\n      var qgisLayerName = layer.name;\n      if ( 'useLayerIDs' in config.options && config.options.useLayerIDs == 'True' )\n        qgisLayerName = layerIdMap[layer.name];\n      else if ( layer.name in shortNameMap )\n        qgisLayerName = shortNameMap[layer.name];\n      var layerConfig = config.layers[qgisLayerName];\n      if (layer.nestedLayers.length != 0)\n         return getLayerScale(layer,minScale,maxScale);\n      if (layerConfig) {\n        if (minScale == null)\n          minScale=layerConfig.minScale;\n        else if (layerConfig.minScale<minScale)\n          minScale=layerConfig.minScale;\n        if (maxScale == null)\n          maxScale=layerConfig.maxScale;\n        else if (layerConfig.maxScale>maxScale)\n          maxScale=layerConfig.maxScale;\n      }\n    }\n    if ( minScale < 1 )\n      minScale = 1;\n    return {minScale:minScale,maxScale:maxScale};\n  }\n\n  /**\n   * PRIVATE function: getLayerOrder\n   * get the layer order and calculate it if it's a QGIS group\n   *\n   * Parameters:\n   * nested - {Object} a capability layer\n   *\n   * Dependencies:\n   * config\n   *\n   * Returns:\n   * {Integer} the layer's order\n   */\n  function getLayerOrder(nested) {\n    // there is no layersOrder in the project\n    if (!('layersOrder' in config))\n      return -1;\n\n    // the nested is a layer and not a group\n    if (nested.nestedLayers.length == 0) {\n      var qgisLayerName = nested.name;\n      if ( 'useLayerIDs' in config.options && config.options.useLayerIDs == 'True' )\n        qgisLayerName = layerIdMap[nested.name];\n      else if ( nested.name in shortNameMap )\n        qgisLayerName = shortNameMap[nested.name];\n      if (qgisLayerName in config.layersOrder)\n        return config.layersOrder[nested.name];\n      else\n        return -1;\n    }\n\n    // the nested is a group\n    var order = -1;\n    for (var i = 0, len = nested.nestedLayers.length; i<len; i++) {\n      var layer = nested.nestedLayers[i];\n      var qgisLayerName = layer.name;\n      if ( 'useLayerIDs' in config.options && config.options.useLayerIDs == 'True' )\n        qgisLayerName = layerIdMap[layer.name];\n      else if ( layer.name in shortNameMap )\n        qgisLayerName = shortNameMap[layer.name];\n      var lOrder = -1;\n      if (layer.nestedLayers.length != 0)\n        lOrder = getLayerScale(layer);\n      else if (qgisLayerName in config.layersOrder)\n        lOrder = config.layersOrder[qgisLayerName];\n      else\n        lOrder = -1;\n      if (lOrder != -1) {\n        if (order == -1 || lOrder < order)\n          order = lOrder;\n      }\n    }\n    return order;\n  }\n\n  function beforeLayerTreeCreated() {\n     if (\n       (('osmMapnik' in config.options)\n        && config.options.osmMapnik == 'True') ||\n       (('osmStamenToner' in config.options)\n        && config.options.osmStamenToner == 'True') ||\n       (('osmCyclemap' in config.options)\n        && config.options.osmCyclemap == 'True'\n        && ('OCMKey' in config.options)) ||\n       (('googleStreets' in config.options)\n        && config.options.googleStreets == 'True') ||\n       (('googleSatellite' in config.options)\n        && config.options.googleSatellite == 'True') ||\n       (('googleHybrid' in config.options)\n        && config.options.googleHybrid == 'True') ||\n       (('googleTerrain' in config.options)\n        && config.options.googleTerrain == 'True') ||\n       (('bingStreets' in config.options)\n        && config.options.bingStreets == 'True'\n        && ('bingKey' in config.options)) ||\n       (('bingSatellite' in config.options)\n        && config.options.bingSatellite == 'True'\n        && ('bingKey' in config.options)) ||\n       (('bingHybrid' in config.options)\n        && config.options.bingHybrid == 'True'\n        && ('bingKey' in config.options)) ||\n       (('ignTerrain' in config.options)\n        && config.options.ignTerrain == 'True') ||\n       (('ignStreets' in config.options)\n        && config.options.ignStreets == 'True') ||\n       (('ignSatellite' in config.options)\n        && config.options.ignSatellite == 'True') ||\n       (('ignCadastral' in config.options)\n        && config.options.ignCadastral == 'True')\n       ) {\n         Proj4js.defs['EPSG:3857'] = Proj4js.defs['EPSG:900913'];\n\n         var proj = config.options.projection;\n         if ( !(proj.ref in Proj4js.defs) )\n           Proj4js.defs[proj.ref]=proj.proj4;\n         var projection = new OpenLayers.Projection(proj.ref);\n\n         var projOSM = new OpenLayers.Projection('EPSG:3857');\n         proj.ref = 'EPSG:3857';\n         proj.proj4 = Proj4js.defs['EPSG:3857'];\n\n         // Transform the bbox\n         var bbox = config.options.bbox;\n         var extent = new OpenLayers.Bounds(Number(bbox[0]),Number(bbox[1]),Number(bbox[2]),Number(bbox[3]));\n         extent = extent.transform(projection,projOSM);\n         bbox = extent.toArray();\n\n         var scales = [];\n         if ('mapScales' in config.options)\n           scales = config.options.mapScales;\n         if ( scales.length == 0 )\n           scales = [config.options.maxScale,config.options.minScale];\n\n         config.options.projection = proj;\n         config.options.bbox = bbox;\n         config.options.zoomLevelNumber = 16;\n\n         // Transform the initial bbox\n         if ( 'initialExtent' in config.options && config.options.initialExtent.length == 4 ) {\n           var initBbox = config.options.initialExtent;\n           var initialExtent = new OpenLayers.Bounds(Number(initBbox[0]),Number(initBbox[1]),Number(initBbox[2]),Number(initBbox[3]));\n           initialExtent = initialExtent.transform(projection,projOSM);\n           config.options.initialExtent = initialExtent.toArray();\n         }\n\n         // Specify zoom level number\n         if (\n             (('osmMapnik' in config.options) && config.options.osmMapnik == 'True') ||\n             (('osmStamenToner' in config.options) && config.options.osmStamenToner == 'True') ||\n             (('osmCyclemap' in config.options) && config.options.osmCyclemap == 'True' && ('OCMKey' in config.options)) ||\n             (('bingStreets' in config.options) && config.options.bingStreets == 'True' && ('bingKey' in config.options)) ||\n             (('bingSatellite' in config.options) && config.options.bingSatellite == 'True' && ('bingKey' in config.options)) ||\n             (('bingHybrid' in config.options) && config.options.bingHybrid == 'True' && ('bingKey' in config.options)) ||\n             (('ignTerrain' in config.options) && config.options.ignTerrain == 'True') ||\n             (('ignStreets' in config.options) && config.options.ignStreets == 'True')) {\n           config.options.zoomLevelNumber = 23;\n         }\n         if ((('googleStreets' in config.options) && config.options.googleStreets == 'True') ||\n             (('googleHybrid' in config.options) && config.options.googleHybrid == 'True') ||\n             (('ignCadastral' in config.options) && config.options.ignCadastral == 'True')) {\n           config.options.zoomLevelNumber = 20;\n         }\n         if ( 'googleSatellite' in config.options && config.options.googleSatellite == 'True'){\n           config.options.zoomLevelNumber = 21;\n         }\n         if ( 'ignSatellite' in config.options && config.options.ignSatellite == 'True' ) {\n           config.options.zoomLevelNumber = 22;\n         }\n         config.options.maxScale = 591659030.3224756;\n         config.options.minScale = 2257.0000851534865;\n         var hasBaselayers = (('emptyBaselayer' in config.options) && config.options.emptyBaselayer == \"True\");\n         if ( !hasBaselayers ) {\n           for ( var l in config.layers ) {\n             if ( config.layers[l][\"baseLayer\"] == \"True\" ) {\n               hasBaselayers = true;\n               break;\n             }\n           }\n         }\n         // for minRes evaluating to scale 100\n         // zoomLevelNumber is equal to 24\n         if ( hasBaselayers ) {\n           config.options.zoomLevelNumber = 24;\n         }\n\n         var resolutions = [];\n         if (scales.length != 0 ) {\n           scales.sort(function(a, b) {\n             return Number(b) - Number(a);\n           });\n           var maxScale = scales[0];\n           var maxRes = OpenLayers.Util.getResolutionFromScale(maxScale, projOSM.proj.units);\n           var minScale = scales[scales.length-1];\n           var minRes = OpenLayers.Util.getResolutionFromScale(minScale, projOSM.proj.units);\n           var res = 156543.03390625;\n           var n = 1;\n           while ( res > minRes && n < config.options.zoomLevelNumber) {\n             if ( res < maxRes ) {\n               //Add extra scale\n               resolutions.push(res);\n             }\n             res = res/2;\n             n++;\n           }\n           maxRes = resolutions[0];\n           minRes = resolutions[resolutions.length-1];\n           //Add extra scale\n           var maxScale = OpenLayers.Util.getScaleFromResolution(maxRes, projOSM.proj.units);\n           var minScale = OpenLayers.Util.getScaleFromResolution(minRes, projOSM.proj.units);\n         }\n         config.options['resolutions'] = resolutions;\n\n         if (resolutions.length != 0 ) {\n           config.options.zoomLevelNumber = resolutions.length;\n           config.options.maxScale = maxScale;\n           config.options.minScale = minScale;\n         }\n         return true;\n      }\n      return false;\n  }\n\n  /**\n   * PRIVATE function: getLayerTree\n   * get the layer tree\n   * create OpenLayers WMS base or not layer {<OpenLayers.Layer.WMS>}\n   * push these layers in layers or baselayers\n   *\n   * Parameters:\n   * nested - {Object} a capability layer\n   * pNode - {Object} the nested tree node\n   *\n   * Dependencies:\n   * config\n   * layers\n   * baselayers\n   */\n  function getLayerTree(nested,pNode) {\n    pNode.children = [];\n\n    var service = OpenLayers.Util.urlAppend(lizUrls.wms\n      ,OpenLayers.Util.getParameterString(lizUrls.params)\n    );\n    if (lizUrls.publicUrlList && lizUrls.publicUrlList.length > 1 ) {\n        service = [];\n        for (var j=0, jlen=lizUrls.publicUrlList.length; j<jlen; j++) {\n          service.push(\n            OpenLayers.Util.urlAppend(\n              lizUrls.publicUrlList[j],\n              OpenLayers.Util.getParameterString(lizUrls.params)\n            )\n          );\n        }\n    }\n\n    var wmtsFormat = new OpenLayers.Format.WMTSCapabilities({});\n\n    for (var i = 0, len = nested.nestedLayers.length; i<len; i++) {\n      var serviceUrl = service\n      var layer = nested.nestedLayers[i];\n      var qgisLayerName = layer.name;\n      if ( ('useLayerIDs' in config.options) && config.options.useLayerIDs == 'True' )\n        qgisLayerName = layerIdMap[layer.name];\n      else if ( layer.name in shortNameMap )\n        qgisLayerName = shortNameMap[layer.name];\n      // The found name is not in config\n      if (!(qgisLayerName in config.layers)) {\n        continue;\n      }\n      var layerConfig = config.layers[qgisLayerName];\n      var layerName = cleanName(qgisLayerName);\n      layerCleanNames[layerName] = qgisLayerName;\n\n      if ( qgisLayerName.toLowerCase() == 'hidden' )\n        continue;\n      if ( qgisLayerName == 'Overview' ) {\n        config.options.hasOverview = true;\n        continue;\n      }\n      if ( !layerConfig )\n        continue;\n\n      if ( layerConfig.groupAsLayer == 'True' )\n        layerConfig.type = 'layer';\n\n      var wmsStyles = $.map(layer.styles, function(s){\n          return s.name;\n      });\n      if ( wmsStyles.length != 0 ) {\n          layerConfig.styles = wmsStyles;\n      } else if ( 'qgisServerVersion' in config.options && config.options.qgisServerVersion.startsWith('3.') ) {\n          layerConfig.styles = [''];\n      } else {\n          layerConfig.styles = ['default'];\n      }\n      // if the layer is not the Overview and had a config\n      // creating the {<OpenLayers.Layer.WMS>} and the tree node\n      var node = {name:layerName,config:layerConfig,parent:pNode};\n      var styles = ('styles' in layerConfig) ? layerConfig.styles[0] : 'default' ;\n      if( !( typeof lizLayerStyles === 'undefined' )\n        && layerName in lizLayerStyles\n        && lizLayerStyles[ layerName ]\n      ){\n        styles = lizLayerStyles[ layerName ];\n      }\n      var layerWmsParams = {\n          layers:layer.name\n          ,styles: styles\n          ,version:'1.3.0'\n          ,exceptions:'application/vnd.ogc.se_inimage'\n          ,format:(layerConfig.imageFormat) ? layerConfig.imageFormat : 'image/png'\n          ,dpi:96\n      };\n      if (layerWmsParams.format != 'image/jpeg')\n          layerWmsParams['transparent'] = true;\n\n      //Manage attribution\n      if (typeof layer.attribution == \"object\") {\n          // Update href if needed\n          if ( 'href' in layer.attribution &&\n               layer.attribution.href != '' &&\n               layer.attribution.href.indexOf('://') == -1) {\n            layer.attribution.href = 'http://'+layer.attribution.href;\n          }\n          // Update attribution\n          if ( !('title' in layer.attribution) || layer.attribution.title == '' ) {\n              layer.attribution.title = layer.attribution.href.split('://')[1];\n          } else\n          if ( !('href' in layer.attribution) || layer.attribution.href == '' ) {\n              layer.attribution = layer.attribution.title;\n          }\n      }\n\n      var wmtsLayer = null;\n      if ( layerConfig.cached == 'True' && wmtsCapabilities ) {\n          $.each(wmtsCapabilities.contents.layers, function(i, l) {\n            if ( l.identifier != layer.name)\n              return true;\n            var wmtsOptions = {\n                layer: layer.name,\n                matrixSet: config.options.projection.ref,\n                name: layerName,\n                params: layerWmsParams,\n                attribution:layer.attribution,\n                isBaseLayer: (layerConfig.baseLayer == 'True'),\n                alwaysInRange: false,\n                url: serviceUrl\n            };\n            if ( $.inArray( config.options.projection.ref.toUpperCase(), ['EPSG:3857','EPSG:900913'] ) != -1\n              && ('resolutions' in config.options)\n              && config.options.resolutions.length != 0 ) {\n                var resolutions = config.options.resolutions;\n                var maxRes = resolutions[0];\n                var numZoomLevels = resolutions.length;\n                var zoomOffset = 0;\n                var res = 156543.03390625;\n                while ( res > maxRes ) {\n                    zoomOffset += 1;\n                    res = 156543.03390625 / Math.pow(2, zoomOffset);\n                }\n                wmtsOptions['zoomOffset'] = zoomOffset;\n                wmtsOptions['maxResolution'] = maxRes;\n                wmtsOptions['numZoomLevels'] = numZoomLevels;\n                wmtsOptions['minZoomLevel'] = zoomOffset;\n                wmtsOptions['resolutions'] = resolutions;\n            }\n            wmtsLayer = wmtsFormat.createLayer(wmtsCapabilities, wmtsOptions);\n            wmtsLayer.yx = {};\n            wmtsLayer.reverseAxisOrder = function() {\n                var projCode = this.projection.getCode();\n                return parseFloat('1.3.0') >= 1.3 &&\n                    !!(this.yx[projCode] || (OpenLayers.Projection.defaults[projCode] &&\n                    OpenLayers.Projection.defaults[projCode].yx));\n            };\n            return false;\n          });\n      }\n\n      // Override WMS url if external WMS server\n      var extConfig = null;\n      if ('externalAccess' in layerConfig && layerConfig.externalAccess\n       && 'layers' in layerConfig.externalAccess && 'url' in layerConfig.externalAccess ) {\n          extConfig = layerConfig.externalAccess;\n          extConfig.layers = decodeURI(extConfig.layers);\n          serviceUrl = extConfig.url;\n          layerWmsParams = {\n            layers: extConfig.layers\n            ,styles:(extConfig.styles) ? extConfig.styles : ''\n            ,crs:(extConfig.crs) ? extConfig.crs : 'EPSG:3857'\n            ,format:(extConfig.format) ? extConfig.format : 'image/png'\n            ,transparent:(extConfig.transparent) ? extConfig.transparent : 'true'\n            ,exceptions:'application/vnd.ogc.se_inimage'\n          }\n      }\n\n        // Add optional filter at start\n        if( !( typeof lizLayerFilter === 'undefined' )\n          && qgisLayerName in lizLayerFilter\n          && lizLayerFilter[ qgisLayerName ]\n        ){\n          layerWmsParams['FILTER'] = qgisLayerName+':'+lizLayerFilter[ qgisLayerName ];\n        }\n\n      if (layerConfig.baseLayer == 'True' && wmtsLayer != null) {\n          // creating the base layer\n          baselayers.push( wmtsLayer );\n      }\n      else if (layerConfig.type == 'layer' && wmtsLayer != null) {\n          wmtsLayer.options.minScale = layerConfig.maxScale;\n          wmtsLayer.options.maxScale =(layerConfig.minScale != null && layerConfig.minScale < 1) ? 1 : layerConfig.minScale;\n          if ( layer.nestedLayers.length != 0 ) {\n              var scales = getLayerScale(layer,null,null);\n              wmtsLayer.options.minScale = scales.maxScale;\n              wmtsLayer.options.maxScale = scales.minScale;\n          }\n          wmtsLayer.isVisible = (layerConfig.toggled=='True');\n          wmtsLayer.visibility = false;\n          wmtsLayer.transitionEffect = null;\n          wmtsLayer.removeBackBufferDelay = 250;\n          wmtsLayer.order = getLayerOrder(layer);\n          layers.push( wmtsLayer );\n      }\n      else if (layerConfig.baseLayer == 'True') {\n        // creating the base layer\n          baselayers.push(new OpenLayers.Layer.WMS(layerName,serviceUrl\n              ,layerWmsParams\n              ,{isBaseLayer:true\n               ,gutter:(layerConfig.cached == 'True') ? 0 : 5\n               ,buffer:0\n               ,singleTile:(layerConfig.singleTile == 'True')\n               ,ratio:1\n               ,attribution:layer.attribution\n              }));\n      }\n      else if (layerConfig.type == 'layer') {\n          var wmsLayer = new OpenLayers.Layer.WMS(layerName,serviceUrl\n              ,layerWmsParams\n              ,{isBaseLayer:false\n               ,minScale:layerConfig.maxScale\n               ,maxScale:(layerConfig.minScale != null && layerConfig.minScale < 1) ? 1 : layerConfig.minScale\n               ,isVisible:(layerConfig.toggled=='True')\n               ,visibility:false\n               ,gutter:(layerConfig.cached == 'True') ? 0 : 5\n               ,buffer:0\n               ,transitionEffect:(layerConfig.singleTile == 'True')?'resize':null\n               ,removeBackBufferDelay:250\n               ,singleTile:(layerConfig.singleTile == 'True' || (layerConfig.cached == 'True' && !wmtsCapabilities))\n               ,ratio:1\n               ,order:getLayerOrder(layer)\n               ,attribution:layer.attribution\n              });\n          if ( layer.nestedLayers.length != 0 ) {\n              var scales = getLayerScale(layer,null,null);\n              wmsLayer.minScale = scales.maxScale;\n              wmsLayer.options.minScale = scales.maxScale;\n              wmsLayer.maxScale = scales.minScale;\n              wmsLayer.options.maxScale = scales.minScale;\n          }\n          // External WMS layers - respect the image format of the WMS source layer\n          // We do not want to respect the configuration layerConfig.imageFormat\n          // to avoid requesting a format not compatible with the external WMS server\n          // Fix the jpeg WMS layers requesting png\n          if (extConfig && 'format' in layerWmsParams && 'params' in wmsLayer\n              && wmsLayer.params['FORMAT'] != layerWmsParams.format) {\n              wmsLayer.params['FORMAT'] = layerWmsParams.format;\n          }\n          layers.push( wmsLayer );\n      }\n      // creating the layer tree because it's a group, has children and is not a base layer\n      if (layerConfig.type == 'group' && layer.nestedLayers.length != 0 && layerConfig.baseLayer == 'False')\n          getLayerTree(layer,node);\n      if (layerConfig.baseLayer != 'True')\n          pNode.children.push(node);\n\n      // Add bbox from WMS data into lizmap configuration (used by switcher-layers-actions\n      layerConfig.bbox = layer.bbox;\n\n    }\n  }\n\n  /**\n   * PRIVATE function: analyseNode\n   * analyse Node Config\n   * define if the node has to be a child of his parent node\n   *\n   * Parameters:\n   * aNode - {Object} a node config\n   *\n   * Returns:\n   * {Boolean} maintains the node in the tree\n   */\n  function analyseNode(aNode) {\n    var nodeConfig = aNode.config;\n    if (nodeConfig.type == 'layer' && nodeConfig.baseLayer != 'True')\n      return true;\n    else if (nodeConfig.type == 'layer')\n      return false;\n\n    if (!('children' in aNode))\n      return false;\n    var children = aNode.children;\n    var result = false;\n    var removeIdx = [];\n    for (var i=0, len=children.length; i<len; i++) {\n      var child = children[i];\n      var analyse = analyseNode(child);\n      if (!analyse)\n        removeIdx.push(i);\n      result = (result || analyse);\n    }\n    removeIdx.reverse();\n    for (var i=0, len=removeIdx.length; i<len; i++) {\n      children.splice(removeIdx[i],1);\n    }\n    return result;\n  }\n\n  /**\n   * PRIVATE function: getSwitcherLine\n   * get the html table line <tr> of a config node for the switcher\n   *\n   * Parameters:\n   * aNode - {Object} a config node\n   *\n   * Returns:\n   * {String} the <tr> html corresponding to the node\n   */\n  function getSwitcherLine(aNode, aParent) {\n    var html = '';\n    var nodeConfig = aNode.config;\n    var parentConfig = null;\n\n    if( aParent ){\n      parentConfig = aParent.config;\n    }\n\n    if( 'geometryType' in nodeConfig &&\n        ( nodeConfig.geometryType == \"none\" || nodeConfig.geometryType == \"unknown\" || nodeConfig.geometryType == \"\" )\n    ){\n      nodeConfig.displayInLegend = 'False';\n    }\n\n    html += '<tr id=\"'+nodeConfig.type+'-'+aNode.name+'\"';\n    html += ' class=\"liz-'+nodeConfig.type;\n    if (aParent){\n      html += ' child-of-group-'+aParent.name;\n    }\n    if (('children' in aNode) && aNode['children'].length!=0){\n      html += ' expanded parent';\n    }\n    if (('displayInLegend' in nodeConfig && nodeConfig.displayInLegend == 'False') ||\n        (parentConfig && 'displayInLegend' in parentConfig && parentConfig.displayInLegend == 'False')){\n      html += ' liz-hidden';\n    }\n    if ( parentConfig && 'mutuallyExclusive' in parentConfig && parentConfig.mutuallyExclusive == 'True' ){\n      html += ' mutually-exclusive';\n    }\n\n    html += '\">';\n\n    function truncateWithEllipsis(str,n){\n      return (str.length > n) ? str.substr(0,n-1)+'&hellip;' : str;\n    }\n\n    html += '<td><button class=\"btn checkbox\" name=\"'+nodeConfig.type+'\" value=\"'+aNode.name+'\" title=\"'+lizDict['tree.button.checkbox']+'\"></button>';\n    html += '<span class=\"label\" title=\"'+truncateWithEllipsis($('<div>'+nodeConfig.abstract+'</div>').text(),50)+'\">'+nodeConfig.title+'</span>';\n    html += '</td>';\n\n    html += '<td class=\"loading\">';\n    if (nodeConfig.type == 'layer'){\n      html += '<span class=\"loading\">&nbsp;</span>';\n    }\n    html += '</td>';\n\n    var legendLink = '';\n    if (nodeConfig.link){\n      legendLink = nodeConfig.link;\n    }\n    if (legendLink != '' ){\n      html += '<td><button class=\"btn link\" name=\"link\" title=\"'+lizDict['tree.button.link']+'\" value=\"'+legendLink+'\"/></td>';\n    }\n    else{\n      html += '<td></td>';\n    }\n\n    if (nodeConfig.cached && nodeConfig.cached == 'True' && nodeConfig.type == 'layer' && ('removeCache' in config.options)){\n      html += '<td><button class=\"btn removeCache\" name=\"removeCache\" title=\"'+lizDict['tree.button.removeCache']+'\" value=\"'+aNode.name+'\"/></td>';\n    }\n    else{\n      html += '<td></td>';\n    }\n\n    html += '</tr>';\n\n    if (nodeConfig.type == 'layer'\n    && (!nodeConfig.noLegendImage || nodeConfig.noLegendImage != 'True')\n    && ('displayInLegend' in nodeConfig && nodeConfig.displayInLegend == 'True')) {\n      var url = getLayerLegendGraphicUrl(aNode.name, false);\n      if ( url != null && url != '' ) {\n        html += '<tr id=\"legend-'+aNode.name+'\" class=\"child-of-layer-'+aNode.name+' legendGraphics\">';\n        html += '<td colspan=\"2\"><div class=\"legendGraphics\">';\n        html += '<img data-src=\"'+url+'\" src=\"'+lizUrls.basepath + 'assets/css/images/download_layer.gif' + '\"/>';\n        html += '</div></td>';\n        html += '</tr>';\n      }\n    }\n\n    return html;\n  }\n\n  /**\n   * PRIVATE function: getSwitcherNode\n   * get the html of a config node for the switcher\n   *\n   * Parameters:\n   * aNode - {Object} a config node\n   *\n   * Returns:\n   * {String} the html corresponding to the node\n   */\n  function getSwitcherNode(aNode,aLevel) {\n    var html = '';\n    if (aLevel == 0) {\n      html += '<div class=\"without-blocks no-group\">';\n      html += '<table class=\"tree\">';\n    }\n\n    var children = aNode.children;\n    for (var i=0, len=children.length; i<len; i++) {\n      var child = children[i];\n      if (aLevel == 0)\n        html += getSwitcherLine(child);\n      else\n        html += getSwitcherLine(child,aNode);\n\n      if (('children' in child) && child['children'].length!=0)\n        html += getSwitcherNode(child, aLevel+1);\n    }\n\n    if (aLevel == 0) {\n      html += '</table>';\n      html += '</div>';\n    }\n    return html;\n  }\n\n  function initProjections(firstLayer) {\n    // Insert or update projection list\n    if ( lizProj4 ) {\n        for( var ref in lizProj4 ) {\n            if ( !(ref in Proj4js.defs) ) {\n              Proj4js.defs[ref]=lizProj4[ref];\n          }\n        }\n    }\n\n    // get and define projection\n    var proj = config.options.projection;\n    if ( !(proj.ref in Proj4js.defs) )\n      Proj4js.defs[proj.ref]=proj.proj4;\n    var projection = new OpenLayers.Projection(proj.ref);\n\n    if ( !(proj.ref in OpenLayers.Projection.defaults) ) {\n        OpenLayers.Projection.defaults[proj.ref] = projection;\n\n        // test extent for inverted axis\n        if ( proj.ref in firstLayer.bbox ) {\n            var wmsBbox = firstLayer.bbox[proj.ref].bbox;\n            var wmsBounds = OpenLayers.Bounds.fromArray( wmsBbox );\n            var initBounds = OpenLayers.Bounds.fromArray( config.options.initialExtent );\n            if ( !initBounds.intersectsBounds( wmsBounds ) )\n                OpenLayers.Projection.defaults[proj.ref].yx = true;\n        }\n    }\n  }\n\n  /**\n   * PRIVATE function: createMap\n   * creating the map {<OpenLayers.Map>}\n   */\n  function createMap() {\n    // get projection\n    var proj = config.options.projection;\n    var projection = new OpenLayers.Projection(proj.ref);\n\n    // get and define the max extent\n    var bbox = config.options.bbox;\n    var extent = new OpenLayers.Bounds(Number(bbox[0]),Number(bbox[1]),Number(bbox[2]),Number(bbox[3]));\n\n    var restrictedExtent = extent.scale(3);\n    var initialExtent = extent.clone();\n    if ( 'initialExtent' in config.options && config.options.initialExtent.length == 4 ) {\n      var initBbox = config.options.initialExtent;\n      initialExtent = new OpenLayers.Bounds(Number(initBbox[0]),Number(initBbox[1]),Number(initBbox[2]),Number(initBbox[3]));\n    }\n\n    // calculate the map height\n    var mapHeight = $('body').parent()[0].clientHeight;\n    if(!mapHeight)\n        mapHeight = $('window').innerHeight();\n    mapHeight = mapHeight - $('#header').height();\n    mapHeight = mapHeight - $('#headermenu').height();\n    $('#map').height(mapHeight);\n\n    // Make sure interface divs size are updated before creating the map\n    // This avoid the request of each singlettile layer 2 times on startup\n    updateContentSize();\n\n    var scales = [];\n    var resolutions = [];\n    if ('resolutions' in config.options)\n      resolutions = config.options.resolutions;\n    else if ('mapScales' in config.options)\n      scales = config.options.mapScales;\n    scales.sort(function(a, b) {\n      return Number(b) - Number(a);\n    });\n    // remove duplicate scales\n    var nScales = [];\n    while (scales.length != 0){\n      var scale = scales.pop(0);\n      if ($.inArray( scale, nScales ) == -1 )\n        nScales.push( scale );\n    }\n    scales = nScales;\n\n\n    // creating the map\n    OpenLayers.Util.IMAGE_RELOAD_ATTEMPTS = 3; // Avoid some issues with tiles not displayed\n    OpenLayers.IMAGE_RELOAD_ATTEMPTS = 3;\n    OpenLayers.Util.DEFAULT_PRECISION=20; // default is 14 : change needed to avoid rounding problem with cache\n\n    map = new OpenLayers.Map('map'\n      ,{\n        controls:[\n          new OpenLayers.Control.Navigation({mouseWheelOptions: {interval: 100}})\n        ]\n        ,tileManager: null // prevent bug with OL 2.13 : white tiles on panning back\n        ,eventListeners:{\n         zoomend: function(){\n  // private treeTable\n  var options = {\n    childPrefix : \"child-of-\"\n  };\n\n  function childrenOf(node) {\n    return $(node).siblings(\"tr.\" + options.childPrefix + node[0].id);\n  }\n\n  function parentOf(node) {\n    if (node.length == 0 )\n      return null;\n\n    var classNames = node[0].className.split(' ');\n\n    for(var key=0; key<classNames.length; key++) {\n      if(classNames[key].match(options.childPrefix)) {\n        return $(node).siblings(\"#\" + classNames[key].substring(options.childPrefix.length));\n      }\n    }\n\n    return null;\n  }\n\n  function ancestorsOf(node) {\n    var ancestors = [];\n    while(node = parentOf(node)) {\n      ancestors[ancestors.length] = node[0];\n    }\n    return ancestors;\n  }\n           //layer visibility\n           for (var i=0,len=layers.length; i<len; i++) {\n             var layer = layers[i];\n             var b = $('#switcher button[name=\"layer\"][value=\"'+layer.name+'\"]').first();\n\n             if (layer.inRange && b.hasClass('disabled')) {\n               var tr = b.parents('tr').first();\n               tr.removeClass('disabled').find('button').removeClass('disabled');\n               var ancestors = ancestorsOf(tr);\n               $.each(ancestors,function(i,a) {\n                 $(a).removeClass('disabled').find('button').removeClass('disabled');\n               });\n               if (tr.find('button[name=\"layer\"]').hasClass('checked'))\n                 layer.setVisibility(true);\n             } else if (!layer.inRange && !b.hasClass('disabled')) {\n               var tr = b.parents('tr').first();\n               tr.addClass('disabled').find('button').addClass('disabled');\n               if (tr.hasClass('liz-layer'))\n                 tr.collapse();\n               var ancestors = ancestorsOf(tr);\n               $.each(ancestors,function(i,a) {\n                    a = $(a);\n                    var count = 0;\n                    var checked = 0;\n                    var aDesc = childrenOf(a);\n                    $.each(aDesc,function(j,trd) {\n                      $(trd).find('button.checkbox').each(function(i,b){\n                        if ($(b).hasClass('disabled'))\n                          checked++;\n                        count++;\n                      });\n                    });\n                 if (count == checked)\n                   a.addClass('disabled').find('button').addClass('disabled');\n                 else\n                   a.removeClass('disabled').find('button').removeClass('disabled');\n               });\n             }\n           }\n\n           //pan button\n           $('#navbar button.pan').click();\n         }\n        }\n\n       ,maxExtent:extent\n       ,restrictedExtent: restrictedExtent\n       ,initialExtent:initialExtent\n       ,maxScale: scales.length == 0 ? config.options.minScale : \"auto\"\n       ,minScale: scales.length == 0 ? config.options.maxScale : \"auto\"\n       ,numZoomLevels: scales.length == 0 ? config.options.zoomLevelNumber : scales.length\n       ,scales: scales.length == 0 ? null : scales\n       ,resolutions: resolutions.length == 0 ? null : resolutions\n       ,projection:projection\n       ,units:projection.proj.units !== null ? projection.proj.units : \"degrees\"\n       ,allOverlays:(baselayers.length == 0)\n    });\n    map.addControl(new OpenLayers.Control.Attribution({div:document.getElementById('attribution')}));\n\n    // add handler to update the map size\n    window.addEventListener('resize', updateContentSize);\n  }\n\n  /**\n   * Get features for locate by layer tool\n   */\n  function updateLocateFeatureList(aName) {\n    var locate = config.locateByLayer[aName];\n    // clone features reference\n    var features = {};\n    for ( var fid in locate.features ) {\n        features[fid] = locate.features[fid];\n    }\n    // filter by filter field name\n    if ('filterFieldName' in locate) {\n        var filterValue = $('#locate-layer-'+cleanName(aName)+'-'+locate.filterFieldName).val();\n        if ( filterValue != '-1' ) {\n          for (var fid in features) {\n            var feat = features[fid];\n            if (feat.properties[locate.filterFieldName] != filterValue)\n              delete features[fid];\n          }\n        } else\n          features = {}\n    }\n    // filter by vector joins\n    if ( 'vectorjoins' in locate && locate.vectorjoins.length != 0 ) {\n        var vectorjoins = locate.vectorjoins;\n        for ( var i=0, len =vectorjoins.length; i< len; i++) {\n            var vectorjoin = vectorjoins[i];\n            var jName = vectorjoin.joinLayer;\n            if ( jName in config.locateByLayer ) {\n                var jLocate = config.locateByLayer[jName];\n                var jVal = $('#locate-layer-'+cleanName(jName)).val();\n                if ( jVal == '-1' ) continue;\n                var jFeat = jLocate.features[jVal];\n                for (var fid in features) {\n                  var feat = features[fid];\n                  if ( feat.properties[vectorjoin.targetFieldName] != jFeat.properties[vectorjoin.joinFieldName] )\n                    delete features[fid];\n                }\n            }\n        }\n    }\n    // create the option list\n    var options = '<option value=\"-1\"></option>';\n    for (var fid in features) {\n      var feat = features[fid];\n      options += '<option value=\"'+feat.id+'\">'+feat.properties[locate.fieldName]+'</option>';\n    }\n    // add option list\n    $('#locate-layer-'+cleanName(aName)).html(options);\n  }\n\n    function clearDrawLayer(layer_name) {\n      var layer = map.getLayersByName(layer_name);\n      if (layer.length == 0) {\n          return;\n      }\n      layer[0].destroyFeatures();\n    }\n\n  /**\n   * Zoom to locate feature\n   */\n  function zoomToLocateFeature(aName) {\n    // clean locate layer\n    clearDrawLayer('locatelayer');\n\n    // get locate by layer val\n    var locate = config.locateByLayer[aName];\n    var layerName = cleanName(aName);\n    var proj = new OpenLayers.Projection(locate.crs);\n    var val = $('#locate-layer-'+layerName).val();\n    if (val == '-1') {\n\n      // Trigger event\n      lizMap.events.triggerEvent('lizmaplocatefeaturecanceled',\n        {\n          'featureType': aName\n        }\n      );\n    } else {\n      // zoom to val\n      var feat = locate.features[val];\n      var format = new OpenLayers.Format.GeoJSON({\n          ignoreExtraDims: true\n      });\n      feat = format.read(feat)[0];\n\n      if( feat.geometry != null){\n        feat.geometry.transform(proj, map.getProjection());\n        // Show geometry if asked\n        if (locate.displayGeom == 'True') {\n            var layer = map.getLayersByName('locatelayer')[0];\n            if( typeof layer === 'undefined' )\n              return;\n            var getFeatureUrlData = getVectorLayerWfsUrl( aName, null, null, null );\n            getFeatureUrlData['options']['PROPERTYNAME'] = ['geometry',locate.fieldName].join(',');\n            getFeatureUrlData['options']['FEATUREID'] = val;\n            // Get data\n            $.post( getFeatureUrlData['url'], getFeatureUrlData['options'], function(data) {\n              if ( !data.features )\n                data = JSON.parse(data);\n              if( data.features.length != 0) {\n                feat = format.read(data.features[0])[0];\n                feat.geometry.transform(proj, map.getProjection());\n              }\n              layer.addFeatures([feat]);\n            }).fail(function(){\n              layer.addFeatures([feat]);\n            });\n        }\n        //zoom to extent\n        map.zoomToExtent(feat.geometry.getBounds());\n\n      }\n\n      var fid = val.split('.')[1];\n\n      // Trigger event\n      lizMap.events.triggerEvent('lizmaplocatefeaturechanged',\n        {\n          'featureType': aName,\n          'featureId': fid\n        }\n      );\n    }\n  }\n\n  /**\n   * Get features for locate by layer tool\n   */\n  function getLocateFeature(aName) {\n    var locate = config.locateByLayer[aName];\n\n    // get fields to retrieve\n    var fields = ['geometry',locate.fieldName];\n    // if a filter field is defined\n    if ('filterFieldName' in locate)\n      fields.push( locate.filterFieldName );\n    // check for join fields\n    if ( 'filterjoins' in locate ) {\n      var filterjoins = locate.filterjoins;\n      for ( var i=0, len=filterjoins.length; i<len; i++) {\n          var filterjoin = filterjoins[i];\n          fields.push( filterjoin.targetFieldName );\n      }\n    }\n    if ( 'vectorjoins' in locate ) {\n      var vectorjoins = locate.vectorjoins;\n      for ( var i=0, len=vectorjoins.length; i<len; i++) {\n          var vectorjoin = vectorjoins[i];\n          fields.push( vectorjoin.targetFieldName );\n      }\n    }\n\n    // Get WFS url and options\n    var getFeatureUrlData = getVectorLayerWfsUrl( aName, null, null, 'extent' );\n    getFeatureUrlData['options']['PROPERTYNAME'] = fields.join(',');\n\n    var layerName = cleanName(aName);\n\n    // Get data\n    $.post( getFeatureUrlData['url'], getFeatureUrlData['options'], function(data) {\n      var lConfig = config.layers[aName];\n      locate['features'] = {};\n      if ( !data.features )\n        data = JSON.parse(data);\n      var features = data.features;\n      if( locate.crs != 'EPSG:4326' && features.length != 0) {\n          // load projection to be sure to have the definition\n          loadProjDefinition( locate.crs, function() {\n              // in QGIS server > 2.14 GeoJSON is in EPSG:4326\n              if ( 'qgisServerVersion' in config.options && config.options.qgisServerVersion != '2.14' )\n                locate.crs = 'EPSG:4326';\n          });\n      }\n\n      if ('filterFieldName' in locate) {\n        // create filter combobox for the layer\n        features.sort(function(a, b) {\n            var aProperty = a.properties[locate.filterFieldName];\n            var bProperty = b.properties[locate.filterFieldName];\n            if (isNaN(aProperty)) {\n                if (isNaN(bProperty)) {  // a and b are strings\n                    return aProperty.localeCompare(bProperty);\n                } else {         // a string and b number\n                    return 1;  // a > b\n                }\n            } else {\n                if (isNaN(bProperty)) {  // a number and b string\n                    return -1;  // a < b\n                } else {         // a and b are numbers\n                    return parseFloat(aProperty) - parseFloat(bProperty);\n                }\n            }\n        });\n        var filterPlaceHolder = '';\n        if ( 'filterFieldAlias' in locate && locate.filterFieldAlias!='')\n          filterPlaceHolder += locate.filterFieldAlias+' ';\n        else\n          filterPlaceHolder += locate.filterFieldName;\n        filterPlaceHolder +=' ('+ lConfig.title + ')';\n        var fOptions = '<option value=\"-1\"></option>';\n        var fValue = '-1';\n        for (var i=0, len=features.length; i<len; i++) {\n          var feat = features[i];\n          if ( fValue != feat.properties[locate.filterFieldName] ) {\n            fValue = feat.properties[locate.filterFieldName];\n            fOptions += '<option value=\"'+fValue+'\">'+fValue+'</option>';\n          }\n        }\n\n\n        // add filter values list\n        $('#locate-layer-'+layerName).parent().before('<div class=\"locate-layer\"><select id=\"locate-layer-'+layerName+'-'+locate.filterFieldName+'\">'+fOptions+'</select></div><br/>');\n        // listen to filter select changes\n        $('#locate-layer-'+layerName+'-'+locate.filterFieldName).change(function(){\n          var filterValue = $(this).children(':selected').val();\n          updateLocateFeatureList( aName );\n          if (filterValue == '-1')\n            $('#locate-layer-'+layerName+'-'+locate.filterFieldName+' ~ span > input').val('');\n          $('#locate-layer-'+layerName+' ~ span > input').val('');\n          $('#locate-layer-'+layerName).val('-1');\n          zoomToLocateFeature(aName);\n        });\n        // add combobox to the filter select\n        $('#locate-layer-'+layerName+'-'+locate.filterFieldName).combobox({\n          position: { my : \"right top\", at: \"right bottom\" },\n          \"selected\": function(evt, ui){\n            if ( ui.item ) {\n              var self = $(this);\n              var uiItem = $(ui.item);\n              window.setTimeout(function(){\n                self.val(uiItem.val()).change();\n              }, 1);\n            }\n          }\n        });\n\n        // add place holder to the filter combobox input\n        $('#locate-layer-'+layerName+'-'+locate.filterFieldName+' ~ span > input').attr('placeholder', filterPlaceHolder).val('');\n        $('#locate-layer-'+layerName+'-'+locate.filterFieldName+' ~ span > input').autocomplete('close');\n        updateMiniDockSize();\n      }\n\n      // create combobox for the layer\n      features.sort(function(a, b) {\n            var aProperty = a.properties[locate.fieldName];\n            var bProperty = b.properties[locate.fieldName];\n            if (isNaN(aProperty)) {\n                if (isNaN(bProperty)) {  // a and b are strings\n                    return aProperty.localeCompare(bProperty);\n                } else {         // a string and b number\n                    return 1;  // a > b\n                }\n            } else {\n                if (isNaN(bProperty)) {  // a number and b string\n                    return -1;  // a < b\n                } else {         // a and b are numbers\n                    return parseFloat(aProperty) - parseFloat(bProperty);\n                }\n            }\n      });\n      var placeHolder = '';\n      if ('filterFieldName' in locate) {\n          if ( 'fieldAlias' in locate && locate.fieldAlias!='' )\n              placeHolder += locate.fieldAlias+' ';\n          else\n              placeHolder += locate.fieldName+' ';\n          placeHolder += '('+lConfig.title+')';\n      } else {\n          placeHolder = lConfig.title;\n      }\n      var options = '<option value=\"-1\"></option>';\n      for (var i=0, len=features.length; i<len; i++) {\n        var feat = features[i];\n        locate.features[feat.id.toString()] = feat;\n        if ( !('filterFieldName' in locate) )\n          options += '<option value=\"'+feat.id+'\">'+feat.properties[locate.fieldName]+'</option>';\n      }\n      // listen to select changes\n      $('#locate-layer-'+layerName).html(options).change(function() {\n        var val = $(this).children(':selected').val();\n        if (val == '-1') {\n          $('#locate-layer-'+layerName+' ~ span > input').val('');\n          // update to join layer\n          if ( 'filterjoins' in locate && locate.filterjoins.length != 0 ) {\n              var filterjoins = locate.filterjoins;\n              for (var i=0, len=filterjoins.length; i<len; i++) {\n                  var filterjoin = filterjoins[i];\n                  var jName = filterjoin.joinLayer;\n                  if ( jName in config.locateByLayer ) {\n                      // update joined select options\n                      var oldVal = $('#locate-layer-'+cleanName(jName)).val();\n                      updateLocateFeatureList( jName );\n                      $('#locate-layer-'+cleanName(jName)).val( oldVal );\n                      return;\n                  }\n              }\n          }\n          // zoom to parent selection\n          if ( 'vectorjoins' in locate && locate.vectorjoins.length == 1 ) {\n              var jName = locate.vectorjoins[0].joinLayer;\n              if ( jName in config.locateByLayer ) {\n                zoomToLocateFeature( jName );\n                return;\n              }\n          }\n          // clear the map\n          zoomToLocateFeature( aName );\n        } else {\n          // zoom to val\n          zoomToLocateFeature( aName );\n          // update joined layer\n          if ( 'filterjoins' in locate && locate.filterjoins.length != 0 ) {\n              var filterjoins = locate.filterjoins;\n              for (var i=0, len=filterjoins.length; i<len; i++) {\n                  var filterjoin = filterjoins[i];\n                  var jName = filterjoin.joinLayer;\n                  if ( jName in config.locateByLayer ) {\n                      // update joined select options\n                      updateLocateFeatureList( jName );\n                      $('#locate-layer-'+cleanName(jName)).val('-1');\n                      $('#locate-layer-'+cleanName(jName)+' ~ span > input').val('');\n                  }\n              }\n          }\n        }\n        $(this).blur();\n        return;\n      });\n      $('#locate-layer-'+layerName).combobox({\n    \"minLength\": ('minLength' in locate) ? locate.minLength : 0,\n        \"position\": { my : \"right top\", at: \"right bottom\" },\n        \"selected\": function(evt, ui){\n          if ( ui.item ) {\n            var self = $(this);\n            var uiItem = $(ui.item);\n            window.setTimeout(function(){\n              self.val(uiItem.val()).change();\n            }, 1);\n          }\n        }\n      });\n      $('#locate-layer-'+layerName+' ~ span > input').attr('placeholder', placeHolder).val('');\n      $('#locate-layer-'+layerName+' ~ span > input').autocomplete('close');\n      if ( ('minLength' in locate) && locate.minLength > 0 )\n        $('#locate-layer-'+layerName).parent().addClass('no-toggle');\n      if(mCheckMobile()){\n        // autocompletion items for locatebylayer feature\n        $('div.locate-layer select').show();\n        $('span.custom-combobox').hide();\n      }\n    },'json');\n  }\n\n  /**\n   * create the layer switcher\n   */\n  function getSwitcherLi(aNode, aLevel) {\n    var nodeConfig = aNode.config;\n    var html = '<li id=\"'+nodeConfig.type+'-'+aNode.name+'\">';\n\n    // add checkbox to display children or legend image\n    html += '<input type=\"checkbox\" id=\"open'+nodeConfig.type+aNode.name+'\" name=\"open'+nodeConfig.type+aNode.name+'\" checked=\"checked\"></input><label for=\"open'+nodeConfig.type+aNode.name+'\">&nbsp;</label>';\n    // add button to manage visibility\n    html += '<button class=\"checkbox\" name=\"'+nodeConfig.type+'-'+aNode.name+'-visibility\" value=\"0\" title=\"'+lizDict['tree.button.checkbox']+'\"></button>';\n    // add layer title\n    html += '<span class=\"label\" title=\"'+nodeConfig.abstract+'\">'+nodeConfig.title+'</span>';\n\n    if (('children' in aNode) && aNode['children'].length!=0) {\n      html += getSwitcherUl(aNode, aLevel+1);\n    } else if (nodeConfig.type == 'layer'\n           && (!nodeConfig.noLegendImage || nodeConfig.noLegendImage != 'True')) {\n      var url = getLayerLegendGraphicUrl(aNode.name, false);\n      if ( url != null && url != '' ) {\n          html += '<ul id=\"legend-layer-'+aNode.name+'\">';\n          html += '<li><div><img data-src=\"'+url+'\" src=\"'+lizUrls.basepath + 'assets/css/images/download_layer.gif' + '\"/></div></li>';\n          html += '</ul>';\n      }\n    }\n    html += '</li>';\n    return html;\n  }\n\n  function getSwitcherUl(aNode, aLevel) {\n    var html = '<ul class=\"level'+aLevel+'\">';\n    var children = aNode.children;\n    for (var i=0, len=children.length; i<len; i++) {\n      var child = children[i];\n      html += getSwitcherLi(child,aLevel);\n    }\n    html += '</ul>';\n    return html;\n  }\n\n  function createSwitcher() {\n    // set the switcher content\n    $('#switcher-layers').html(getSwitcherNode(tree,0));\n    $('#switcher table.tree').treeTable({\n      stringExpand: lizDict['tree.button.expand'],\n      stringCollapse: lizDict['tree.button.collapse'],\n      onNodeShow: function() {\n        var self = $(this);\n        self.addClass('visible');\n        if (self.find('div.legendGraphics').length != 0) {\n          var name = self.attr('id').replace('legend-','');\n          var url = getLayerLegendGraphicUrl(name, true);\n          if ( url != null && url != '' ) {\n              var limg = self.find('div.legendGraphics img');\n              limg.attr('data-src', url );\n              limg.attr('src', limg.attr('data-src') );\n          }\n        }\n      },\n      onNodeHide: function() {\n        var self = $(this);\n        self.removeClass('visible');\n      }\n    });\n    $(\"#switcher table.tree tbody\").on(\"mousedown\", \"tr td span\", function(event) {\n      // Only act on left button click\n      if(event.which === 1){\n        var wasSelected = $(this).parents('tr:first').hasClass('selected');\n        var isSelected = !wasSelected;\n        $(\"#switcher table.tree tbody tr\").removeClass('selected');\n        $(this).parents('tr:first').toggleClass(\"selected\", isSelected);\n        $('#switcher-layers-actions').toggleClass('active', isSelected);\n\n        // Trigger event\n        var id = $(this).parents('tr:first').attr('id');\n        var itemType = id.split('-')[0];\n        var itemName = id.split('-')[1];\n        lizMap.events.triggerEvent(\"lizmapswitcheritemselected\",\n          { 'name': itemName, 'type': itemType, 'selected': isSelected}\n        );\n      }\n    });\n\n  // === Private functions\n  var options = {\n    childPrefix : \"child-of-\"\n  };\n\n  function childrenOf(node) {\n    return $(node).siblings(\"tr.\" + options.childPrefix + node[0].id);\n  }\n\n  function descendantsOf(node) {\n    var descendants = [];\n    var children = [];\n    if (node && node[0])\n      children = childrenOf(node);\n    for (var i=0, len=children.length; i<len; i++) {\n      descendants.push(children[i]);\n      descendants = descendants.concat(descendantsOf([children[i]]));\n    }\n    return descendants;\n  }\n\n  function parentOf(node) {\n    if (node.length == 0 )\n      return null;\n\n    var classNames = node[0].className.split(' ');\n\n    for(var key=0; key<classNames.length; key++) {\n      if(classNames[key].match(options.childPrefix)) {\n        return $(node).siblings(\"#\" + classNames[key].substring(options.childPrefix.length));\n      }\n    }\n\n    return null;\n  }\n\n  function ancestorsOf(node) {\n    var ancestors = [];\n    while(node = parentOf(node)) {\n      ancestors[ancestors.length] = node[0];\n    }\n    return ancestors;\n  }\n\n    // activate checkbox buttons\n    $('#switcher button.checkbox')\n    .click(function(){\n      var self = $(this);\n      if (self.hasClass('disabled'))\n        return false;\n\n      // get tr of the button\n      var selfTr = self.parents('tr').first();\n      // get the parent of the tr of the button\n      var parentTr = parentOf( selfTr );\n      // get the siblings of the tr of the button\n      var siblingsTr = [];\n      if ( parentTr && parentTr.length != 0) {\n        for (var c=0, childrenParentTr=childrenOf(parentTr); c<childrenParentTr.length; c++){\n            var siblingTr = $(childrenParentTr[c]);\n            if( siblingTr.attr('id') != selfTr.attr('id') )\n              siblingsTr.push( siblingTr );\n        }\n      }\n      var ancestors = [];\n      if( selfTr.hasClass('liz-layer') ) {\n          // manage the button layer\n          if( !self.hasClass('checked') ) {\n              self.removeClass('partial').addClass('checked');\n              selfTr.find('button.checkbox[name=\"layer\"]').each(function(i,b){\n                var name = $(b).val();\n                var layer = map.getLayersByName(name)[0];\n                if( typeof layer !== 'undefined' )\n                  layer.setVisibility(true);\n              });\n          } else {\n              self.removeClass('partial').removeClass('checked');\n              selfTr.find('button.checkbox[name=\"layer\"]').each(function(i,b){\n                var name = $(b).val();\n                var layer = map.getLayersByName(name)[0];\n                if( typeof layer !== 'undefined' )\n                  layer.setVisibility(false);\n              });\n          }\n          if( selfTr.hasClass('mutually-exclusive') ){\n              if( self.hasClass('checked') ) {\n                  for(var s=0, slen=siblingsTr.length; s<slen; s++) {\n                      var siblingTr = $(siblingsTr[s]);\n                      var siblingButt = siblingTr.find('button.checkbox');\n                      if( siblingButt.hasClass('checked') ){\n                        siblingButt.removeClass('partial').removeClass('checked');\n                        if( siblingButt.attr('name') == 'layer') {\n                            var name = $(siblingButt).val();\n                            var layer = map.getLayersByName(name)[0];\n                            if( typeof layer !== 'undefined' )\n                              layer.setVisibility(false);\n                        }\n                      }\n                  }\n                  if ( parentTr && parentTr.length != 0) {\n                      var parentButt = parentTr.find('button.checkbox');\n                      parentButt.removeClass('partial').addClass('checked');\n                  }\n              } else if ( parentTr && parentTr.length != 0) {\n                  var parentButt = parentTr.find('button.checkbox');\n                  parentButt.removeClass('partial').removeClass('checked');\n              }\n              ancestors = ancestorsOf(parentTr);\n          } else {\n            ancestors = ancestorsOf(selfTr);\n          }\n      } else {\n          // manage the button group\n          var descendants = descendantsOf(selfTr);\n          var mutuallyExclusiveGroups = [];\n          $.each(descendants,function(i,tr) {\n            tr = $(tr);\n            var butt = tr.find('button.checkbox');\n            if( !self.hasClass('checked') ) {\n                butt.removeClass('partial').addClass('checked');\n                if( tr.hasClass('liz-layer') && butt.attr('name') == 'layer') {\n                    if( tr.hasClass('mutually-exclusive') ){\n                        var pTr = parentOf(tr);\n                        var pId = pTr.attr('id');\n                        if( mutuallyExclusiveGroups.indexOf(pId) != -1 ) {\n                            butt.removeClass('partial').removeClass('checked');\n                            return;\n                        }\n                        mutuallyExclusiveGroups.push(pId);\n                    }\n                    var name = $(butt).val();\n                    var layer = map.getLayersByName(name)[0];\n                    if( typeof layer !== 'undefined' )\n                      layer.setVisibility(true);\n                }\n            } else {\n                butt.removeClass('partial').removeClass('checked');\n                if( tr.hasClass('liz-layer') && butt.attr('name') == 'layer') {\n                    var name = $(butt).val();\n                    var layer = map.getLayersByName(name)[0];\n                    if( typeof layer !== 'undefined' )\n                      layer.setVisibility(false);\n                }\n            }\n          });\n          if( !self.hasClass('checked') )\n              self.removeClass('partial').addClass('checked');\n          else\n              self.removeClass('partial').removeClass('checked');\n          ancestors = ancestorsOf(selfTr);\n      }\n      // manage ancestors\n      $.each(ancestors,function(i,tr) {\n        tr = $(tr);\n        var count = 0;\n        var checked = 0;\n        var pchecked = 0;\n        var trDesc = childrenOf(tr);\n        $.each(trDesc,function(j,trd) {\n          $(trd).find('button.checkbox').each(function(i,b){\n            b = $(b);\n            if ( b.hasClass('checked') )\n              checked++;\n            else if ( b.hasClass('partial')&& b.hasClass('checked') )\n              pchecked++;\n            count++;\n          });\n        });\n        var trButt = tr.find('button.checkbox');\n        if (count==checked)\n          trButt.removeClass('partial').addClass('checked');\n        else if (checked==0 && pchecked==0)\n          trButt.removeClass('partial').removeClass('checked');\n        else\n          trButt.addClass('partial').addClass('checked');\n      });\n    });\n\n    // activate link buttons\n    $('#switcher button.link')\n    .click(function(){\n      var self = $(this);\n      if (self.hasClass('disabled'))\n        return false;\n      var windowLink = self.val();\n      // Test if the link is internal\n      var mediaRegex = /^(\\/)?media\\//;\n      if(mediaRegex.test(windowLink)){\n        var mediaLink = OpenLayers.Util.urlAppend(lizUrls.media\n          ,OpenLayers.Util.getParameterString(lizUrls.params)\n        )\n        windowLink = mediaLink+'&path=/'+windowLink;\n      }\n      // Open link in a new window\n      window.open(windowLink);\n    });\n\n    // Activate removeCache button\n    $('#switcher button.removeCache')\n    .click(function(){\n      var self = $(this);\n      if (self.hasClass('disabled'))\n        return false;\n      var removeCacheServerUrl = OpenLayers.Util.urlAppend(\n         lizUrls.removeCache\n        ,OpenLayers.Util.getParameterString(lizUrls.params)\n      );\n      var windowLink = removeCacheServerUrl + '&layer=' + self.val();\n      // Open link in a new window\n      if (confirm(lizDict['tree.button.removeCache'] + ' ?'))\n        window.open(windowLink);\n    });\n\n    var projection = map.projection;\n\n    //manage WMS max width and height\n    var wmsMaxWidth = 3000;\n    var wmsMaxHeight = 3000;\n    if( ('wmsMaxWidth' in config.options) && config.options.wmsMaxWidth )\n        wmsMaxWidth = Number(config.options.wmsMaxWidth);\n    if( ('wmsMaxHeight' in config.options) && config.options.wmsMaxHeight )\n        wmsMaxHeight = Number(config.options.wmsMaxHeight);\n    var removeSingleTile = false;\n    var mapSize = map.size;\n    var replaceSingleTileSize = new OpenLayers.Size(wmsMaxWidth, wmsMaxHeight);\n    if( mapSize.w > wmsMaxWidth || mapSize.h > wmsMaxHeight ){\n        removeSingleTile = true;\n        var wmsMaxMax = Math.max(wmsMaxWidth, wmsMaxHeight);\n        var wmsMinMax = Math.min(wmsMaxWidth, wmsMaxHeight);\n        var mapMax = Math.max(mapSize.w, mapSize.h);\n        var mapMin = Math.min(mapSize.w, mapSize.h);\n        if( mapMax/2 > mapMin )\n          replaceSingleTileSize = new OpenLayers.Size(Math.round(mapMax/2), Math.round(mapMax/2));\n        else if( wmsMaxMax/2 > mapMin )\n          replaceSingleTileSize = new OpenLayers.Size(Math.round(wmsMaxMax/2), Math.round(wmsMaxMax/2));\n        else\n          replaceSingleTileSize = new OpenLayers.Size(Math.round(wmsMinMax/2), Math.round(wmsMinMax/2));\n    }\n\n    // get the baselayer select content\n    // and adding baselayers to the map\n    var select = [];\n    baselayers.reverse();\n    for (var i=0,len=baselayers.length; i<len; i++) {\n      var baselayer = baselayers[i]\n      baselayer.units = projection.proj.units;\n      // Update singleTile layers\n      if( removeSingleTile && (baselayer instanceof OpenLayers.Layer.WMS) && baselayer.singleTile ) {\n          baselayer.addOptions({singleTile:false, tileSize: replaceSingleTileSize});\n      }\n      try{ // because google maps layer can be created but not added\n          map.addLayer(baselayer);\n          var qgisName = baselayer.name;\n          if ( baselayer.name in cleanNameMap )\n              qgisName = getLayerNameByCleanName(baselayer.name);\n          var blConfig = config.layers[qgisName];\n          if (blConfig)\n            select += '<option value=\"'+baselayer.name+'\">'+blConfig.title+'</option>';\n          else\n            select += '<option value=\"'+baselayer.name+'\">'+baselayer.name+'</option>';\n\n      } catch(e) {\n          var qgisName = baselayer.name;\n          if ( baselayer.name in cleanNameMap )\n              qgisName = getLayerNameByCleanName(baselayer.name);\n          console.log(qgisName+\" can't be added to the map!\");\n      }\n    }\n\n    if (baselayers.length!=0) {\n      // active the select element for baselayers\n      $('#switcher-baselayer-select').append(select);\n      $('#switcher-baselayer-select')\n        .change(function() {\n          var val = $(this).val();\n          var blName = map.getLayersByName(val)[0];\n          map.setBaseLayer( blName );\n\n          // Trigger event\n          lizMap.events.triggerEvent(\"lizmapbaselayerchanged\",\n            { 'layer': blName}\n          );\n\n          $(this).blur();\n        });\n      // Hide switcher-baselayer if only one base layer inside\n      if (baselayers.length==1){\n        $('#switcher-baselayer').hide();\n      }\n      else if ( 'startupBaselayer' in config.options ) {\n          var startupBaselayer = config.options['startupBaselayer'];\n          if ( startupBaselayer in startupBaselayersReplacement )\n            startupBaselayer = startupBaselayersReplacement[startupBaselayer];\n          else if ( startupBaselayer in config.layers )\n            startupBaselayer = cleanName(startupBaselayer);\n\n          if ( $('#switcher-baselayer-select option[value=\"'+startupBaselayer+'\"]').length != 0)\n            $('#switcher-baselayer-select').val(startupBaselayer).change();\n      }\n    } else {\n      // hide elements for baselayers\n      $('#switcher-baselayer').hide();\n      map.addLayer(new OpenLayers.Layer.Vector('baselayer',{\n        maxExtent:map.maxExtent\n       ,maxScale: map.maxScale\n       ,minScale: map.minScale\n       ,numZoomLevels: map.numZoomLevels\n       ,scales: map.scales\n       ,projection: map.projection\n       ,units: map.projection.proj.units\n      }));\n    }\n\n    // adding layers to the map\n    layers.sort(function(a, b) {\n      if (a.order == b.order)\n        return 0;\n      return a.order > b.order ? 1 : -1;\n    });\n    layers.reverse();\n    for (var i=0,len=layers.length; i<len; i++) {\n      var l = layers[i];\n      l.units = projection.proj.units;\n      l.events.on({\n        loadstart: function(evt) {\n          $('#layer-'+evt.object.name+' span.loading').addClass('loadstart');\n        },\n        loadend: function(evt) {\n          $('#layer-'+evt.object.name+' span.loading').removeClass('loadstart');\n        }\n      });\n      // Add only layers with geometry\n      var qgisName = null;\n      if ( l.name in cleanNameMap )\n          qgisName = getLayerNameByCleanName(l.name);\n      var aConfig = null;\n      if ( qgisName )\n          aConfig = config.layers[qgisName];\n      if ( !aConfig )\n          aConfig = config.layers[l.params['LAYERS']];\n      if ( !aConfig )\n          aConfig = config.layers[l.name];\n      if ( !aConfig )\n          continue;\n      if( 'geometryType' in aConfig &&\n        ( aConfig.geometryType == \"none\" || aConfig.geometryType == \"unknown\" || aConfig.geometryType == \"\" )\n      ){\n        continue;\n      }\n      // Update singleTile layers\n      if( removeSingleTile && (l instanceof OpenLayers.Layer.WMS) && l.singleTile ) {\n          l.addOptions({singleTile:false, tileSize: replaceSingleTileSize});\n      }\n      map.addLayer(l);\n\n    }\n\n    // Add Locate by layer\n    if ('locateByLayer' in config) {\n      var locateByLayerList = [];\n      for (var lname in config.locateByLayer) {\n        if ( 'order' in config.locateByLayer[lname] )\n          locateByLayerList[ config.locateByLayer[lname].order ] = lname;\n        else\n          locateByLayerList.push( lname );\n      }\n      var locateContent = [];\n      for (var l in locateByLayerList) {\n        var lname = locateByLayerList[l];\n        var lConfig = config.layers[lname];\n        var html = '<div class=\"locate-layer\">';\n        html += '<select id=\"locate-layer-'+cleanName(lname)+'\" class=\"label\">';\n        html += '<option>'+lConfig.title+'...</option>';\n        html += '</select>';\n        html += '</div>';\n        //constructing the select\n        locateContent.push(html);\n      }\n      $('#locate .menu-content').html(locateContent.join('<hr/>'));\n      map.addLayer(new OpenLayers.Layer.Vector('locatelayer',{\n        styleMap: new OpenLayers.StyleMap({\n          pointRadius: 6,\n          fill: false,\n          stroke: true,\n          strokeWidth: 3,\n          strokeColor: 'yellow',\n          strokeOpacity: 0.8\n        })\n      }));\n\n        var featureTypes = getVectorLayerFeatureTypes();\n        if (featureTypes.length == 0 ){\n          config.locateByLayer = {};\n          $('#button-locate').parent().remove();\n          $('#locate-menu').remove();\n        } else {\n          for (const featureType of featureTypes) {\n            var typeName = featureType.getElementsByTagName('Name')[0].textContent;\n            var lname = lizMap.getNameByTypeName( typeName );\n            if ( !lname ) {\n                if (typeName in config.locateByLayer)\n                    lname = typeName\n                else if ( (typeName in shortNameMap) && (shortNameMap[typeName] in config.locateByLayer))\n                    lname = shortNameMap[typeName];\n                else {\n                    for (var lbl in config.locateByLayer) {\n                        if (lbl.split(' ').join('_') == typeName) {\n                            lname = lbl;\n                            break;\n                        }\n                    }\n                }\n            }\n\n            if ( !(lname in config.locateByLayer) )\n                continue;\n\n            var locate = config.locateByLayer[lname];\n            locate['crs'] = featureType.getElementsByTagName('SRS')[0].textContent;\n            loadProjDefinition( locate.crs, function() {\n                new OpenLayers.Projection(locate.crs);\n            });\n            var bbox = featureType.getElementsByTagName('LatLongBoundingBox')[0];\n            locate['bbox'] = [\n              parseFloat(bbox.getAttribute('minx'))\n              , parseFloat(bbox.getAttribute('miny'))\n              , parseFloat(bbox.getAttribute('maxx'))\n              , parseFloat(bbox.getAttribute('maxy'))\n            ];\n          }\n\n          // get joins\n          for (var lName in config.locateByLayer) {\n            var locate = config.locateByLayer[lName];\n            if ('vectorjoins' in locate && locate['vectorjoins'].length != 0) {\n              var vectorjoin = locate['vectorjoins'][0];\n              locate['joinFieldName'] = vectorjoin['targetFieldName'];\n              for (var jName in config.locateByLayer) {\n                var jLocate = config.locateByLayer[jName];\n                if (jLocate.layerId == vectorjoin.joinLayerId) {\n                  vectorjoin['joinLayer'] = jName;\n                  locate['joinLayer'] = jName;\n                  jLocate['joinFieldName'] = vectorjoin['joinFieldName'];\n                  jLocate['joinLayer'] = lName;\n                  jLocate['filterjoins'] = [{\n                      'targetFieldName': vectorjoin['joinFieldName'],\n                      'joinFieldName': vectorjoin['targetFieldName'],\n                      'joinLayerId': locate.layerId,\n                      'joinLayer': lName\n                  }];\n                }\n              }\n            }\n          }\n\n          // get locate by layers features\n          for (var lname in config.locateByLayer) {\n            getLocateFeature(lname);\n          }\n          $('.btn-locate-clear').click(function() {\n            clearDrawLayer('locatelayer');\n            $('#locate select').val('-1');\n            $('div.locate-layer span > input').val('');\n\n            if( lizMap.lizmapLayerFilterActive ){\n                lizMap.events.triggerEvent('lizmaplocatefeaturecanceled',\n                  {'featureType': lizMap.lizmapLayerFilterActive}\n                );\n            }\n            return false;\n\n          });\n          $('#locate-close').click(function() {\n            $('.btn-locate-clear').click(); // deactivate locate and filter\n            $('#button-locate').click();\n            return false;\n          });\n        }\n    }\n\n    $('#switcher span.label').tooltip({\n      viewport: '#dock'\n    });\n\n  }\n\n  /**\n   * PRIVATE function: createNavbar\n   * create the navigation bar (zoom, scales, etc)\n   */\n  function createNavbar() {\n    $('#navbar div.slider').height(Math.max(50,map.numZoomLevels*5)).slider({\n      orientation:'vertical',\n      min: 0,\n      max: map.numZoomLevels-1,\n      change: function(evt,ui) {\n        if (ui.value > map.baseLayer.numZoomLevels-1) {\n          $('#navbar div.slider').slider('value',map.getZoom())\n          $('#zoom-in-max-msg').show('slow', function() {\n            window.setTimeout(function(){$('#zoom-in-max-msg').hide('slow')},1000)\n          });\n        } else if ( ui.value != map.zoom )\n          map.zoomTo(ui.value);\n      }\n    });\n    $('#navbar button.pan').click(function(){\n      var self = $(this);\n      if (self.hasClass('active'))\n        return false;\n      $('#navbar button.zoom').removeClass('active');\n      self.addClass('active');\n      var navCtrl = map.getControlsByClass('OpenLayers.Control.Navigation')[0];\n      navCtrl.zoomBox.keyMask = navCtrl.zoomBoxKeyMask;\n      navCtrl.zoomBox.handler.keyMask = navCtrl.zoomBoxKeyMask;\n      navCtrl.zoomBox.handler.dragHandler.keyMask = navCtrl.zoomBoxKeyMask;\n      navCtrl.handlers.wheel.activate();\n      if ( ( !('edition' in controls) || !controls.edition.active )\n           && ('featureInfo' in controls) && controls.featureInfo !== null )\n          controls.featureInfo.activate();\n    });\n    $('#navbar button.zoom').click(function(){\n      var self = $(this);\n      if (self.hasClass('active'))\n        return false;\n      $('#navbar button.pan').removeClass('active');\n      self.addClass('active');\n      if ( ('featureInfo' in controls) && controls.featureInfo !== null )\n            controls.featureInfo.deactivate();\n      var navCtrl = map.getControlsByClass('OpenLayers.Control.Navigation')[0];\n      navCtrl.handlers.wheel.deactivate();\n      navCtrl.zoomBox.keyMask = null;\n      navCtrl.zoomBox.handler.keyMask = null;\n      navCtrl.zoomBox.handler.dragHandler.keyMask = null;\n    });\n    $('#navbar button.zoom-extent')\n    .click(function(){\n      var url_params = getUrlParameters();\n      if( 'layers' in url_params ){\n        runPermalink( url_params );\n      }\n      else{\n        map.zoomToExtent(map.initialExtent);\n      }\n    });\n    $('#navbar button.zoom-in')\n    .click(function(){\n      if (map.getZoom() == map.baseLayer.numZoomLevels-1)\n          $('#zoom-in-max-msg').show('slow', function() {\n            window.setTimeout(function(){$('#zoom-in-max-msg').hide('slow')},1000)\n          });\n      else\n        map.zoomIn();\n    });\n    $('#navbar button.zoom-out')\n    .click(function(){\n      map.zoomOut();\n    });\n    if ( ('zoomHistory' in config.options)\n        && config.options['zoomHistory'] == \"True\") {\n      var hCtrl =  new OpenLayers.Control.NavigationHistory();\n      map.addControls([hCtrl]);\n      $('#navbar button.previous').click(function(){\n        var ctrl = map.getControlsByClass('OpenLayers.Control.NavigationHistory')[0];\n        if (ctrl && ctrl.previousStack.length != 0)\n          ctrl.previousTrigger();\n        if (ctrl && ctrl.previous.active)\n          $(this).removeClass('disabled');\n        else\n          $(this).addClass('disabled');\n        if (ctrl && ctrl.next.active)\n          $('#navbar button.next').removeClass('disabled');\n        else\n          $('#navbar button.next').addClass('disabled');\n      });\n      $('#navbar button.next').click(function(){\n        var ctrl = map.getControlsByClass('OpenLayers.Control.NavigationHistory')[0];\n        if (ctrl && ctrl.nextStack.length != 0)\n          ctrl.nextTrigger();\n        if (ctrl && ctrl.next.active)\n          $(this).removeClass('disabled');\n        else\n          $(this).addClass('disabled');\n        if (ctrl && ctrl.previous.active)\n          $('#navbar button.previous').removeClass('disabled');\n        else\n          $('#navbar button.previous').addClass('disabled');\n      });\n      map.events.on({\n        moveend : function() {\n          var ctrl = map.getControlsByClass('OpenLayers.Control.NavigationHistory')[0];\n          if (ctrl && ctrl.previousStack.length != 0)\n            $('#navbar button.previous').removeClass('disabled');\n          else\n            $('#navbar button.previous').addClass('disabled');\n          if (ctrl && ctrl.nextStack.length != 0)\n            $('#navbar button.next').removeClass('disabled');\n          else\n            $('#navbar button.next').addClass('disabled');\n        }\n      });\n    } else {\n      $('#navbar > .history').remove();\n    }\n  }\n\n  /**\n   * PRIVATE function: createToolbar\n   * create the tool bar (collapse switcher, etc)\n   */\n  function createToolbar() {\n    var configOptions = config.options;\n\n    var info = addFeatureInfo();\n    controls['featureInfo'] = info;\n\n    if ( ('print' in configOptions)\n        && configOptions['print'] == 'True')\n      addPrintControl();\n    else\n      $('#button-print').parent().remove();\n\n    if ( config['tooltipLayers'] && config.tooltipLayers.length != 0)\n        addTooltipControl();\n    else\n      $('#button-tooltip-layer').parent().remove();\n\n    if (('geolocation' in configOptions)\n      && configOptions['geolocation'] == 'True'){\n      $('#geolocation button.btn-geolocation-close').click(function () {\n        $('#button-geolocation').click();\n        return false;\n      });\n    }\n\n    if ( ('measure' in configOptions)\n        && configOptions['measure'] == 'True')\n      addMeasureControls();\n    else {\n      $('#measure').parent().remove();\n      $('#measure-length-menu').remove();\n      $('#measure-area-menu').remove();\n      $('#measure-perimeter-menu').remove();\n    }\n  }\n\n  /**\n   * PRIVATE function: deactivateToolControls\n   * Deactivate Openlayers controls\n   */\n  function deactivateToolControls( evt ) {\n    for (var id in controls) {\n      var ctrl = controls[id];\n      if(ctrl){\n        if (evt && ('object' in evt) && ctrl == evt.object){\n          continue;\n        }\n        if (ctrl.type == OpenLayers.Control.TYPE_TOOL){\n          ctrl.deactivate();\n        }\n      }\n    }\n    return true;\n  }\n\n\n  /**\n   * PRIVATE function: createPermalink\n   * create the permalink tool\n   */\n  function createPermalink() {\n      if ( $('#permalink').length == 0 )\n        return;\n\n    var pLink = new OpenLayers.Control.Permalink(\n      'permalink',\n      null,\n      {\n        \"createParams\": createPermalinkArgs\n      }\n    );\n    map.addControl( pLink );\n\n    var eLink = new OpenLayers.Control.Permalink(\n      'permalink-embed',\n      $('#permalink-embed').attr('href'),\n      {\n        \"createParams\": createPermalinkArgs\n      }\n    );\n    map.addControl( eLink );\n    map.events.on({\n        \"changebaselayer\": function() {\n            $('#switcher-baselayer-select').val( map.baseLayer.name ).change();\n        },\n        'moveend': updatePermalinkInputs,\n        'changelayer': onMapChangelayer,\n        'changebaselayer': updatePermalinkInputs\n    });\n    $('#select-embed-permalink').change(function(){\n        if ( $(this).val() == 'p') {\n            $('#span-embed-personalized-permalink').show();\n        } else {\n            $('#span-embed-personalized-permalink').hide();\n        }\n        updatePermalinkInputs();\n    });\n    $('#span-embed-personalized-permalink input').change(updatePermalinkInputs);\n\n    $('.btn-permalink-clear').click(function(){\n      $('#button-permaLink').click();\n      return false;\n    });\n\n    bindGeobookmarkEvents();\n\n    $('#permalink-box ul.permalink-tabs a[data-toggle=\"tab\"]').on('shown', function(e){\n        if($(e.target).attr('href') == '#tab-embed-permalink')\n            updateMiniDockSize();\n    });\n\n    $('#geobookmark-form').submit(function(){\n      var bname = $('#geobookmark-form input[name=\"bname\"]').val();\n      if( bname == '' ){\n        mAddMessage(lizDict['geobookmark.name.required'],'error',true);\n        return false;\n      }\n      var gburl = lizUrls.geobookmark;\n      var gbparams = JSON.parse(JSON.stringify(permalinkArgs));\n      gbparams['name'] = bname;\n      gbparams['q'] = 'add';\n      if( lizMap.lizmapLayerFilterActive ) {\n        var afilter = lizMap.lizmapLayerFilterActive + ':' + config.layers[lizMap.lizmapLayerFilterActive]['filteredFeatures'].join();\n        gbparams['filter'] =  afilter;\n      }\n      $.post(gburl,\n        gbparams,\n        function(data) {\n          setGeobookmarkContent(data);\n        }\n        ,'text'\n      );\n\n      return false;\n    });\n\n    lizMap.events.on({\n        minidockopened: function(e) {\n            if ( e.id == 'permaLink' ) {\n                updatePermalinkInputs();\n            }\n        }\n    });\n\n  }\n\n\n  function createPermalinkArgs(){\n\n    var args = OpenLayers.Control.Permalink.prototype.createParams.apply(\n        this, arguments\n    );\n\n    // Replace zoom, lat, lon by bbox\n    delete args['zoom'];\n    delete args['lat'];\n    delete args['lon'];\n    args['bbox'] = map.getExtent().toBBOX();\n    args['crs'] = map.projection.projCode;\n\n    // Add layer filter and style if needed\n    var filter = [];\n    var style = [];\n    var opacity = [];\n    for ( var  lName in config.layers ) {\n\n      var lConfig = config.layers[lName];\n      if ( !('request_params' in lConfig)\n        || lConfig['request_params'] == null )\n          continue;\n\n      if ( ('filter' in lConfig['request_params'])\n        && lConfig['request_params']['filter'] != null\n        && lConfig['request_params']['filter'] != \"\" ) {\n          filter.push( lConfig['request_params']['filter'] );\n      }\n\n    }\n    if ( filter.length > 0 )\n      args['filter'] = filter.join(';');\n\n    // Layers style\n    for (var i=0,len=layers.length; i<len; i++) {\n      var layer = layers[i];\n      if( layer.isVisible &&\n         (layer.params['STYLES'] != 'default' || layer.params['STYLES'] != '') ){\n        style.push( layer.name + ':' + layer.params['STYLES'] );\n      }\n      if( layer.opacity && layer.opacity != 1 ){\n        opacity.push( layer.name + ':' + layer.opacity );\n      }\n    }\n    if ( style.length > 0 )\n      args['layerStyles'] = style.join(';');\n    if ( opacity.length > 0 ) {\n      args['layerOpacities'] = opacity.join(';');\n    }\n\n    // Add permalink args to Lizmap global variable\n    permalinkArgs = args;\n\n    return args;\n\n  }\n\n  function getUrlParameters(){\n    var oParametre = {};\n\n    if (window.location.search.length > 1) {\n      for (var aItKey, nKeyId = 0, aCouples = window.location.search.substr(1).split(\"&\"); nKeyId < aCouples.length; nKeyId++) {\n        aItKey = aCouples[nKeyId].split(\"=\");\n        oParametre[decodeURIComponent(aItKey[0])] = aItKey.length > 1 ? decodeURIComponent(aItKey[1]) : \"\";\n      }\n    }\n    return oParametre;\n  }\n\n  function updatePermalinkInputs() {\n    if ( !$('#permaLink').hasClass('active') )\n        return;\n\n    var pHref = $('#permalink').attr('href');\n\n    $('#input-share-permalink').val(pHref);\n\n    var iframeSize = $('#select-embed-permalink').val();\n    pHref = $('#permalink-embed').attr('href');\n    var pIframe = '';\n    if ( iframeSize == 's' ) {\n        pIframe = '<iframe width=\"400\" height=\"300\" frameborder=\"0\" style=\"border:0\" src=\"'+pHref+'\" allowfullscreen></iframe>';\n    } else if ( iframeSize == 'm' ) {\n        pIframe = '<iframe width=\"600\" height=\"450\" frameborder=\"0\" style=\"border:0\" src=\"'+pHref+'\" allowfullscreen></iframe>';\n    }else if ( iframeSize == 'l' ) {\n        pIframe = '<iframe width=\"800\" height=\"600\" frameborder=\"0\" style=\"border:0\" src=\"'+pHref+'\" allowfullscreen></iframe>';\n    }else if ( iframeSize == 'p' ) {\n        var w = $('#input-embed-width-permalink').val();\n        var h = $('#input-embed-height-permalink').val();\n        pIframe = '<iframe width=\"'+w+'\" height=\"'+h+'\" frameborder=\"0\" style=\"border:0\" src=\"'+pHref+'\" allowfullscreen></iframe>';\n    }\n    $('#input-embed-permalink').val(pIframe);\n  }\n\n  function onMapChangelayer(event) {\n    // Update permalink\n    updatePermalinkInputs()\n\n    // Trigger lizmap event\n    if (event.property == 'visibility'){\n      var lname = getLayerNameByCleanName(event.layer.name);\n      var lconfig = config.layers[lname]\n      lizMap.events.triggerEvent(\"lizmaplayerchangevisibility\",\n      {\n        'name': lname,\n        'config': lconfig,\n        'visibility': event.layer.visibility\n      });\n    }\n  }\n\n  function bindGeobookmarkEvents(){\n\n    $('.btn-geobookmark-del').click(function(){\n      if (confirm(lizDict['geobookmark.confirm.delete'] )){\n        var gbid = $(this).val();\n        removeGeoBookmark(gbid);\n      }\n      return false;\n    });\n    $('.btn-geobookmark-run').click(function(){\n      var id = $(this).val();\n      runGeoBookmark( id );\n\n      return false;\n    });\n  }\n\n  function setGeobookmarkContent( gbData ){\n    // set content\n    $('div#geobookmark-container').html(gbData);\n    // unbind previous click events\n    $('div#geobookmark-container button').unbind('click');\n    // Bind events\n    bindGeobookmarkEvents();\n    // Remove bname val\n    $('#geobookmark-form input[name=\"bname\"]').val('').blur();\n  }\n\n  // Set the map accordingly to\n  function runPermalink( pparams ){\n\n    // Activate layers\n    var players = pparams.layers;\n\n    // Get styles and tranform into obj\n    var slist = {};\n    if( 'layerStyles' in pparams && pparams.layerStyles != ''){\n      var lstyles = pparams.layerStyles.split(';');\n      for(var i in lstyles){\n        var a = lstyles[i];\n        var b = a.split(':');\n        if( b.length == 2)\n          slist[b[0]] = b[1];\n      }\n    }\n\n    // Get opacities and tranform into obj\n    var olist = {};\n    if( 'layerOpacities' in pparams && pparams.layerOpacities != ''){\n      var lopacities = pparams.layerOpacities.split(';');\n      for(var i in lopacities){\n        var a = lopacities[i];\n        var b = a.split(':');\n        if( b.length == 2)\n          olist[b[0]] = parseFloat(b[1]);\n      }\n    }\n\n    for( var i=0; i < map.layers.length; i++){\n\n      // Activate and deactivate layers\n      var l = map.layers[i];\n      var lbase = l.isBaseLayer;\n      if( lbase ){\n        if( players[i] == 'B' )\n          $('#switcher-baselayer-select').val( l.name ).change();\n      }else{\n        var btn = $('#switcher button.checkbox[name=\"layer\"][value=\"'+l.name+'\"]');\n        if ( ( (players[i] == 'T') != btn.hasClass('checked') ) )\n          $('#switcher button.checkbox[name=\"layer\"][value=\"'+l.name+'\"]').click();\n      }\n\n      // Set style\n      if( l.name in slist ){\n        l.params['STYLES'] = slist[l.name];\n        l.redraw( true );\n        lizMap.events.triggerEvent(\"layerstylechanged\",\n            { 'featureType': l.name}\n        );\n      }\n\n      // Set opacity\n      if( l.name in olist ){\n        l.setOpacity(olist[l.name]);\n      }\n    }\n\n    // Filter\n    if( 'filter' in pparams && pparams.filter != '' ){\n        var sp = pparams.filter.split(':');\n        if( sp.length == 2 ){\n          var flayer = sp[0];\n          var ffids = sp[1].split();\n\n          // Select feature\n          lizMap.events.triggerEvent('layerfeatureselected',\n              {'featureType': flayer, 'fid': ffids, 'updateDrawing': false}\n          );\n          // Filter selected feature\n          lizMap.events.triggerEvent('layerfeaturefilterselected',\n              {'featureType': flayer}\n          );\n        }\n    }else{\n      if( lizMap.lizmapLayerFilterActive ){\n        lizMap.events.triggerEvent('layerfeatureremovefilter',\n            {'featureType': lizMap.lizmapLayerFilterActive}\n        );\n      }\n    }\n\n    // Zoom to bbox\n    var bbox = OpenLayers.Bounds.fromString( pparams.bbox );\n    map.zoomToExtent( bbox, true );\n\n  }\n\n  function runGeoBookmark( id ){\n    var gburl = lizUrls.geobookmark;\n    var gbparams = {\n      id: id,\n      q: 'get'\n    };\n    $.get(gburl,\n      gbparams,\n      function(geoparams) {\n        runPermalink(geoparams);\n      }\n      ,'json'\n    );\n  }\n\n  function removeGeoBookmark( id ){\n    var gburl = lizUrls.geobookmark;\n    var gbparams = {\n      id: id,\n      q: 'del',\n      repository: lizUrls.params.repository,\n      project: lizUrls.params.project\n    };\n    $.get(gburl,\n      gbparams,\n      function(data) {\n        setGeobookmarkContent(data);\n      }\n      ,'text'\n    );\n  }\n\n  function addGeometryFeatureInfo( popup, containerId ) {\n      // clean locate layer\n      clearDrawLayer('locatelayer');\n      var layer = map.getLayersByName('locatelayer')[0];\n      if( typeof layer === 'undefined' )\n        return;\n\n      // build selector\n      var selector = 'div.lizmapPopupContent div.lizmapPopupDiv > input.lizmap-popup-layer-feature-geometry';\n      if ( containerId )\n        selector = '#'+ containerId +' '+ selector;\n      // get geometries and crs\n      var geometries = [];\n      $(selector).each(function(){\n        var self = $(this);\n        var val = self.val();\n        if ( val == '' )\n            return;\n        var crs = self.parent().find('input.lizmap-popup-layer-feature-crs').val();\n        if ( crs == '' )\n            return;\n        var fid = self.parent().find('input.lizmap-popup-layer-feature-id').val();\n        var minx = self.parent().find('input.lizmap-popup-layer-feature-bbox-minx').val();\n        var miny = self.parent().find('input.lizmap-popup-layer-feature-bbox-miny').val();\n        var maxx = self.parent().find('input.lizmap-popup-layer-feature-bbox-maxx').val();\n        var maxy = self.parent().find('input.lizmap-popup-layer-feature-bbox-maxy').val();\n        geometries.push( { fid: fid, geom: val, crs: crs, bbox:[minx,miny,maxx,maxy] } );\n      });\n\n      // load proj and build features from popup\n      var projLoaded = [];\n      for ( var i=0, len=geometries.length; i<len; i++ ) {\n          loadProjDefinition(geometries[i].crs, function( aProj ) {\n              projLoaded.push( aProj );\n              if ( projLoaded.length == geometries.length ) {\n                  var features = [];\n                  for ( var j=0, len=geometries.length; j<len; j++ ) {\n                      var geomInfo = geometries[j];\n                      var geometry = OpenLayers.Geometry.fromWKT( geomInfo.geom );\n                      geometry.transform(geomInfo.crs, map.getProjection());\n                      features.push( new OpenLayers.Feature.Vector( geometry ) );\n\n                      var fidInput = $('div.lizmapPopupContent input.lizmap-popup-layer-feature-id[value=\"'+geomInfo.fid+'\"]');\n                      if ( !fidInput )\n                        continue;\n\n                      var bounds = OpenLayers.Bounds.fromArray(geomInfo.bbox);\n                      bounds.transform(geomInfo.crs, map.getProjection());\n                      var eHtml = '';\n                      eHtml+= '<button class=\"btn btn-mini popup-layer-feature-bbox-zoom\" value=\"';\n                      eHtml+= bounds.toString();\n                      eHtml+= '\" title=\"' + lizDict['attributeLayers.btn.zoom.title'] + '\"><i class=\"icon-zoom-in\"></i>&nbsp;</button>';\n                      var popupButtonBar = fidInput.next('span.popupButtonBar');\n                      if ( popupButtonBar.length != 0 ) {\n                          if ( popupButtonBar.find('button.popup-layer-feature-bbox-zoom').length == 0 )\n                              popupButtonBar.append(eHtml);\n                      } else {\n                          eHtml = '<span class=\"popupButtonBar\">' + eHtml + '</span></br>';\n                          fidInput.after(eHtml);\n                      }\n                      fidInput.find('button.btn').tooltip( {\n                          placement: 'bottom'\n                      } );\n                  }\n                 layer.addFeatures( features );\n\n                  // Zoom\n                  $('div.lizmapPopupContent button.popup-layer-feature-bbox-zoom')\n                  .unbind('click')\n                  .click(function(){\n                      var bbox = OpenLayers.Bounds.fromString($(this).val());\n                      map.zoomToExtent(bbox);\n                      return false;\n                  })\n                  .hover(\n                      function(){ $(this).addClass('btn-primary'); },\n                      function(){ $(this).removeClass('btn-primary'); }\n                  );\n              }\n          } );\n      }\n  }\n\n  function addChildrenDatavizFilteredByPopupFeature(popup, containerId) {\n    if ('datavizLayers' in lizMap.config) {\n      // build selector\n      var selector = 'div.lizmapPopupContent div.lizmapPopupDiv';\n      if ( containerId )\n        selector = '#'+ containerId +' '+ selector;\n     $(selector).each(function(){\n        var mydiv = $(this);\n\n        // Do not add plots if already present\n        if( $(this).find('div.lizdataviz').length > 0 )\n            return true;\n\n        if ($(this).find('input.lizmap-popup-layer-feature-id:first').val()) {\n          var getLayerId = $(this).find('input.lizmap-popup-layer-feature-id:first').val().split('.');\n          var popupId = getLayerId[0] + '_' + getLayerId[1];\n          var layerId = getLayerId[0];\n          var fid = getLayerId[1];\n\n          var getLayerConfig = lizMap.getLayerConfigById( layerId );\n\n          // verifiying  related children objects\n          if ( !getLayerConfig )\n              return true;\n          var featureType = getLayerConfig[0];\n\n          // We do not want to deactivate the display of filtered children dataviz\n          // when children popup are not displayed : comment the 2 following lines\n          if ( !('relations' in lizMap.config) || !(layerId in lizMap.config.relations) )\n              return true;\n\n          //If dataviz exists, get config\n          if( !('datavizLayers' in lizMap.config ))\n              return true;\n\n          lizMap.getLayerFeature(featureType, fid, function(feat) {\n                // Where there is all plots\n                var plotLayers = lizMap.config.datavizLayers.layers;\n                var lrelations = lizMap.config.relations[layerId];\n                var nbPlotByLayer = 1;\n\n                for ( var i in plotLayers) {\n\n                    for(var x in lrelations){\n                      var rel = lrelations[x];\n                      // Id of the layer which is the child of layerId\n                      var getChildrenId = rel.referencingLayer;\n\n                      // Filter of the plot\n                      var filter = '\"' + rel.referencingField + '\" IN (\\''+feat.properties[rel.referencedField]+'\\')';\n\n\n                        if(plotLayers[i].layer_id==getChildrenId)\n                        {\n                            var plot_config=plotLayers[i];\n                            if('popup_display_child_plot' in plot_config\n                              && plot_config.popup_display_child_plot == \"True\"\n                            ){\n                              var plot_id=plotLayers[i].plot_id;\n                              popupId = getLayerId[0] + '_' + getLayerId[1] + '_' + String(nbPlotByLayer);\n                              // Be sure the id is unique ( popup can be displayed in atlas tool too)\n                              popupId+= '_' + new Date().valueOf()+btoa(Math.random()).substring(0,12);\n                              var phtml = lizDataviz.buildPlotContainerHtml(\n                                  plot_config.title,\n                                  plot_config.abstract,\n                                  popupId,\n                                  false\n                              );\n                              var html = '<div class=\"lizmapPopupChildren lizdataviz\">';\n                              html+= '<h4>'+ plot_config.title+'</h4>';\n                              html+= phtml\n                              html+= '</div>';\n                              var haspc = $(mydiv).find('div.lizmapPopupChildren:last');\n                              if( haspc.length > 0 )\n                                  $(haspc).after(html);\n                              else\n                                  $(mydiv).append(html);\n                              lizDataviz.getPlot(plot_id, filter, popupId);\n                              nbPlotByLayer++;\n                            }\n                        }\n                    }\n                }\n          });\n        }\n      });\n    }else{\n      return false;\n    }\n  }\n\n  function addChildrenFeatureInfo( popup, containerId ) {\n      var selector = 'div.lizmapPopupContent input.lizmap-popup-layer-feature-id';\n      if ( containerId )\n        selector = '#'+ containerId +' '+ selector;\n      $(selector).each(function(){\n        var self = $(this);\n        var val = self.val();\n        var fid = val.split('.').pop();\n        var layerId = val.replace( '.' + fid, '' );\n\n        var getLayerConfig = getLayerConfigById( layerId );\n\n        // verifiying  related children objects\n        if ( !getLayerConfig )\n            return true;\n        var layerConfig = getLayerConfig[1];\n        var featureType = getLayerConfig[0];\n        if ( !('popupDisplayChildren' in layerConfig) || layerConfig.popupDisplayChildren != 'True')\n            return true;\n        if ( !('relations' in config) || !(layerId in config.relations) )\n            return true;\n\n        // Display related children objects\n        var relations = config.relations[layerId];\n        var popupMaxFeatures = 10;\n        if ( 'popupMaxFeatures' in layerConfig && !isNaN(parseInt(layerConfig.popupMaxFeatures)) )\n            popupMaxFeatures = parseInt(layerConfig.popupMaxFeatures);\n        popupMaxFeatures == 0 ? 10 : popupMaxFeatures;\n        getLayerFeature(featureType, fid, function(feat) {\n\n          // Array of Promise w/ fetch to request children popup content\n          const popupChidrenRequests = [];\n          const rConfigLayerAll = [];\n\n          // Build POST query for every child based on QGIS relations\n          for ( const relation of relations ){\n              const rLayerId = relation.referencingLayer;\n              const rGetLayerConfig = getLayerConfigById( rLayerId );\n              if ( rGetLayerConfig ) {\n                  const rConfigLayer = rGetLayerConfig[1];\n                  let clname = rConfigLayer?.shortname || rConfigLayer.cleanname;\n                  if ( clname === undefined ) {\n                      clname = cleanName(configLayer.name);\n                      rConfigLayer.cleanname = clname;\n                  }\n                  if ( rConfigLayer.popup == 'True' && self.parent().find('div.lizmapPopupChildren.'+clname).length == 0) {\n                      const wmsOptions = {\n                            'LAYERS': clname\n                          ,'QUERY_LAYERS': clname\n                          ,'STYLES': ''\n                          ,'SERVICE': 'WMS'\n                          ,'VERSION': '1.3.0'\n                          ,'CRS': (('crs' in rConfigLayer) && rConfigLayer.crs != '') ? rConfigLayer.crs : 'EPSG:4326'\n                          ,'REQUEST': 'GetFeatureInfo'\n                          ,'EXCEPTIONS': 'application/vnd.ogc.se_inimage'\n                          ,'FEATURE_COUNT': popupMaxFeatures\n                          ,'INFO_FORMAT': 'text/html'\n                      };\n\n                      if ( 'popupMaxFeatures' in rConfigLayer && !isNaN(parseInt(rConfigLayer.popupMaxFeatures)) )\n                          wmsOptions['FEATURE_COUNT'] = parseInt(rConfigLayer.popupMaxFeatures);\n                      if ( wmsOptions['FEATURE_COUNT'] == 0 )\n                          wmsOptions['FEATURE_COUNT'] = popupMaxFeatures;\n                      if ( rConfigLayer.request_params && rConfigLayer.request_params.filter &&\n                            rConfigLayer.request_params.filter !== '' )\n                          wmsOptions['FILTER'] = rConfigLayer.request_params.filter+' AND \"'+relation.referencingField+'\" = \\''+feat.properties[relation.referencedField]+'\\'';\n                      else\n                          wmsOptions['FILTER'] = clname+':\"'+relation.referencingField+'\" = \\''+feat.properties[relation.referencedField]+'\\'';\n\n                    var parentDiv = self.parent();\n\n                    // Fetch queries\n                    var service = OpenLayers.Util.urlAppend(lizUrls.wms\n                      , OpenLayers.Util.getParameterString(lizUrls.params)\n                    );\n\n                    // Keep `rConfigLayer` in array with same order that fetch queries\n                    // for later user when Promise.allSettled resolves\n                    rConfigLayerAll.push(rConfigLayer);\n                    popupChidrenRequests.push(\n                      fetch(service, {\n                        \"method\": \"POST\",\n                        \"body\": new URLSearchParams(wmsOptions)\n                      }).then(function (response) {\n                        return response.text();\n                      })\n                    );\n                  }\n              }\n          }\n\n          // Fetch GetFeatureInfo query for every children popups\n          Promise.allSettled(popupChidrenRequests).then(popupChildrenData => {\n\n            childPopupElements = [];\n\n            for (let index = 0; index < popupChildrenData.length; index++) {\n              let popupChildData = popupChildrenData[index].value;\n\n              var hasPopupContent = (!(!popupChildData || popupChildData == null || popupChildData == ''))\n              if (hasPopupContent) {\n                var popupReg = new RegExp('lizmapPopupTable', 'g');\n                popupChildData = popupChildData.replace(popupReg, 'table table-condensed table-striped lizmapPopupTable');\n\n                const configLayer = rConfigLayerAll[index];\n\n                var clname = configLayer.cleanname;\n                if (clname === undefined) {\n                  clname = cleanName(configLayer.name);\n                  configLayer.cleanname = clname;\n                }\n                var childPopup = $('<div class=\"lizmapPopupChildren ' + clname + '\" data-layername=\"' + clname + '\" data-title=\"' + configLayer.title + '\">' + popupChildData + '</div>');\n\n                //Manage if the user choose to create a table for children\n                if (['qgis', 'form'].indexOf(configLayer.popupSource) !== -1 &&\n                  childPopup.find('.lizmap_merged').length != 0) {\n                  // save inputs\n                  childPopup.find(\".lizmapPopupDiv\").each(function (i, e) {\n                    var popupDiv = $(e);\n                    if (popupDiv.find(\".lizmapPopupHeader\").prop(\"tagName\") == 'TR') {\n                      popupDiv.find(\".lizmapPopupHeader\").prepend(\"<th></th>\");\n                      popupDiv.find(\".lizmapPopupHeader\").next().prepend(\"<td></td>\");\n                    } else {\n                      popupDiv.find(\".lizmapPopupHeader\").next().prepend(\"<span></span>\");\n                    }\n                    popupDiv.find(\".lizmapPopupHeader\").next().children().first().append(popupDiv.find(\"input\"));\n                  });\n\n                  childPopup.find(\"h4\").each(function (i, e) {\n                    if (i != 0)\n                      $(e).remove();\n                  });\n\n                  childPopup.find(\".lizmapPopupHeader\").each(function (i, e) {\n                    if (i != 0)\n                      $(e).remove();\n                  });\n\n                  childPopup.find(\".lizmapPopupDiv\").contents().unwrap();\n                  childPopup.find(\".lizmap_merged\").contents().unwrap();\n                  childPopup.find(\".lizmapPopupDiv\").remove();\n                  childPopup.find(\".lizmap_merged\").remove();\n\n                  childPopup.find(\".lizmapPopupHidden\").hide();\n\n                  var tChildPopup = $(\"<table class='lizmap_merged'></table>\");\n                  childPopup.append(tChildPopup);\n                  childPopup.find('tr').appendTo(tChildPopup);\n\n                  childPopup.children('tbody').remove();\n                }\n\n                var oldPopupChild = parentDiv.find('div.lizmapPopupChildren.' + clname);\n                if (oldPopupChild.length != 0){\n                  oldPopupChild.remove();\n                }\n\n                parentDiv.append(childPopup);\n\n                childPopupElements.push(childPopup);\n\n                // Trigger event for single popup children\n                lizMap.events.triggerEvent(\n                  \"lizmappopupchildrendisplayed\",\n                  { 'html': childPopup.html() }\n                );\n              }\n            }\n            // Trigger event for all popup children\n            lizMap.events.triggerEvent(\n              \"lizmappopupallchildrendisplayed\",\n              {\n                parentPopupElement: self.parents('.lizmapPopupSingleFeature'),\n                childPopupElements: childPopupElements\n              }\n            );\n          });\n        });\n      });\n  }\n\n  function addFeatureInfo() {\n      // Verifying layers\n      var popupsAvailable = false;\n      for ( var l in config.layers ) {\n          var configLayer = config.layers[l];\n          var editionLayer = null;\n          if ( ('editionLayers' in config) && (l in config.editionLayers) )\n              editionLayer = config.editionLayers[l];\n          if( (configLayer && configLayer.popup && configLayer.popup == 'True')\n           || (editionLayer && ( editionLayer.capabilities.modifyGeometry == 'True'\n                              || editionLayer.capabilities.modifyAttribute == 'True'\n                              || editionLayer.capabilities.deleteFeature == 'True') ) ){\n              popupsAvailable = true;\n              break;\n          }\n      }\n      if ( !popupsAvailable )\n        return null;\n\n      // Create the dock if needed\n      if( 'popupLocation' in config.options &&\n          config.options.popupLocation != 'map' &&\n          !$('#mapmenu .nav-list > li.popupcontent > a').length ) {\n          // Verifying the message\n          if ( !('popup.msg.start' in lizDict) )\n            lizDict['popup.msg.start'] = 'Click to the map to get informations.';\n          // Initialize dock\n          var popupContainerId = 'popupcontent';\n          var pcontent = '<div class=\"lizmapPopupContent\"><h4>'+lizDict['popup.msg.start']+'</h4></div>';\n          addDock(popupContainerId, 'Popup', config.options.popupLocation, pcontent, 'icon-comment');\n          $('#button-popupcontent').click(function(){\n              if($(this).parent().hasClass('active')) {\n                  // clean locate layer\n                  clearDrawLayer('locatelayer');\n                  // remove information\n                  $('#popupcontent div.menu-content').html('<div class=\"lizmapPopupContent\"><h4>'+lizDict['popup.msg.start']+'</h4></div>');\n              }\n          });\n\n      }\n\n      var fiurl = OpenLayers.Util.urlAppend(\n        lizUrls.wms,\n        OpenLayers.Util.getParameterString(lizUrls.params)\n      )\n      var lastLonLatInfo = null;\n      var info = new OpenLayers.Control.WMSGetFeatureInfo({\n            url: fiurl,\n            title: 'Identify features by clicking',\n            type:OpenLayers.Control.TYPE_TOGGLE,\n            queryVisible: true,\n            infoFormat: 'text/html',\n            vendorParams: getFeatureInfoTolerances(),\n            handlerOptions: {\n              click: {\n                pixelTolerance: 10\n              }\n            },\n            eventListeners: {\n                getfeatureinfo: function(event) {\n                    var eventLonLatInfo = map.getLonLatFromPixel(event.xy);\n                    var text = event.text;\n\n                    if (map.popups.length != 0)\n                        map.removePopup(map.popups[0]);\n\n                    var popup = null;\n                    var popupContainerId = null;\n                    if( 'popupLocation' in config.options && config.options.popupLocation != 'map' ){\n                      popupContainerId = 'popupcontent';\n\n                      // create content\n                      var popupReg = new RegExp('lizmapPopupTable', 'g');\n                      text = text.replace( popupReg, 'table table-condensed table-striped table-bordered lizmapPopupTable');\n                      var pcontent = '<div class=\"lizmapPopupContent\">'+text+'</div>';\n                      var hasPopupContent = (!(!text || text == null || text == ''));\n                      $('#popupcontent div.menu-content').html(pcontent);\n                      if ( !$('#mapmenu .nav-list > li.popupcontent').is(':visible') )\n                        $('#mapmenu .nav-list > li.popupcontent').show();\n\n                      // Warn user no data has been found\n                      if( !hasPopupContent ){\n                        pcontent = '<div class=\"lizmapPopupContent\"><h4>'+lizDict['popup.msg.no.result']+'</h4></div>';\n                        $('#popupcontent div.menu-content').html(pcontent);\n                        window.setTimeout(function(){\n                            if ( $('#mapmenu .nav-list > li.popupcontent').hasClass('active') && config.options.popupLocation != 'right-dock')\n                                $('#button-popupcontent').click();\n                        },2000);\n                      }\n\n                      // Display dock if needed\n                      if(\n                        !$('#mapmenu .nav-list > li.popupcontent').hasClass('active')\n                         && (!mCheckMobile() || ( mCheckMobile() && hasPopupContent ) )\n                         && (lastLonLatInfo == null || eventLonLatInfo.lon != lastLonLatInfo.lon || eventLonLatInfo.lat != lastLonLatInfo.lat)\n                      ){\n                          $('#button-popupcontent').click();\n                      }\n                      else if(\n                        $('#mapmenu .nav-list > li.popupcontent').hasClass('active')\n                         && ( mCheckMobile() && hasPopupContent )\n                      ){\n                          $('#button-popupcontent').click();\n                      }\n                      // Resize minidock if displayed\n                      if ( $('#mapmenu .nav-list > li.popupcontent').hasClass('active') && config.options.popupLocation == 'minidock' )\n                          updateMiniDockSize();\n\n                    }\n                    else{\n                      if (!text || text == null || text == '')\n                          return false;\n                      // Use openlayers map popup anchored\n                      popupContainerId = \"liz_layer_popup\";\n                      popup = new OpenLayers.Popup.LizmapAnchored(\n                          popupContainerId,\n                          eventLonLatInfo,\n                          null,\n                          text,\n                          null,\n                          true,\n                          function() {\n                            map.removePopup(this);\n                            if(mCheckMobile()){\n                              $('#navbar').show();\n                              $('#overview-box').show();\n                            }\n\n                            // clean locate layer\n                            clearDrawLayer('locatelayer');\n                            return false;\n                          }\n                      );\n                      popup.panMapIfOutOfView = true;\n                      map.addPopup(popup);\n\n                      // Activate Boostrap 2 tabs here as they are not\n                      // automatically activated when created in popup anchored\n                      $('#' + popupContainerId + ' a[data-toggle=\"tab\"]').on( 'click',function (e) {\n                        e.preventDefault();\n                        $(this).tab('show');\n                      });\n\n                      popup.verifySize();\n                      // Hide navbar and overview in mobile mode\n                      if(mCheckMobile()){\n                          $('#navbar').hide();\n                          $('#overview-box').hide();\n                      }\n                    }\n                    lastLonLatInfo = eventLonLatInfo;\n\n                    // Display related children objects\n                    addChildrenFeatureInfo( popup, popupContainerId );\n                    // Display geometries\n                    addGeometryFeatureInfo( popup, popupContainerId );\n                    // Display the plots of the children layers features filtered by popup item\n                    addChildrenDatavizFilteredByPopupFeature( popup, popupContainerId );\n\n                    // Trigger event\n                    lizMap.events.triggerEvent(\"lizmappopupdisplayed\",\n                        {'popup': popup, 'containerId': popupContainerId}\n                    );\n                }\n            }\n     });\n     if (lizUrls.publicUrlList && lizUrls.publicUrlList.length != 0 ) {\n        var layerUrls = [];\n        for (var j=0, jlen=lizUrls.publicUrlList.length; j<jlen; j++) {\n          layerUrls.push(\n            OpenLayers.Util.urlAppend(\n              lizUrls.publicUrlList[j],\n              OpenLayers.Util.getParameterString(lizUrls.params)\n            )\n          );\n        }\n        info.layerUrls = layerUrls;\n     }\n     info.findLayers = function() {\n        var candidates = this.layers || this.map.layers;\n        var layers = [];\n        var maxFeatures = 0;\n        var layer, url;\n        for(var i=0, len=candidates.length; i<len; ++i) {\n            layer = candidates[i];\n            if( (layer instanceof OpenLayers.Layer.WMS || layer instanceof OpenLayers.Layer.WMTS)\n             && (!this.queryVisible || (layer.getVisibility() && layer.calculateInRange())) ) {\n                var qgisName = null;\n                if ( layer.name in cleanNameMap )\n                    qgisName = getLayerNameByCleanName(layer.name);\n                var configLayer = null;\n                if ( qgisName )\n                    configLayer = config.layers[qgisName];\n                if ( !configLayer )\n                    configLayer = config.layers[layer.params['LAYERS']];\n                if ( !configLayer )\n                    configLayer = config.layers[layer.name];\n                 var editionLayer = null;\n                 if( 'editionLayers' in config ) {\n                     editionLayer = config.editionLayers[qgisName];\n                     if ( !editionLayer )\n                        editionLayer = config.editionLayers[layer.params['LAYERS']];\n                     if ( !editionLayer )\n                        editionLayer = config.editionLayers[layer.name];\n                 }\n                 if( (configLayer && configLayer.popup && configLayer.popup == 'True')\n                  || (editionLayer && ( editionLayer.capabilities.modifyGeometry == 'True'\n                                     || editionLayer.capabilities.modifyAttribute == 'True'\n                                     || editionLayer.capabilities.deleteFeature == 'True') ) ){\n                    url = OpenLayers.Util.isArray(layer.url) ? layer.url[0] : layer.url;\n                    // if the control was not configured with a url, set it\n                    // to the first layer url\n                    if(this.drillDown === false && !this.url) {\n                        this.url = url;\n                    }\n\n                    layers.push(layer);\n                    if ( 'popupMaxFeatures' in configLayer && !isNaN(parseInt(configLayer.popupMaxFeatures)) )\n                        maxFeatures += parseInt(configLayer.popupMaxFeatures);\n                    else\n                        maxFeatures += 10;\n                 }\n            }\n        }\n        this.maxFeatures = maxFeatures == 0 ? 10 : maxFeatures;\n        return layers;\n     };\n     function refreshGetFeatureInfo( evt ) {\n         if ( !evt.updateDrawing )\n            return;\n        if ( lastLonLatInfo == null )\n            return true;\n        var lastPx = map.getPixelFromLonLat(lastLonLatInfo);\n        if ( $('#liz_layer_popup  div.lizmapPopupContent').length < 1\n          && $('#popupcontent div.menu-content div.lizmapPopupContent').length < 1)\n            return;\n\n        var popupContainerId = \"liz_layer_popup\";\n        if ( $('#'+popupContainerId+' div.lizmapPopupContent input.lizmap-popup-layer-feature-id').length == 0 )\n            popupContainerId = 'popupcontent';\n\n        // Refresh if needed\n        var refreshInfo = false;\n        $('#'+popupContainerId+' div.lizmapPopupContent input.lizmap-popup-layer-feature-id').each(function(){\n            var self = $(this);\n            var val = self.val();\n            var fid = val.split('.').pop();\n            var layerId = val.replace( '.' + fid, '' );\n            var aConfig = lizMap.getLayerConfigById( layerId );\n            if ( aConfig && aConfig[0] == evt.featureType ) {\n                refreshInfo = true;\n                return false;\n            }\n        });\n        if ( refreshInfo  ) {\n            //lastLonLatInfo = null;\n            $('#'+popupContainerId+' div.lizmapPopupContent input.lizmap-popup-layer-feature-id[value=\"'+evt.layerId+'.'+evt.featureId+'\"]').parent().remove();\n            info.request( lastPx, {} );\n        }\n        return;\n     }\n     lizMap.events.on({\n        \"layerFilterParamChanged\": function( evt ) {\n            var filter = [];\n            for ( var  lName in config.layers ) {\n                var lConfig = config.layers[lName];\n                if ( lConfig.popup != 'True' )\n                    continue;\n                if ( !('request_params' in lConfig)\n                  || lConfig['request_params'] == null )\n                    continue;\n                var requestParams = lConfig['request_params'];\n                if ( ('filter' in lConfig['request_params'])\n                  && lConfig['request_params']['filter'] != null\n                  && lConfig['request_params']['filter'] != \"\" ) {\n\n                    // Get filter token\n                    var surl = OpenLayers.Util.urlAppend(lizUrls.wms\n                        ,OpenLayers.Util.getParameterString(lizUrls.params)\n                    );\n                    var sdata = {\n                        service: 'WMS',\n                        request: 'GETFILTERTOKEN',\n                        typename: lName,\n                        filter: lConfig['request_params']['filter']\n                    };\n                    $.post(surl, sdata, function(result){\n                        filter.push(result.token);\n                        info.vendorParams['filtertoken'] = filter.join(';');\n                        info.vendorParams['filter'] = null;\n                        refreshGetFeatureInfo(evt);\n                    });\n                }else{\n                      info.vendorParams['filtertoken'] = requestParams['filtertoken'];\n                      info.vendorParams['filter'] = requestParams['filter'];\n                }\n            }\n        },\n        \"layerSelectionChanged\": function( evt ) {\n            refreshGetFeatureInfo(evt);\n        },\n        \"lizmapeditionfeaturedeleted\": function( evt ) {\n            if ( $('div.lizmapPopupContent input.lizmap-popup-layer-feature-id').length > 1 ) {\n                refreshGetFeatureInfo(evt);\n            } else {\n                if (map.popups.length != 0)\n                    map.removePopup(map.popups[0]);\n\n                if( 'popupLocation' in config.options && config.options.popupLocation != 'map' ){\n                    var pcontent = '<div class=\"lizmapPopupContent\"><h4>'+lizDict['popup.msg.no.result']+'</h4></div>';\n                    $('#popupcontent div.menu-content').html(pcontent);\n                    if ( $('#mapmenu .nav-list > li.popupcontent').hasClass('active') )\n                        $('#button-popupcontent').click();\n                    if ( !$('#mapmenu .nav-list > li.popupcontent').hasClass('active') )\n                        $('#mapmenu .nav-list > li.popupcontent').hide();\n                }\n            }\n        }\n     });\n     map.addControl(info);\n     info.activate();\n     return info;\n  }\n\n  function getPrintScale( aScales ) {\n      var newScales = [];\n      for ( var i=0, len = aScales.length; i<len; i++ ) {\n          newScales.push( parseFloat(aScales[i]) );\n      }\n      newScales.sort(function(a,b){return b-a;});\n    var scale = map.getScale();\n  var scaleIdx = $.inArray( scale, newScales );\n    if ( scaleIdx == -1 ) {\n    var s=0, slen=newScales.length;\n    while ( scaleIdx == -1 && s<slen ) {\n      if ( scale > newScales[s] )\n        scaleIdx = s;\n      else\n       s++;\n    }\n    if( s == slen ) {\n      scale = newScales[slen-1];\n    } else {\n      scale = newScales[scaleIdx];\n    }\n    }\n    return scale;\n  }\n\n  function drawPrintBox( aLayout, aLayer, aScale ) {\n    var size = aLayout.size;\n    var units = map.getUnits();\n    var unitsRatio = OpenLayers.INCHES_PER_UNIT[units];\n    var w = size.width / 72 / unitsRatio * aScale / 2;\n    var h = size.height / 72 / unitsRatio * aScale / 2;\n    var printInProjectProjection = true;\n    if ('printInProjectProjection' in lizMap.config.options && lizMap.config.options.printInProjectProjection != 'True') {\n      printInProjectProjection = false;\n    }\n    if (printInProjectProjection\n      && lizMap.config.options.qgisProjectProjection.ref != lizMap.config.options.projection.ref\n    ) {\n      // If we change the projection, we need to increase a little bit the size of the rectangle\n      var qgis_dpi = 96;\n      w = w * qgis_dpi / 72;\n      h = h * qgis_dpi / 72;\n    }\n    if ( aLayer.features.length == 0 ) {\n        var center = map.getCenter();\n        var bounds = new OpenLayers.Bounds(center.lon - w, center.lat - h,\n            center.lon + w, center.lat + h);\n        var geom = bounds.toGeometry();\n        aLayer.addFeatures([\n            new OpenLayers.Feature.Vector( geom )\n        ]);\n    } else {\n        var feat = aLayer.features[0];\n        var center = feat.geometry.getBounds().getCenterLonLat();\n        var bounds = new OpenLayers.Bounds(center.lon - w, center.lat - h,\n            center.lon + w, center.lat + h);\n        var geom = bounds.toGeometry();\n        geom.id = feat.geometry.id;\n        feat.geometry = geom;\n        aLayer.drawFeature(feat);\n    }\n    return true;\n  }\n\n  function getPrintGridInterval( aLayout, aScale, aScales ) {\n    var size = aLayout.size;\n    var units = map.getUnits();\n    var unitsRatio = OpenLayers.INCHES_PER_UNIT[units];\n    var w = size.width / 72 / unitsRatio * aScale;\n    var h = size.height / 72 / unitsRatio * aScale;\n    var printInProjectProjection = true;\n    if ('printInProjectProjection' in lizMap.config.options && lizMap.config.options.printInProjectProjection != 'True') {\n      printInProjectProjection = false;\n    }\n    if (printInProjectProjection\n      && lizMap.config.options.qgisProjectProjection.ref != lizMap.config.options.projection.ref\n    ) {\n      // If we change the projection, we need to increase a little bit the size of the rectangle\n      var qgis_dpi = 96;\n      w = w * qgis_dpi / 72;\n      h = h * qgis_dpi / 72;\n    }\n\n      var refScale = w > h ? w : h;\n      var newScales = [];\n      for ( var i=0, len = aScales.length; i<len; i++ ) {\n          newScales.push( parseFloat(aScales[i]) );\n      }\n      newScales.sort(function(a,b){return b-a;});\n      var theScale = newScales[0];\n      for ( var i=0, len=newScales.length; i<len; i++ ) {\n          var s = newScales[i];\n          if ( s > refScale )\n            theScale = s;\n          if ( s < refScale )\n            break;\n      }\n      return theScale/10;\n  }\n  function addPrintControl() {\n    if ( !config['printTemplates'] || config.printTemplates.length == 0 ) {\n      $('#button-print').parent().remove();\n      return false;\n    }\n\n    // Filtering print templates by removing atlas ones\n    var pTemplates = [];\n    for( var i=0, len=config.printTemplates.length; i<len; i++ ){\n        var pTemplate = config.printTemplates[i];\n        if('atlas' in pTemplate\n          && 'enabled' in pTemplate.atlas\n          && (pTemplate.atlas.enabled === '1' || pTemplate.atlas.enabled === 'true'))\n            continue;\n        pTemplates.push(pTemplate);\n    }\n    // remove print tool if only atlas print configured\n    if ( pTemplates.length == 0 ) {\n      $('#button-print').parent().remove();\n      return false;\n    }\n\n    var ptTomm = 0.35277; //conversion pt to mm\n\n    var scales = map.scales;\n    if ( config.options.mapScales.length > 2 )\n      scales = config.options.mapScales;\n    if ( scales == null && map.resolutions != null ) {\n      scales = [];\n      for( var i=0, len=map.resolutions.length; i<len; i++ ){\n        var units = map.getUnits();\n        var res = map.resolutions[i];\n        var scale = OpenLayers.Util.getScaleFromResolution(res, units);\n        scales.push(scale);\n      }\n    }\n    if ( scales == null ) {\n      $('#button-print').parent().remove();\n      return false;\n    }\n    if ( scales[0] < scales[scales.length-1] )\n      scales.reverse();\n\n    var scaleOptions = '';\n    for( var i=0, len=scales.length; i<len; i++ ){\n        var scale = scales[i];\n        printCapabilities.scales.push(scale);\n        var scaleText = scale;\n        if (scaleText > 10)\n            scaleText = Math.round(scaleText)\n        else\n            scaleText = Math.round(scaleText*100)/100\n        scaleText = scaleText.toLocaleString()\n        scaleOptions += '<option value=\"'+scale+'\">'+scaleText+'</option>';\n    }\n    $('#print-scale').html(scaleOptions);\n\n    // creating printCapabilities layouts\n    for( var i=0, len=pTemplates.length; i<len; i++ ){\n      var pTemplate = pTemplates[i];\n      var pMap = null;\n      var pMapIdx = 0;\n      var pOverview = null;\n      while( pMap == null && pMapIdx < pTemplate.maps.length) {\n        pMap = pTemplate.maps[pMapIdx];\n        if( pMap['overviewMap'] ) {\n          pOverview = pTemplate.maps[pMapIdx];\n          pMap = null;\n          pMapIdx += 1;\n        }\n      }\n      if ( pMap == null )\n        continue;\n      var mapWidth = Number(pMap.width) / ptTomm;\n      var mapHeight = Number(pMap.height) / ptTomm;\n      //for some strange reason we need to provide a \"map\" and a \"size\" object with identical content\n      printCapabilities.layouts.push({\n        \"name\": pTemplate.title,\n        \"map\": {\n          \"width\": mapWidth,\n          \"height\": mapHeight\n        },\n        \"size\": {\n          \"width\": mapWidth,\n          \"height\": mapHeight\n        },\n        \"rotation\": false,\n        \"template\": pTemplate,\n        \"mapId\": pMap.id,\n        \"overviewId\": pOverview != null ? pOverview.id : null,\n        \"grid\": (('grid' in pMap) && pMap.grid == \"True\")\n      });\n    }\n\n    // if no printCapabilities layouts removed print\n    if( printCapabilities.layouts.length == 0 ) {\n      $('#button-print').parent().remove();\n      return false;\n    }\n\n    // creating the print layer\n    var layer = map.getLayersByName('Print');\n    if ( layer.length == 0 ) {\n      layer = new OpenLayers.Layer.Vector('Print',{\n        styleMap: new OpenLayers.StyleMap({\n          \"default\": new OpenLayers.Style({\n            fillColor: \"#D43B19\",\n            fillOpacity: 0.2,\n            strokeColor: \"#CE1F2D\",\n            strokeWidth: 1\n          })\n        })\n      });\n      map.addLayer(layer);\n      layer.setVisibility(false);\n    } else\n      layer = layer[0];\n\n    // creating print menu\n    for( var i=0, len= printCapabilities.layouts.length; i<len; i++ ){\n      var layout = printCapabilities.layouts[i];\n      $('#print-template').append('<option value=\"'+i+'\">'+layout.name+'</option>');\n    }\n\n    var dragCtrl = new OpenLayers.Control.DragFeature(layer,{\n      geometryTypes: ['OpenLayers.Geometry.Polygon'],\n      type:OpenLayers.Control.TYPE_TOOL,\n      layout: null,\n      eventListeners: {\n        \"activate\": function(evt) {\n          if (this.layout == null)\n            return false;\n\n          deactivateToolControls(evt);\n\n          var layout = this.layout;\n          // get print scale\n          var scale = getPrintScale( printCapabilities.scales );\n          // update the select\n          $('#print-scale').val(scale);\n          // draw print box\n          drawPrintBox( layout, layer, scale );\n\n          mAddMessage(lizDict['print.activate'],'info',true).addClass('print');\n          layer.setVisibility(true);\n        },\n        \"deactivate\": function() {\n          layer.setVisibility(false);\n          $('#message .print').remove();\n          this.layout = null;\n          layer.destroyFeatures();\n        }\n      }\n    });\n    map.addControls([dragCtrl]);\n    controls['printDrag'] = dragCtrl;\n\n    // set event listener to button-print\n    $('#print-template').change(function() {\n      var self = $(this);\n      var layout = printCapabilities.layouts[parseInt( self.val() )];\n      if ( layout.template.labels.length != 0 ) {\n        var labels = '';\n        for (var i=0, len=layout.template.labels.length; i<len; i++){\n          var tLabel = layout.template.labels[i];\n          var label = '';\n          if (tLabel.htmlState == 0) {\n            label = '<input type=\"text\" name=\"'+tLabel.id+'\" class=\"print-label\" placeholder=\"'+tLabel.text+'\" value=\"'+tLabel.text+'\"><br>'\n          } else {\n            label = '<textarea name=\"'+tLabel.id+'\" class=\"print-label\" placeholder=\"'+tLabel.text+'\">'+tLabel.text+'</textarea><br>'\n          }\n          labels += label;\n        }\n        $('#print .print-labels').html(labels);\n        $('#print .print-labels').show();\n      } else {\n        $('#print .print-labels').html('');\n        $('#print .print-labels').hide();\n      }\n      updateMiniDockSize();\n      if (dragCtrl.active) {\n        dragCtrl.deactivate();\n        dragCtrl.layout = layout;\n        dragCtrl.activate();\n      } else {\n        dragCtrl.layout = layout;\n        dragCtrl.activate();\n      }\n      return false;\n    });\n\n    $('#print button.btn-print-clear').click(function() {\n      $('#button-print').click();\n      return false;\n    });\n    $('#print-scale').change(function() {\n      if ( dragCtrl.active && layer.getVisibility() ) {\n        var self = $(this);\n        var scale = parseFloat(self.val());\n        // draw print box\n        drawPrintBox( dragCtrl.layout, layer, scale );\n      }\n    });\n    $('#print-launch').click(function() {\n      var pTemplate = dragCtrl.layout.template;\n      var pTableVectorLayers = [];\n      if( 'tables' in pTemplate )\n          pTableVectorLayers = $.map( pTemplate.tables, function( t ){\n              if( t.composerMap == -1 || ('map'+t.composerMap) == dragCtrl.layout.mapId )\n                return t.vectorLayer;\n          });\n      // Print Extent\n      // Clone it to fix transform\n      var extent = new OpenLayers.Bounds(\n          dragCtrl.layer.features[0].geometry.getBounds().toArray()\n      );\n\n      // Projection code and reverseAxisOrder\n      var projCode = map.projection.getCode();\n      var project_projection = null;\n      // We print the map in the QGIS project projection, not in the web map projection\n      // This allow to avoid error of wrong scales when using external baselayers in EPSG:3857\n      // and the project in for example in Lambert 93\n      // Caveat: the map printed does not exactly matches the drawn rectangle\n      var printInProjectProjection = true;\n      if ('printInProjectProjection' in lizMap.config.options && lizMap.config.options.printInProjectProjection != 'True') {\n        printInProjectProjection = false;\n      }\n      if (printInProjectProjection\n        && lizMap.config.options.qgisProjectProjection.ref != lizMap.config.options.projection.ref\n      ) {\n        // If we print in the QGIS project projection\n        var project_proj = config.options.qgisProjectProjection;\n        if (!(project_proj.ref in Proj4js.defs)) {\n          Proj4js.defs[project_proj.ref]=project_proj.proj4;\n        }\n        project_projection = new OpenLayers.Projection(project_proj.ref);\n        projCode = project_projection.getCode();\n\n        // Reproject extent\n        extent.transform(map.projection, project_projection);\n      }\n\n      var reverseAxisOrder = (OpenLayers.Projection.defaults[projCode] && OpenLayers.Projection.defaults[projCode].yx);\n\n      // Build URL\n      var url = OpenLayers.Util.urlAppend(lizUrls.wms\n          ,OpenLayers.Util.getParameterString(lizUrls.params)\n          );\n      let printParams = {};\n      printParams['SERVICE'] = 'WMS';\n      printParams['VERSION'] = '1.3.0';\n      printParams['REQUEST'] = 'GetPrint';\n      printParams['FORMAT'] = document.querySelector('#print-format').value;\n      printParams['EXCEPTIONS'] = 'application/vnd.ogc.se_inimage';\n      printParams['TRANSPARENT'] = 'true';\n      printParams['SRS'] = projCode;\n      printParams['DPI'] = document.querySelector('#print-dpi').value;\n      printParams['TEMPLATE'] = pTemplate.title;\n      printParams[dragCtrl.layout.mapId + ':extent'] = extent.toBBOX(null, reverseAxisOrder);\n      printParams[dragCtrl.layout.mapId + ':scale'] = document.querySelector('#print-scale').value;\n\n      if ( 'grid' in dragCtrl.layout && dragCtrl.layout.grid ) {\n        var gridInterval = getPrintGridInterval( dragCtrl.layout, parseFloat(scale), printCapabilities.scales );\n        printParams[dragCtrl.layout.mapId + ':grid_interval_x='] = gridInterval;\n        printParams[dragCtrl.layout.mapId + ':grid_interval_y='] = gridInterval;\n      }\n\n      var printLayers = [];\n      var styleLayers = [];\n      var opacityLayers = [];\n      $.each(map.layers, function(i, l) {\n        if ( (l instanceof OpenLayers.Layer.WMS) || (l instanceof OpenLayers.Layer.WMTS) ){\n            if( l.getVisibility() && ('params' in l) && ('LAYERS' in l.params)) {\n              // Get config\n              var qgisName = null;\n              if ( l.name in cleanNameMap )\n                  qgisName = getLayerNameByCleanName(l.name);\n              var configLayer = null;\n              if ( qgisName )\n                  configLayer = config.layers[qgisName];\n              if ( !configLayer )\n                  configLayer = config.layers[l.params['LAYERS']];\n              if ( !configLayer )\n                  configLayer = config.layers[l.name];\n\n              // If the layer has no config it is not a QGIS layer\n              if ( !configLayer )\n                return;\n\n              // If the layer has no id it is not a QGIS layer or group\n              if (!('id' in configLayer))\n                return;\n\n              // Add layer to the list of printed layers\n              printLayers.push(l.params['LAYERS']);\n\n              // Optionnaly add layer style if needed (same order as layers )\n              var lst = 'default';\n              if ( 'qgisServerVersion' in config.options && config.options.qgisServerVersion.startsWith('3.') ) {\n                  lst = '';\n              }\n              if( 'STYLES' in l.params && l.params['STYLES'].length > 0 )\n                lst = l.params['STYLES'];\n              styleLayers.push( lst );\n\n              // Get qgis layer opacity\n              if ( configLayer && ('opacity' in configLayer) )\n                opacityLayers.push(parseInt(255*l.opacity*configLayer.opacity));\n              else\n                opacityLayers.push(parseInt(255*l.opacity));\n            }\n        }\n      });\n\n      printLayers.reverse();\n      styleLayers.reverse();\n      opacityLayers.reverse();\n\n      // Get active baselayer, and add the corresponding QGIS layer if needed\n      var activeBaseLayerName = map.baseLayer.name;\n      if ( activeBaseLayerName in externalBaselayersReplacement ) {\n        var exbl = externalBaselayersReplacement[activeBaseLayerName];\n        if( exbl in config.layers ) {\n            var activeBaseLayerConfig = config.layers[exbl];\n            if ( 'id' in activeBaseLayerConfig && 'useLayerIDs' in config.options && config.options.useLayerIDs == 'True' ){\n                printLayers.push(activeBaseLayerConfig.id);\n            }\n            else{\n                printLayers.push(exbl);\n            }\n            if ( 'qgisServerVersion' in config.options && config.options.qgisServerVersion.startsWith('3.') ) {\n                styleLayers.push('');\n            } else {\n                styleLayers.push('default');\n            }\n            opacityLayers.push(255);\n        }\n      }\n\n      // Add table vector layer without geom\n      if( pTableVectorLayers.length > 0 ) {\n          $.each( pTableVectorLayers, function( i, layerId ){\n              var aConfig = getLayerConfigById( layerId );\n              if( aConfig ) {\n                  var layerConfig = aConfig[1];\n                  if( ( layerConfig.geometryType == \"none\" || layerConfig.geometryType == \"unknown\" || layerConfig.geometryType == \"\" ) ) {\n                      if ( 'shortname' in layerConfig && layerConfig.shortname != '' )\n                          printLayers.push(layerConfig.shortname);\n                      else\n                          printLayers.push(layerConfig.name);\n                      if ( 'qgisServerVersion' in config.options &&\n                           config.options.qgisServerVersion.startsWith('3.') ) {\n                        styleLayers.push('');\n                      } else {\n                        styleLayers.push('default');\n                      }\n                      opacityLayers.push(255);\n                  }\n              }\n          });\n      }\n\n      if ( 'qgisServerVersion' in config.options && config.options.qgisServerVersion != '2.14' ) {\n        printLayers.reverse();\n        styleLayers.reverse();\n        opacityLayers.reverse();\n      }\n\n      printParams[dragCtrl.layout.mapId + ':LAYERS'] = printLayers.join(',');\n      printParams[dragCtrl.layout.mapId + ':STYLES'] = styleLayers.join(',');\n\n      if ( dragCtrl.layout.overviewId != null\n          && config.options.hasOverview ) {\n        var bbox = config.options.bbox;\n        var oExtent = new OpenLayers.Bounds(Number(bbox[0]),Number(bbox[1]),Number(bbox[2]),Number(bbox[3]));\n        if (printInProjectProjection\n          && lizMap.config.options.qgisProjectProjection.ref != lizMap.config.options.projection.ref\n        ) {\n          // If we print in the QGIS project projection\n          oExtent.transform(map.projection, project_projection);\n        }\n        printParams[dragCtrl.layout.overviewId + ':extent'] = oExtent;\n        printParams[dragCtrl.layout.overviewId + ':LAYERS'] = 'Overview';\n\n        if ( 'qgisServerVersion' in config.options && config.options.qgisServerVersion != '2.14' ) {\n            printLayers.push('Overview');\n            if ( config.options.qgisServerVersion.startsWith('3.') ) {\n                styleLayers.push('');\n            } else {\n                styleLayers.push('default');\n            }\n            opacityLayers.push(255);\n        } else {\n            printLayers.unshift('Overview');\n            styleLayers.unshift('default');\n            opacityLayers.unshift(255);\n        }\n      }\n      printParams['LAYERS'] = printLayers.join(',');\n      printParams['STYLES'] = styleLayers.join(',');\n      printParams['OPACITIES'] = opacityLayers.join(',');\n\n      const customPrintLabels = document.querySelectorAll('#print .print-labels .print-label');\n      if (customPrintLabels){\n        for (const label of customPrintLabels) {\n          printParams[label.name] = label.value;\n        }\n      }\n\n      var filter = [];\n      var selection = [];\n      for ( var  lName in config.layers ) {\n          var lConfig = config.layers[lName];\n          var requestParams = lConfig['request_params'];\n          if ( !('request_params' in lConfig)\n            || requestParams == null )\n              continue;\n            if ( ('filtertoken' in requestParams)\n            && requestParams['filtertoken'] != null\n            && requestParams['filtertoken'] != \"\" ) {\n              filter.push( requestParams['filtertoken'] );\n          }\n          if ( ('selectiontoken' in requestParams)\n            && requestParams['selectiontoken'] != null\n            && requestParams['selectiontoken'] != \"\" ) {\n              selection.push( requestParams['selectiontoken'] );\n          }\n      }\n      if ( filter.length !=0 ){\n        printParams['FILTERTOKEN'] = filter.join(';');\n      }\n      if ( selection.length !=0 ){\n        printParams['SELECTIONTOKEN'] = selection.join(';');\n      }\n\n      // if user has made a visible draw, print it with redlining\n      const formatWKT = new OpenLayers.Format.WKT();\n      const highlightGeom = [];\n      const highlightSymbol = [];\n      if (lizMap.mainLizmap.digitizing.featureDrawn && lizMap.mainLizmap.digitizing.featureDrawnVisibility){\n        for (let index = 0; index < lizMap.mainLizmap.digitizing.featureDrawn.length; index++) {\n          var draw_feature = lizMap.mainLizmap.digitizing.featureDrawn[index];\n          if (printInProjectProjection\n            && lizMap.config.options.qgisProjectProjection.ref != lizMap.config.options.projection.ref\n          ) {\n            // If we print in the QGIS project projection\n            draw_feature.geometry.transform(map.projection, project_projection);\n          }\n          highlightGeom.push(formatWKT.write(draw_feature));\n          highlightSymbol.push(lizMap.mainLizmap.digitizing.getFeatureDrawnSLD(index));\n\n        }\n      }\n\n      if (highlightGeom.length > 0) {\n        printParams[dragCtrl.layout.mapId+':HIGHLIGHT_GEOM'] = highlightGeom.join(';');\n        printParams[dragCtrl.layout.mapId+':HIGHLIGHT_SYMBOL'] = highlightSymbol.join(';');\n      }\n\n      // Display spinner and message while waiting for print\n      const printLaunch = document.getElementById('print-launch');\n      printLaunch.disabled = true;\n      printLaunch.classList.add('spinner');\n\n      $(\"#message .print a\").click();\n      mAddMessage(lizDict['print.started'], 'info', true).addClass('print-in-progress');\n\n      downloadFile(url, printParams, () => {\n        const printLaunch = document.getElementById('print-launch');\n        printLaunch.disabled = false;\n        printLaunch.classList.remove('spinner');\n\n        $(\"#message .print-in-progress a\").click();\n      });\n\n      return false;\n    });\n    map.events.on({\n      \"zoomend\": function() {\n        if ( dragCtrl.active && layer.getVisibility() ) {\n            // get scale\n            var scale = getPrintScale( printCapabilities.scales );\n            // update the select\n            $('#print-scale').val(scale);\n            // draw print box\n            drawPrintBox( dragCtrl.layout, layer, scale );\n        }\n      }\n    });\n    lizMap.events.on({\n        minidockopened: function(e) {\n            if ( e.id == 'print' ) {\n                $('#print-template').change();\n            }\n        },\n        minidockclosed: function(e) {\n            if ( e.id == 'print' ) {\n                dragCtrl.deactivate();\n            }\n        }\n    });\n  }\n\n  function addTooltipControl() {\n    if ( !config['tooltipLayers'] || config.tooltipLayers.length == 0 ) {\n      $('#button-tooltip-layer').parent().remove();\n      return false;\n    }\n\n    // Verifying WFS layers\n    var featureTypes = getVectorLayerFeatureTypes();\n    if (featureTypes.length == 0 ) {\n      $('#button-tooltip-layer').parent().remove();\n      return false;\n    }\n    var tooltipLayersDic = {};\n    for (var lname in config.tooltipLayers) {\n        tooltipLayersDic[lizMap.cleanName(lname)] = lname;\n    }\n\n    var tooltipLayersSorted = [];\n\n    for (const featureType of featureTypes) {\n      var typeName = featureType.getElementsByTagName('Name')[0].textContent;\n      var lname = lizMap.getNameByTypeName( typeName );\n        if ( !lname ) {\n            if (typeName in config.locateByLayer)\n                lname = typeName\n            else if ( (typeName in shortNameMap) && (shortNameMap[typeName] in config.locateByLayer))\n                lname = shortNameMap[typeName];\n            else {\n                for (var ttl in config.tooltipLayers) {\n                    if (ttl.split(' ').join('_') == typeName) {\n                        lname = ttl;\n                        break;\n                    }\n                }\n            }\n        }\n\n        if ( !(lname in config.tooltipLayers) )\n            continue;\n\n        if ( (lname in config.tooltipLayers) && (lname in config.layers) ) {\n            var lConfig = config.layers[lname];\n            tooltipLayersSorted[config.tooltipLayers[lname].order] = '<option value=\"'+lname+'\">'+lConfig.title+'</option>';\n        }\n    }\n\n    // Display layers order as declared in plugin\n    for (var i = 0; i < tooltipLayersSorted.length; i++) {\n      $('#tooltip-layer-list').append(tooltipLayersSorted[i]);\n    }\n\n    if ( $('#tooltip-layer-list').find('option').length == 1 ) {\n      $('#button-tooltip-layer').parent().remove();\n      return false;\n    }\n\n    // Define vector layer for tooltip\n    var tooltipStyleMap = new OpenLayers.StyleMap({\n        'default': new OpenLayers.Style({\n            pointRadius: 1,\n            strokeColor: \"blue\",\n            strokeWidth: 10,\n            strokeOpacity: 0,\n            fillOpacity: 0,\n            cursor: 'pointer'\n        }),\n        'selected': new OpenLayers.Style({\n            pointRadius: 1,\n            strokeColor: \"yellow\",\n            strokeWidth: 10,\n            strokeOpacity: 0,\n            fillOpacity: 0,\n            cursor: 'pointer'\n        }),\n        'temporary': new OpenLayers.Style({\n            pointRadius: 1,\n            strokeColor: 'red',\n            strokeWidth: 10,\n            strokeOpacity: 0,\n            fillOpacity: 0,\n            cursor: 'pointer'\n        })\n    });\n    var tlayer = new OpenLayers.Layer.Vector('tooltipLayer', {\n        styleMap: tooltipStyleMap\n    });\n    lizMap.map.addLayer(tlayer);\n    tlayer.setVisibility(true);\n\n    var tooltipControl = new OpenLayers.Control.HighlightFeature([tlayer],{\n        displayPopup: true,\n        popupOffset: {\n            'left': 45,\n            'right': 0,\n            'top': 5\n        },\n        popupTitle: \"State information\",\n        popupSize: new OpenLayers.Size(200,375),\n        style:{\n            pointRadius: 6,\n            strokeColor: \"cyan\",\n            strokeWidth: 3,\n            strokeOpacity: 1,\n            fillOpacity: 0.2,\n            fillColor: \"transparent\"\n        }\n    });\n    tooltipControl.addInfoPopup = function(feature) {\n        var lname = $('#tooltip-layer-list').val();//feature.layer.name.split(\"@\")[1];\n        var lconfig = lizMap.config.layers[lname];\n        if( !(lname in lizMap.config.layers) )\n          return;\n        var tconfig = lizMap.config.tooltipLayers[lname];\n        var tf = tconfig['fields'].trim();\n        var tooltipFields = tf.split(/[\\s,]+/);\n        var hiddenFields = [];\n        if ( 'attributeLayers' in lizMap.config\n            && lname in lizMap.config.attributeLayers\n            && 'hiddenFields' in lizMap.config.attributeLayers[lname]) {\n            var hf = lizMap.config.attributeLayers[lname]['hiddenFields'].trim();\n            hiddenFields = hf.split(/[\\s,]+/);\n        }\n        var cAliases = lconfig['alias'];\n        var html = '<div id=\"tooltipPopupContent\">';\n        html+= '<table class=\"lizmapPopupTable\">';\n        for (var a in feature.attributes){\n            // Do no show hiddenfields\n            if( ($.inArray(a, hiddenFields) > -1) )\n                continue;\n            // show only tootlip fields if some fields given\n            if( tf != '' && !($.inArray(a, tooltipFields) > -1) )\n                continue;\n            html+= '<tr><th>' + cAliases[a] + '</th><td>' + feature.attributes[a] + '</td></tr>';\n        }\n        html+= '</table>';\n        html+= '</div>';\n\n        var oMapExtent = this.layer.map.getExtent();\n        var nReso = this.layer.map.getResolution();\n\n        var oPopupPos = new OpenLayers.LonLat(oMapExtent.left,oMapExtent.top);\n        oPopupPos.lon += ( $('#dock').width() + this.popupOffset.left ) * nReso;\n        var tpopup = new OpenLayers.Popup.Anchored('tooltipPopup',\n            oPopupPos,\n            null,//new OpenLayers.Size(250,300),\n            html,\n            {size: {w: 14, h: 14}, offset: {x: -7, y: -7}},\n            false\n        );\n        tpopup.autoSize = true;\n        tpopup.backgroundColor = 'transparent';\n\n        feature.popup = tpopup;\n        lizMap.map.addPopup( tpopup );\n    };\n\n    lizMap.map.addControl(tooltipControl);\n    controls['tooltip-layer'] = tooltipControl;\n\n    $('#tooltip-layer button.btn-tooltip-layer-clear').click(function() {\n        $('#button-tooltip-layer').click();\n        return false;\n    });\n    $('#tooltip-cancel').click(function() {\n      $('#tooltip-layer-list').val('').change();\n      return false;\n    });\n    $('#tooltip-layer-list').change( function() {\n        var aName = $(this).val();\n        tooltipControl.deactivate();\n        tlayer.destroyFeatures();\n        if ( aName == '' )\n            return;\n        $('#tooltip-layer-list').addClass('loading').attr('disabled','');\n\n        // Get selected features\n        var selectionLayer = getLayerNameByCleanName( aName );\n\n        if( !selectionLayer )\n            selectionLayer = aName;\n        var featureid = getVectorLayerSelectionFeatureIdsString( selectionLayer );\n\n        getFeatureData( aName, null, featureid, null, false, null, null,\n            function(fName, fFilter, fFeatures, fAliases ){\n              // get layer name for config\n              if ( !(fName in config.layers) ) {\n                  var qgisName = lizMap.getNameByCleanName(aName);\n                  if ( qgisName && (qgisName in config.layers)) {\n                      fName = qgisName;\n                  } else {\n                      console.log('getFeatureData: \"'+fName+'\" and \"'+qgisName+'\" not found in config');\n                      return false;\n                  }\n              }\n\n              var lConfig = config.layers[fName];\n              var tconfig = config.tooltipLayers[fName];\n\n              var gFormat = new OpenLayers.Format.GeoJSON({\n                  ignoreExtraDims: true,\n                  externalProjection: lConfig['featureCrs'],\n                  internalProjection: lizMap.map.getProjection()\n              });\n              var tfeatures = gFormat.read( {\n                  type: 'FeatureCollection',\n                  features: fFeatures\n              } );\n              tlayer.addFeatures( tfeatures );\n\n              if ( ('displayGeom' in tconfig) && tconfig.displayGeom == 'True' )\n                  if ( ('colorGeom' in tconfig) && tconfig.colorGeom != '' )\n                      tooltipControl.style.strokeColor = tconfig.colorGeom;\n                  else\n                      tooltipControl.style.strokeColor = 'cyan';\n              else\n                  tooltipControl.style.strokeColor = 'transparent';\n              if (tfeatures.length != 0 && tfeatures[0].geometry && tfeatures[0].geometry.id.startsWith('OpenLayers_Geometry_LineString') )\n                  tooltipControl.style.strokeWidth = 10;\n              else\n                  tooltipControl.style.strokeWidth = 3;\n              tooltipControl.activate();\n              $('#tooltip-layer-list').removeClass('loading').removeAttr('disabled');\n\n        });\n    });\n    $('#tooltip-layer-list').removeClass('loading').removeAttr('disabled');\n\n    lizMap.events.on({\n        minidockopened: function(e) {\n            // Load layer automatically when there is only one\n            if (e.id == 'tooltip-layer' && $(\"#tooltip-layer-list option\").length === 2) {\n              $('#tooltip-layer-list').val($(\"#tooltip-layer-list option:nth-child(2)\").val()).change();\n            }\n        },\n        minidockclosed: function(e) {\n            if ( e.id == 'tooltip-layer' ) {\n              // deactivate tooltip on close\n              $('#tooltip-layer-list').val('').change();\n              return false;\n            }\n        }\n    });\n\n  }\n\n  function getLayerConfigById( aLayerId, aConfObjet, aIdAttribute ) {\n    // Set function parameters if not given\n    aConfObjet = typeof aConfObjet !== 'undefined' ?  aConfObjet : config.layers;\n    aIdAttribute = typeof aIdAttribute !== 'undefined' ?  aIdAttribute : 'id';\n\n    // Loop through layers to get the one by id\n    for ( var lx in aConfObjet ) {\n        if ( aConfObjet[lx][aIdAttribute] == aLayerId )\n            return [lx, aConfObjet[lx] ];\n    }\n    return null;\n  }\n\n\n  function addMeasureControls() {\n    // style the sketch fancy\n    var sketchSymbolizers = {\n      \"Point\": {\n        pointRadius: 4,\n        graphicName: \"square\",\n        fillColor: \"white\",\n        fillOpacity: 1,\n        strokeWidth: 1,\n        strokeOpacity: 1,\n        strokeColor: \"#333333\"\n      },\n      \"Line\": {\n        strokeWidth: 3,\n        strokeOpacity: 1,\n        strokeColor: \"#666666\",\n        strokeDashstyle: \"dash\"\n      },\n      \"Polygon\": {\n        strokeWidth: 2,\n        strokeOpacity: 1,\n        strokeColor: \"#666666\",\n        strokeDashstyle: \"dash\",\n        fillColor: \"white\",\n        fillOpacity: 0.3\n      }\n    };\n    var style = new OpenLayers.Style();\n    style.addRules([\n        new OpenLayers.Rule({symbolizer: sketchSymbolizers})\n        ]);\n    var styleMap = new OpenLayers.StyleMap({\"default\": style});\n\n    var measureControls = {\n      length: new OpenLayers.Control.Measure(\n        OpenLayers.Handler.Path, {\n          persist: true,\n          geodesic: true,\n          immediate: true,\n          handlerOptions: {\n            layerOptions: {\n              styleMap: styleMap\n            }\n          },\n          type:OpenLayers.Control.TYPE_TOOL\n        }\n      ),\n      area: new OpenLayers.Control.Measure(\n        OpenLayers.Handler.Polygon, {\n          persist: true,\n          geodesic: true,\n          immediate: true,\n          handlerOptions: {\n            layerOptions: {\n              styleMap: styleMap\n            }\n          },\n          type:OpenLayers.Control.TYPE_TOOL\n        }\n      ),\n      perimeter: new OpenLayers.Control.Measure(\n        OpenLayers.Handler.Polygon, {\n          persist: true,\n          geodesic: true,\n          immediate: true,\n          handlerOptions: {\n            layerOptions: {\n              styleMap: styleMap\n            }\n          },\n          type:OpenLayers.Control.TYPE_TOOL\n        }\n      ),\n      angle: new OpenLayers.Control.Measure(\n        OpenLayers.Handler.Path, {\n        id: 'angleMeasure',\n        persist: true,\n        geodesic: true,\n        immediate: true,\n        handlerOptions: {\n          maxVertices: 3,\n          layerOptions: {\n            styleMap: styleMap\n          }\n        },\n        type: OpenLayers.Control.TYPE_TOOL\n        }\n      )\n    };\n    measureControls.length.events.on({\n      activate: function() {\n        mAddMessage(lizDict['measure.activate.length'],'info',true).attr('id','lizmap-measure-message');\n      },\n      deactivate: function() {\n        $('#lizmap-measure-message').remove();\n      }\n    });\n    measureControls.area.events.on({\n      activate: function() {\n        mAddMessage(lizDict['measure.activate.area'],'info',true).attr('id','lizmap-measure-message');\n      },\n      deactivate: function() {\n        $('#lizmap-measure-message').remove();\n      }\n    });\n    measureControls.perimeter.events.on({\n      activate: function () {\n        mAddMessage(lizDict['measure.activate.perimeter'], 'info', true).attr('id', 'lizmap-measure-message');\n      },\n      deactivate: function () {\n        $('#lizmap-measure-message').remove();\n      }\n    });\n    measureControls.angle.events.on({\n      activate: function () {\n        mAddMessage(lizDict['measure.activate.angle'], 'info', true).attr('id', 'lizmap-measure-message');\n      },\n      deactivate: function () {\n        $('#lizmap-measure-message').remove();\n      }\n    });\n\n    measureControls.perimeter.measure = function(geometry, eventType) {\n        var stat, order;\n        if( OpenLayers.Util.indexOf( geometry.CLASS_NAME, 'LineString' ) > -1) {\n            stat = this.getBestLength(geometry);\n            order = 1;\n        } else {\n            stat = this.getBestLength(geometry.components[0]);\n            order = 1;\n        }\n        this.events.triggerEvent(eventType, {\n            measure: stat[0],\n            units: stat[1],\n            order: order,\n            geometry: geometry\n        });\n    };\n\n    function handleMeasurements(evt) {\n      var units = evt.units;\n      var order = evt.order;\n      var measure = evt.measure;\n      var out = \"\";\n\n      // Angle\n      if (evt.object.id === \"angleMeasure\") {\n\n        out = lizDict['measure.handle'] + \" 0°\";\n\n        // Three points are needed to measure an angle\n        if (evt.geometry.components.length === 3){\n          // Invert first and second points and use a flag to make this change occurs once until next measurement\n          if(evt.object.invert === undefined){\n            const firstComponent = evt.geometry.components[0].clone();\n            const secondComponent = evt.geometry.components[1].clone();\n            evt.geometry.components[0].move(secondComponent.x - firstComponent.x, secondComponent.y - firstComponent.y);\n            evt.geometry.components[1].move(firstComponent.x - secondComponent.x, firstComponent.y - secondComponent.y);\n\n            evt.object.invert = true;\n          } else if (evt.type === \"measure\"){\n            evt.object.invert = undefined;\n          }\n\n          // Display angle ABC between three points. B is center\n          const A = evt.geometry.components[0];\n          const B = evt.geometry.components[1];\n          const C = evt.geometry.components[2];\n\n          const AB = Math.sqrt(Math.pow(B.x - A.x, 2) + Math.pow(B.y - A.y, 2));\n          const BC = Math.sqrt(Math.pow(B.x - C.x, 2) + Math.pow(B.y - C.y, 2));\n          const AC = Math.sqrt(Math.pow(C.x - A.x, 2) + Math.pow(C.y - A.y, 2));\n          let angleInDegrees = (Math.acos((BC * BC + AB * AB - AC * AC) / (2 * BC * AB)) * 180) / Math.PI;\n\n          if (isNaN(angleInDegrees)) {\n            angleInDegrees = 0;\n          }\n\n          out = lizDict['measure.handle'] + \" \" + angleInDegrees.toFixed(2) + \"°\";\n        }\n        // Other measurement tools\n      }else{\n        if (order == 1) {\n          out += lizDict['measure.handle'] + \" \" + measure.toFixed(3) + \" \" + units;\n        } else {\n          out += lizDict['measure.handle'] + \" \" + measure.toFixed(3) + \" \" + units + \"<sup>2</\" + \"sup>\";\n        }\n      }\n\n      var element = $('#lizmap-measure-message');\n      if ( element.length == 0 ) {\n        element = mAddMessage(out);\n        element.attr('id','lizmap-measure-message');\n      } else {\n        element.html('<p>'+out+'</p>');\n      }\n    }\n\n    for(var key in measureControls) {\n      var control = measureControls[key];\n      control.events.on({\n        \"measure\": handleMeasurements,\n        \"measurepartial\": handleMeasurements\n      });\n      map.addControl(control);\n      controls[key+'Measure'] = control;\n    }\n    $('#measure-type').change(function() {\n        var self = $(this);\n        self.find('option').each(function() {\n            var val = $( this ).attr('value');\n            if ( val in measureControls && measureControls[val].active )\n              measureControls[val].deactivate();\n        });\n        measureControls[self.val()].activate();\n    });\n    lizMap.events.on({\n        minidockopened: function(e) {\n            if ( e.id == 'measure' ) {\n                $('#measure-type').change();\n            }\n        },\n        minidockclosed: function(e) {\n            if ( e.id == 'measure' ) {\n                var activeCtrl = '';\n                $('#measure-type option').each(function() {\n                    var val = $( this ).attr('value');\n                    if ( val in measureControls && measureControls[val].active )\n                        activeCtrl = val;\n                });\n                if ( activeCtrl != '' )\n                    measureControls[activeCtrl].deactivate();\n            }\n        }\n    });\n\n    $('#measure-stop').click(function(){\n      $('#button-measure').click();\n    });\n\n    return measureControls;\n  }\n\n  /**\n   * PRIVATE function: parseData\n   * parsing capability\n   *\n   * Parameters:\n   * aData - {String} the WMS capabilities\n   *\n   * Returns:\n   * {Boolean} the capability is OK\n   */\n  function parseData(aData) {\n    var format =  new OpenLayers.Format.WMSCapabilities({version:'1.3.0'});\n    capabilities = format.read(aData);\n\n    var capability = capabilities.capability;\n    if (!capability) {\n      $('#map').html('SERVICE NON DISPONIBLE!');\n      return false;\n    }\n    return true;\n  }\n\n  /**\n   * PRIVATE function: loadProjDefinition\n   * load CRS definition and activate it\n   *\n   * Parameters:\n   * aCRS - {String}\n   * aCallbalck - {function ( proj )}\n   *\n   */\n  function loadProjDefinition( aCRS, aCallback ) {\n    var proj = aCRS.replace(/^\\s+|\\s+$/g, ''); // trim();\n    if ( proj in Proj4js.defs ) {\n      aCallback( proj );\n    } else {\n      $.get( OpenLayers.Util.urlAppend(\n          lizUrls.wms\n          ,OpenLayers.Util.getParameterString(lizUrls.params)\n        ), {\n          'REQUEST':'GetProj4'\n         ,'authid': proj\n        }, function ( aText ) {\n          Proj4js.defs[proj] = aText;\n          new OpenLayers.Projection(proj);\n          aCallback( proj );\n        }\n      );\n    }\n  }\n\n  /**\n   * PRIVATE function: mCheckMobile\n   * Check wether in mobile context.\n   *\n   *\n   * Returns:\n   * {Boolean} True if in mobile context.\n   */\n  function mCheckMobile() {\n    var minMapSize = 450;\n    var w = $('body').parent()[0].offsetWidth;\n    var leftW = w - minMapSize;\n    if(leftW < minMapSize || w < minMapSize)\n      return true;\n    return false;\n  }\n\n  /**\n   * PRIVATE function: mAddMessage\n   * Write message to the UI\n   *\n   *\n   * Returns:\n   * {jQuery Object} The message added.\n   */\n  function mAddMessage( aMessage, aType, aClose ) {\n    var mType = 'info';\n    var mTypeList = ['info', 'error', 'success'];\n    var mClose = false;\n\n    if ( $.inArray(aType, mTypeList) != -1 )\n      mType = aType;\n\n    if ( aClose )\n      mClose = true;\n\n    var html = '<div class=\"alert alert-block alert-'+mType+' fade in\" data-alert=\"alert\">';\n    if ( mClose )\n      html += '<a class=\"close\" data-dismiss=\"alert\" href=\"#\">×</a>';\n    html += '<p>'+aMessage+'</p>';\n    html += '</div>';\n\n    var elt = $(html);\n    $('#message').append(elt);\n    return elt;\n  }\n\n  /**\n   * PRIVATE function: downloadFile\n   * Send an ajax POST request to download a file\n   *\n   * @param {String} url\n   * @param {Array} parameters\n   * @param {Function} callback optionnal callback executed when download ends\n   *\n   */\n   function downloadFile( url, parameters, callback ) {\n      var xhr = new XMLHttpRequest();\n      xhr.open('POST', url, true);\n      xhr.responseType = 'arraybuffer';\n      xhr.onload = function () {\n          if (this.status === 200) {\n              var filename = \"\";\n              var disposition = xhr.getResponseHeader('Content-Disposition');\n              if (disposition && disposition.indexOf('attachment') !== -1) {\n                  var filenameRegex = /filename[^;=\\n]*=((['\"]).*?\\2|[^;\\n]*)/;\n                  var matches = filenameRegex.exec(disposition);\n                  if (matches != null && matches[1]) filename = matches[1].replace(/['\"]/g, '');\n              }\n\n              let type = xhr.getResponseHeader('Content-Type');\n\n              // Firefox >= 98 opens blob in its pdf viewer\n              // This is a hack to force download as in Chrome\n              if(navigator.userAgent.toLowerCase().indexOf('firefox') > -1 && type == 'application/pdf'){\n                type = 'application/octet-stream';\n              }\n              const blob = new File([this.response], filename, { type: type });\n              const downloadUrl = URL.createObjectURL(blob);\n\n              if (filename) {\n                // use HTML5 a[download] attribute to specify filename\n                const a = document.createElement('a');\n                a.href = downloadUrl;\n                a.download = filename;\n                a.dispatchEvent(new MouseEvent('click'));\n              } else {\n                window.open(downloadUrl);\n              }\n\n              setTimeout(() => URL.revokeObjectURL(downloadUrl), 100); // cleanup\n          }\n\n          // Note 31/01/2022\n          // REMOVE WHEN THE QGIS SERVER BUG HAS BEEN FIXED\n          // Related PR for QGIS Master https://github.com/qgis/QGIS/pull/47051\n          // It should be fixed for 3.24.1 and 3.22.5\n          if (this.status == 400) {\n            // Check for parenthesis inside the layer name\n            // There is a bug to be fixed in QGIS Server WFS request for this context\n            var typeName = parameters['TYPENAME'];\n            const parenthesis_regex = /[\\(\\)]/g;\n            const has_parenthesis = typeName.match(parenthesis_regex);\n            if (has_parenthesis) {\n              var error_message = 'The selected features cannot be exported due to a known bug in QGIS Server.';\n              error_message += '<br/>Please ask the map editor to remove the parenthesis in the layer name.';\n            } else {\n              var error_message = lizDict['layer.export.unknown.export.error'];\n            };\n\n            mAddMessage(error_message, 'error', true);\n            return false;\n          }\n          // Execute callback if any\n          if (typeof callback === 'function'){\n            callback();\n          }\n      };\n      xhr.setRequestHeader('Content-type', 'application/x-www-form-urlencoded');\n      xhr.send($.param(parameters, true));\n   }\n\n  /**\n   * PRIVATE function: exportVectorLayer\n   *\n   */\n  function exportVectorLayer( aName, eformat, restrictToMapExtent ) {\n\n      restrictToMapExtent = typeof restrictToMapExtent !== 'undefined' ?  restrictToMapExtent : null;\n\n      // right not set\n      if ( !('exportLayers' in lizMap.config.options) || lizMap.config.options.exportLayers != 'True' ) {\n        mAddMessage(lizDict['layer.export.right.required'],'error',true);\n        return false;\n      }\n\n      // Set function parameters if not given\n      eformat = typeof eformat !== 'undefined' ?  eformat : 'GeoJSON';\n\n      // Get selected features\n      var cleanName = lizMap.cleanName( aName );\n      var selectionLayer = getLayerNameByCleanName( cleanName );\n\n      if (!selectionLayer) {\n        selectionLayer = aName;\n      }\n\n      // Get the layer Lizmap configuration\n      var config_layer = lizMap.config.layers[selectionLayer];\n\n      // Check if the layer is spatial\n      const is_spatial = (\n        config_layer['geometryType'] && config_layer['geometryType'] != 'none' && config_layer != 'unknown'\n      ) ? true : false;\n\n      // Check if there is a selection token\n      const has_selection_token = (\n        'request_params' in config_layer && 'selectiontoken' in config_layer['request_params']\n        && config_layer['request_params']['selectiontoken'] != null\n        && config_layer['request_params']['selectiontoken'] != ''\n      ) ? true : false;\n\n      // Check for parenthesis inside the layer name\n      // There is a bug to be fixed in QGIS Server WFS request for this context\n      const parenthesis_regex = /[\\(\\)]/g;\n      const has_parenthesis = selectionLayer.match(parenthesis_regex);\n\n      // If there is a selection, use the selectiontoken,\n      // not a list of features ids to avoid to have too big urls\n      // There is some cases when we do not want to use the selection token\n      // * Layers with no selection token\n      // * Layers with parenthesis inside the layer name (Bug to be fixed in QGIS Server WFS request)\n      // * Layers with no geometry, because there is no request_params (as it is only for Openlayers layers)\n      if (is_spatial && has_selection_token && !has_parenthesis) {\n        // Get the WFS URL with no filter\n        var getFeatureUrlData = getVectorLayerWfsUrl( aName, null, null, null, restrictToMapExtent );\n        // Add the SELECTIONTOKEN parameter\n        var selection_token = config_layer['request_params']['selectiontoken'];\n        getFeatureUrlData['options']['SELECTIONTOKEN'] = selection_token;\n      } else {\n        // Get the WFS feature ids\n        var featureid = getVectorLayerSelectionFeatureIdsString( selectionLayer );\n        // Restrict the WFS URL for these IDS\n        var getFeatureUrlData = getVectorLayerWfsUrl( aName, null, featureid, null, restrictToMapExtent );\n      }\n\n      // Force download\n      getFeatureUrlData['options']['dl'] = 1;\n\n      // Set export format\n      getFeatureUrlData['options']['OUTPUTFORMAT'] = eformat;\n\n      // Download file\n      downloadFile(getFeatureUrlData['url'], getFeatureUrlData['options']);\n\n      return false;\n  }\n\n  function getVectorLayerSelectionFeatureIdsString( aName ) {\n      var featureidParameter = '';\n      if( aName in config.layers && config.layers[aName]['selectedFeatures'] ){\n          var fids = [];\n\n          // Get WFS typename\n          var configLayer = config.layers[aName];\n          var typeName = aName.split(' ').join('_');\n          if ( 'shortname' in configLayer && configLayer.shortname != '' )\n              typeName = configLayer.shortname;\n\n          for( var id in configLayer['selectedFeatures'] ) {\n              fids.push( typeName + '.' + configLayer['selectedFeatures'][id] );\n          }\n          if( fids.length )\n              featureidParameter = fids.join();\n      }\n\n      return featureidParameter;\n  }\n\n  function getVectorLayerWfsUrl( aName, aFilter, aFeatureId, geometryName, restrictToMapExtent, startIndex, maxFeatures ) {\n      var getFeatureUrlData = {};\n\n      // Set function parameters if not given\n      aFilter = typeof aFilter !== 'undefined' ?  aFilter : null;\n      aFeatureId = typeof aFeatureId !== 'undefined' ?  aFeatureId : null;\n      geometryName = typeof geometryName !== 'undefined' ?  geometryName : null;\n      restrictToMapExtent = typeof restrictToMapExtent !== 'undefined' ?  restrictToMapExtent : false;\n      startIndex = typeof startIndex !== 'undefined' ?  startIndex : null;\n      maxFeatures = typeof maxFeatures !== 'undefined' ?  maxFeatures : null;\n\n      // Build WFS request parameters\n      if ( !(aName in config.layers) ) {\n          var qgisName = lizMap.getNameByCleanName(aName);\n          if ( !qgisName || !(qgisName in config.layers))\n            qgisName = lizMap.getNameByShortName(aName);\n          if ( !qgisName || !(qgisName in config.layers))\n            qgisName = lizMap.getNameByTypeName(aName);\n          if ( qgisName && (qgisName in config.layers)) {\n              aName = qgisName;\n          } else {\n              console.log('getVectorLayerWfsUrl: \"'+aName+'\" and \"'+qgisName+'\" not found in config');\n              return false;\n          }\n      }\n      var configLayer = config.layers[aName];\n      var typeName = aName.split(' ').join('_');\n      if ( 'shortname' in configLayer && configLayer.shortname != '' )\n        typeName = configLayer.shortname;\n      else if ( 'typename' in configLayer && configLayer.typename != '' )\n          typeName = configLayer.typename;\n\n      var wfsOptions = {\n          'SERVICE':'WFS'\n          ,'VERSION':'1.0.0'\n          ,'REQUEST':'GetFeature'\n          ,'TYPENAME':typeName\n          ,'OUTPUTFORMAT':'GeoJSON'\n      };\n\n      if( startIndex )\n          wfsOptions['STARTINDEX'] = startIndex;\n\n      if( maxFeatures )\n          wfsOptions['MAXFEATURES'] = maxFeatures;\n\n      var filterParam = [];\n\n      if( aFilter ){\n          // Remove layerName followed by :\n          aFilter = aFilter.replace( aName + ':', '');\n          if ( aFilter != '' )\n            filterParam.push( aFilter );\n      }else{\n          // If not filter passed, check if a filter does not exists for the layer\n          if( 'request_params' in config.layers[aName] && 'filter' in config.layers[aName]['request_params'] ){\n            var aFilter = config.layers[aName]['request_params']['filter'];\n            if( aFilter ){\n                aFilter = aFilter.replace( aName + ':', '');\n                filterParam.push( aFilter );\n            }\n          }\n      }\n\n      // optionnal parameter filterid or EXP_FILTER\n      if( aFeatureId )\n          wfsOptions['FEATUREID'] = aFeatureId.replace(new RegExp(aName, 'g'), typeName);\n      else if( filterParam.length )\n          wfsOptions['EXP_FILTER'] = filterParam.join( ' AND ' );\n\n\n      // Calculate bbox from map extent if needed\n      if( restrictToMapExtent ) {\n          var extent = map.getExtent().clone();\n          var projFeat = new OpenLayers.Projection(config.layers[aName].crs);\n          extent = extent.transform( map.getProjection(), projFeat );\n          var bbox = extent.toBBOX();\n          wfsOptions['BBOX'] = bbox;\n      }\n\n      // Optionnal parameter geometryname\n      if( geometryName\n        && $.inArray( geometryName.toLowerCase(), ['none', 'extent', 'centroid'] ) != -1\n      ){\n          wfsOptions['GEOMETRYNAME'] = geometryName;\n      }\n\n      getFeatureUrlData['url'] = OpenLayers.Util.urlAppend(lizUrls.wms\n              ,OpenLayers.Util.getParameterString(lizUrls.params)\n      );\n      getFeatureUrlData['options'] = wfsOptions;\n\n      return getFeatureUrlData;\n  }\n\n    /**\n     * storage for callbacks given to getFeatureData\n     *\n     * used to avoid multiple request for the same feature\n     * @type {{}}\n     */\n  var featureDataPool = {};\n\n  function callFeatureDataCallBacks(poolId, features) {\n      var callbacksData = featureDataPool[poolId];\n      delete featureDataPool[poolId];\n      callbacksData.callbacks.forEach(function(callback) {\n          if (callback) {\n              callback(callbacksData.layerName, callbacksData.filter, features, callbacksData.alias);\n          }\n      });\n  }\n\n  function getFeatureData(aName, aFilter, aFeatureID, aGeometryName, restrictToMapExtent, startIndex, maxFeatures, aCallBack) {\n      // Set function parameters if not given\n      aFilter = typeof aFilter !== 'undefined' ?  aFilter : null;\n      aFeatureID = typeof aFeatureID !== 'undefined' ? aFeatureID : null;\n      aGeometryName = typeof aGeometryName !== 'undefined' ? aGeometryName : null;\n      restrictToMapExtent = typeof restrictToMapExtent !== 'undefined' ?  restrictToMapExtent : false;\n      startIndex = typeof startIndex !== 'undefined' ?  startIndex : null;\n      maxFeatures = typeof maxFeatures !== 'undefined' ?  maxFeatures : null;\n\n      // get layer configs\n      if ( !(aName in config.layers) ) {\n          var qgisName = lizMap.getNameByCleanName(aName);\n          if ( !qgisName || !(qgisName in config.layers))\n            qgisName = lizMap.getNameByShortName(aName);\n          if ( !qgisName || !(qgisName in config.layers))\n            qgisName = lizMap.getNameByTypeName(aName);\n          if ( qgisName && (qgisName in config.layers)) {\n              aName = qgisName;\n          } else {\n              console.log('getFeatureData: \"'+aName+'\" and \"'+qgisName+'\" not found in config');\n              return false;\n          }\n      }\n      var aConfig = config.layers[aName];\n\n      $('body').css('cursor', 'wait');\n\n      var getFeatureUrlData = lizMap.getVectorLayerWfsUrl( aName, aFilter, aFeatureID, aGeometryName, restrictToMapExtent, startIndex, maxFeatures );\n\n      // see if a request for the same feature is not already made\n      var poolId = getFeatureUrlData['url'] + \"|\" + JSON.stringify(getFeatureUrlData['options']);\n      if (poolId in featureDataPool) {\n          // there is already a request, let's store our callback and wait...\n          if (aCallBack) {\n              featureDataPool[poolId].callbacks.push(aCallBack);\n          }\n          return;\n      }\n      // no request yet, let's do it and store the callback and its parameters\n      featureDataPool[poolId] = {\n          callbacks: [ aCallBack ],\n          layerName: aName,\n          filter: aFilter,\n          alias: aConfig['alias']\n      };\n\n      $.post( getFeatureUrlData['url'], getFeatureUrlData['options'], function(data) {\n\n          if( !('featureCrs' in aConfig) )\n              aConfig['featureCrs'] = null;\n          if( aConfig.crs == 'EPSG:4326' )\n              aConfig['featureCrs'] = 'EPSG:4326';\n\n          // verifying the feature CRS\n          if( !aConfig.featureCrs && data.features.length != 0) {\n              // load projection to be sure to have the definition\n              lizMap.loadProjDefinition( aConfig.crs, function() {\n                  // in QGIS server > 2.14 GeoJSON is in EPSG:4326\n                  if ( 'qgisServerVersion' in config.options && config.options.qgisServerVersion != '2.14' )\n                      aConfig['featureCrs'] = 'EPSG:4326';\n                  else if ( !aConfig.featureCrs )\n                      aConfig['featureCrs'] = aConfig.crs;\n\n              });\n          }\n\n          if ('alias' in aConfig && aConfig['alias']) {\n              callFeatureDataCallBacks(poolId, data.features);\n              $('body').css('cursor', 'auto');\n          } else {\n              var service = OpenLayers.Util.urlAppend(lizUrls.wms\n                    ,OpenLayers.Util.getParameterString(lizUrls.params)\n              );\n              $.post(service, {\n                  'SERVICE':'WFS'\n                 ,'VERSION':'1.0.0'\n                 ,'REQUEST':'DescribeFeatureType'\n                 ,'TYPENAME': ('typename' in aConfig) ? aConfig.typename : aName\n                 ,'OUTPUTFORMAT':'JSON'\n              }, function(describe) {\n\n                  aConfig['alias'] = describe.aliases;\n                  if ('types' in describe)\n                      aConfig['types'] = describe.types;\n                  if ('columns' in describe && !('columns' in aConfig && aConfig['columns']))\n                      aConfig['columns'] = describe.columns;\n\n                  callFeatureDataCallBacks(poolId, data.features);\n\n                  $('body').css('cursor', 'auto');\n\n              },'json');\n           }\n\n      },'json');\n\n      return true;\n  }\n\n  function translateWfsFieldValues(aName, fieldName, fieldValue, translation_dict){\n    translation_dict = typeof translation_dict !== 'undefined' ?  translation_dict : null;\n    return fieldValue;\n  }\n\n  function zoomToOlFeature( feature, proj, zoomAction ){\n      zoomAction = typeof zoomAction !== 'undefined' ?  zoomAction : 'zoom';\n      var format = new OpenLayers.Format.GeoJSON({\n          ignoreExtraDims: true\n      });\n      var feat = format.read(feature)[0];\n      if( feat && 'geometry' in feat ){\n          feat.geometry.transform( proj, lizMap.map.getProjection() );\n\n          // Zoom or center to selected feature\n          if( zoomAction == 'zoom' )\n              map.zoomToExtent(feat.geometry.getBounds());\n          if( zoomAction == 'center' ){\n              var lonlat = feat.geometry.getBounds().getCenterLonLat()\n              map.setCenter(lonlat);\n          }\n      }\n  }\n\n  function zoomToFeature( featureType, fid, zoomAction ){\n      zoomAction = typeof zoomAction !== 'undefined' ?  zoomAction : 'zoom';\n\n      var proj = new OpenLayers.Projection(config.layers[featureType].crs);\n      if( config.layers[featureType].featureCrs )\n          proj = new OpenLayers.Projection(config.layers[featureType].featureCrs);\n      getLayerFeature(featureType, fid, function(feat) {\n          zoomToOlFeature( feat, proj, zoomAction );\n      });\n  }\n\n  function getLayerFeature( featureType, fid, aCallback, aCallbackNotfound, forceToLoad ){\n      if ( !aCallback )\n          return;\n      if ( !(featureType in config.layers) )\n          return;\n\n      var layerConfig = config.layers[featureType];\n      var featureId = featureType + '.' + fid;\n\n      // Use already retrieved feature\n      if(!forceToLoad && layerConfig['features'] && fid in layerConfig['features'] ){\n          aCallback(layerConfig['features'][fid]);\n      }\n      // Or get the feature via WFS in needed\n      else{\n          getFeatureData(featureType, null, featureId, 'extent', false, null, null,\n              function( aName, aFilter, cFeatures, cAliases ){\n\n              if (cFeatures.length == 1) {\n                  var feat = cFeatures[0];\n                  if( !layerConfig['features'] ) {\n                      layerConfig['features'] = {};\n                  }\n                  layerConfig['features'][fid] = feat;\n                  aCallback(feat);\n              }\n              else if(aCallbackNotfound) {\n                  aCallbackNotfound(featureType, fid);\n              }\n          });\n      }\n  }\n\n  function getVectorLayerFeatureTypes() {\n      if ( wfsCapabilities == null ){\n        return [];\n      }\n      return wfsCapabilities.getElementsByTagName('FeatureType');\n  }\n\n  function getVectorLayerResultFormat() {\n    let formats = [];\n    if ( wfsCapabilities == null ){\n      return formats;\n    }else{\n      for (const format of wfsCapabilities.getElementsByTagName('ResultFormat')[0].children) {\n        formats.push(format.tagName);\n      }\n      return formats;\n    }\n  }\n\n\n  function getFeaturePopupContent( aName, feat, aCallback) {\n      // Only use this functino with callback\n      if ( !aCallback )\n          return;\n\n      // Only use when feat is set\n      if( !feat )\n          return false;\n\n      // Remove map popup to avoid confusion\n      if (lizMap.map.popups.length != 0)\n          lizMap.map.removePopup( lizMap.map.popups[0] );\n\n      // Get popup content by FILTER and not with virtual click on map\n      var filter = '';\n      var qgisName = aName;\n      if( lizMap.getLayerNameByCleanName(aName) ){\n          qgisName = lizMap.getLayerNameByCleanName(aName);\n      }\n\n      var pkey = null;\n      // Get primary key with attributelayer options\n      if( (qgisName in lizMap.config.attributeLayers) ){\n          pkey = lizMap.config.attributeLayers[qgisName]['primaryKey'];\n      }\n\n      // Test if primary key is set in the atlas tool\n      // Atlas config with one layer (legacy)\n      if( !pkey && 'atlasLayer' in lizMap.config.options && 'atlasPrimaryKey' in lizMap.config.options ){\n        var layerConfig = lizMap.config.layers[qgisName];\n        if( layerConfig.id == lizMap.config.options['atlasLayer'] && lizMap.config.options['atlasPrimaryKey'] != '' ){\n          pkey = lizMap.config.options['atlasPrimaryKey'];\n        }\n      }\n\n      // Atlas config with several layers (LWC >= 3.4)\n      if (!pkey && 'atlas' in lizMap.config && 'layers' in lizMap.config.atlas && Array.isArray(lizMap.config.atlas['layers']) && lizMap.config.atlas['layers'].length > 0) {\n        const layerConfig = lizMap.config.layers[qgisName];\n        for (let index = 0; index < lizMap.config.atlas.layers.length; index++) {\n          const layer = lizMap.config.atlas.layers[index];\n          if (layerConfig.id === layer.layer){\n            pkey = layer.primaryKey;\n            break;\n          }\n        }\n      }\n\n      if( !pkey )\n          return false;\n\n      var pkVal = feat.properties[pkey];\n      filter = qgisName + ':\"' + pkey + '\" = ' + \"'\" + pkVal + \"'\" ;\n\n      var crs = 'EPSG:4326';\n      if(('crs' in lizMap.config.layers[qgisName]) && lizMap.config.layers[qgisName].crs != ''){\n          crs = lizMap.config.layers[qgisName].crs;\n      }\n\n      var wmsOptions = {\n           'LAYERS': aName\n          ,'QUERY_LAYERS': aName\n          ,'STYLES': ''\n          ,'SERVICE': 'WMS'\n          ,'VERSION': '1.3.0'\n          ,'CRS': crs\n          ,'REQUEST': 'GetFeatureInfo'\n          ,'EXCEPTIONS': 'application/vnd.ogc.se_inimage'\n          ,'INFO_FORMAT': 'text/html'\n          ,'FEATURE_COUNT': 1\n          ,'FILTER': filter\n      };\n\n      // Query the server\n      var service = OpenLayers.Util.urlAppend(lizUrls.wms\n          ,OpenLayers.Util.getParameterString(lizUrls.params)\n      );\n      $.post(service, wmsOptions, function(data) {\n          aCallback(data);\n      });\n\n  }\n\n  // Get the popup content for a layer given a feature\n  function getFeaturePopupContentByFeatureIntersection(aName, feat, aCallback) {\n\n    // Calculate fake bbox around the feature\n    var units = lizMap.map.getUnits();\n    var lConfig = lizMap.config.layers[aName];\n    if( lizMap.map.maxScale == 'auto' )\n      var scale = lConfig.minScale;\n    else\n      var scale = Math.max( lizMap.map.maxScale, lConfig.minScale );\n    scale = scale * 2;\n    var res = OpenLayers.Util.getResolutionFromScale(scale, units);\n\n    var geomType = feat.geometry.CLASS_NAME;\n    if (\n      geomType == 'OpenLayers.Geometry.Polygon'\n      || geomType == 'OpenLayers.Geometry.MultiPolygon'\n      || geomType == 'OpenLayers.Geometry.Point'\n    ) {\n      var lonlat = feat.geometry.getBounds().getCenterLonLat()\n    }\n    else {\n      var vert = feat.geometry.getVertices();\n      var middlePoint = vert[Math.floor(vert.length/2)];\n      var lonlat = new OpenLayers.LonLat(middlePoint.x, middlePoint.y);\n    }\n\n    // Calculate fake bbox\n    var bbox = new OpenLayers.Bounds(\n      lonlat.lon - 5 * res,\n      lonlat.lat - 5 * res,\n      lonlat.lon + 5 * res,\n      lonlat.lat + 5 * res\n    );\n\n    var gfiCrs = lizMap.map.getProjectionObject().toString();\n    if ( gfiCrs == 'EPSG:900913' )\n      gfiCrs = 'EPSG:3857';\n\n    var wmsOptions = {\n       'LAYERS': aName\n      ,'QUERY_LAYERS': aName\n      ,'STYLES': ''\n      ,'SERVICE': 'WMS'\n      ,'VERSION': '1.3.0'\n      ,'REQUEST': 'GetFeatureInfo'\n      ,'EXCEPTIONS': 'application/vnd.ogc.se_inimage'\n      ,'BBOX': bbox.toBBOX()\n      ,'FEATURE_COUNT': 10\n      ,'HEIGHT': 100\n      ,'WIDTH': 100\n      ,'INFO_FORMAT': 'text/html'\n      ,'CRS': gfiCrs\n      ,'I': 50\n      ,'J': 50\n    };\n\n    // Query the server\n    var service = OpenLayers.Util.urlAppend(lizUrls.wms\n      ,OpenLayers.Util.getParameterString(lizUrls.params)\n    );\n    $.post(service, wmsOptions, function(data) {\n      if(aCallback){\n        aCallback(service, wmsOptions, data);\n      }\n    });\n  }\n\n\n  function selectLayerFeaturesFromSelectionFeature(targetFeatureType, selectionFeature, geomOperator = 'intersects'){\n\n      var lConfig = config.layers[targetFeatureType];\n      lizMap.loadProjDefinition( lConfig.crs, function( aProj ) {\n\n          var gml3 = new OpenLayers.Format.GML.v3(\n              {\n                  internalProjection: lizMap.map.getProjection(),\n                  externalProjection: aProj,\n                  srsName: aProj\n              }\n          );\n          var gml = gml3.writeNode(\n              'feature:_geometry',\n              selectionFeature.geometry\n          );\n        var spatialFilter = geomOperator+\"($geometry, geom_from_gml('\" ;\n          spatialFilter+= OpenLayers.Format.XML.prototype.write.apply(\n              gml3,\n              gml.children\n          );\n          spatialFilter+= \"'))\";\n\n          if( 'request_params' in lConfig && 'filter' in lConfig['request_params'] ){\n              var rFilter = lConfig['request_params']['filter'];\n              if( rFilter ){\n                  rFilter = rFilter.replace( targetFeatureType + ':', '');\n                  spatialFilter = rFilter +' AND '+ spatialFilter;\n              }\n          }\n          if( 'request_params' in lConfig && 'exp_filter' in lConfig['request_params'] ){\n              // Add exp_filter, for example if set by another tool( filter module )\n              // Often 'filter' is not set because filtertoken is set instead\n              // But in this case, exp_filter must also been set and must be added\n              var eFilter = lConfig['request_params']['exp_filter'];\n              if( eFilter ){\n                  spatialFilter = eFilter +' AND '+ spatialFilter;\n              }\n          }\n          var limitDataToBbox = false;\n          if ( 'limitDataToBbox' in config.options && config.options.limitDataToBbox == 'True'){\n              limitDataToBbox = true;\n          }\n          var getFeatureUrlData = lizMap.getVectorLayerWfsUrl( targetFeatureType, spatialFilter, null, null, limitDataToBbox );\n\n          // add BBox to restrict to geom bbox but not with some geometry operator\n          if (geomOperator !== 'disjoint'){\n            var geomBounds = selectionFeature.geometry.clone().transform(lizMap.map.getProjection(), aProj).getBounds();\n            getFeatureUrlData['options']['BBOX'] = geomBounds.toBBOX();\n          }\n\n          // get features\n          $.post( getFeatureUrlData['url'], getFeatureUrlData['options'], function(result) {\n                  var gFormat = new OpenLayers.Format.GeoJSON({\n                      ignoreExtraDims: true,\n                      externalProjection: lConfig.crs,\n                      internalProjection: lizMap.map.getProjection()\n                  });\n                  var tfeatures = gFormat.read( result );\n                  var sfIds = $.map(tfeatures, function(feat){\n                      return feat.fid.split('.')[1];\n                  });\n\n                  if (lizMap.mainLizmap.selectionTool.newAddRemoveSelected === 'add' ) {\n                      sfIds = config.layers[targetFeatureType]['selectedFeatures'].concat(sfIds);\n                      for(var i=0; i<sfIds.length; ++i) {\n                          for(var j=i+1; j<sfIds.length; ++j) {\n                              if(sfIds[i] === sfIds[j])\n                                  sfIds.splice(j--, 1);\n                          }\n                      }\n                  } else if (lizMap.mainLizmap.selectionTool.newAddRemoveSelected === 'remove' ) {\n                      var asfIds = config.layers[targetFeatureType]['selectedFeatures'].concat([]);\n                      for(var i=0; i<sfIds.length; ++i) {\n                          var asfIdIdx = asfIds.indexOf( sfIds[i] );\n                          if( asfIdIdx != -1 )\n                              asfIds.splice(asfIdIdx, 1);\n                      }\n                      sfIds = asfIds;\n                  }\n                  config.layers[targetFeatureType]['selectedFeatures'] = sfIds;\n                  lizMap.events.triggerEvent(\"layerSelectionChanged\",\n                      {\n                          'featureType': targetFeatureType,\n                          'featureIds': config.layers[targetFeatureType]['selectedFeatures'],\n                          'updateDrawing': true\n                      }\n                  );\n          });\n      });\n  }\n\n  // Create new dock or minidock\n  // Example : lizMap.addDock('mydock', 'My dock title', 'dock', 'Some content', 'icon-pencil');\n  // see icon list here : http://getbootstrap.com/2.3.2/base-css.html#icons\n  function addDock( dname, dlabel, dtype, dcontent, dicon){\n      // First check if this dname already exists\n      if( $('#mapmenu .nav-list > li.'+dname+' > a').length ){\n          console.log(dname + ' menu item already exists');\n          return;\n      }\n\n      // Create menu icon for activating dock\n      var dockli = '';\n      dockli+='<li class=\"'+dname+' nav-'+dtype+'\">';\n      dockli+='   <a id=\"button-'+dname+'\" rel=\"tooltip\" data-original-title=\"'+dlabel+'\" data-placement=\"right\" href=\"#'+dname+'\" data-container=\"#content\">';\n      dockli += '       <span class=\"icon\"><i class=\"' + dicon + ' icon-white\"></i></span><span class=\"menu-title\">' + dname +'</span>';\n      dockli+='   </a>';\n      dockli+='</li>';\n      $('#mapmenu div ul li.nav-'+dtype+':last').after(dockli);\n      if ( $('#mapmenu div ul li.nav-'+dtype+'.'+dname).length == 0 )\n        $('#mapmenu div ul li:last').after(dockli);\n\n      //  Remove native lizmap icon\n      $('#mapmenu .nav-list > li.'+dname+' > a .icon').css('background-image','none');\n      $('#mapmenu .nav-list > li.'+dname+' > a .icon >i ').css('margin-left', '4px');\n\n      // Add tooltip\n      $('#mapmenu .nav-list > li.'+dname+' > a').tooltip();\n\n      // Create dock tab content\n      var docktab = '';\n      docktab+='<div class=\"tab-pane\" id=\"'+dname+'\">';\n      if( dtype == 'minidock'){\n          docktab+='<div class=\"mini-dock-close\" title=\"' + lizDict['toolbar.content.stop'] + '\" style=\"padding:7px;float:right;cursor:pointer;\"><i class=\"icon-remove icon-white\"></i></div>';\n          docktab+='    <div class=\"'+dname+'\">';\n          docktab+='        <h3>';\n          docktab+='            <span class=\"title\">';\n          docktab+='              <i class=\"'+dicon+' icon-white\"></i>';\n          docktab+='              <span class=\"text\">&nbsp;'+dlabel+'&nbsp;</span>';\n          docktab+='            </span>';\n          docktab+='        </h3>';\n      }\n      docktab+='        <div class=\"menu-content\">';\n      docktab+= dcontent;\n      docktab+='        </div>';\n      docktab+='    </div>';\n      docktab+='</div>';\n      if( dtype == 'minidock'){\n          $('#mini-dock-content').append(docktab);\n          $('#'+dname+' div.mini-dock-close').click(function(){\n            if( $('#mapmenu .nav-list > li.'+dname).hasClass('active') ){\n                $('#button-'+dname).click();\n            }\n          });\n      }\n      else if( dtype == 'right-dock' )\n          $('#right-dock-content').append(docktab);\n      else if( dtype == 'dock' )\n          $('#dock-content').append(docktab);\n      else if( dtype == 'bottomdock' )\n          $('#bottom-dock-content').append(docktab);\n\n      // Create dock tab li\n      var docktabli = '';\n      docktabli+= '<li id=\"nav-tab-'+dname+'\"><a href=\"#'+dname+'\" data-toggle=\"tab\">'+dlabel+'</a></li>';\n      if( dtype == 'minidock')\n          $('#mini-dock-tabs').append(docktabli);\n      else if( dtype == 'right-dock' )\n          $('#right-dock-tabs').append(docktabli);\n      else if( dtype == 'dock' )\n          $('#dock-tabs').append(docktabli);\n      else if( dtype == 'bottomdock' )\n          $('#bottom-dock-tabs').append(docktabli);\n\n  }\n\n  /**\n   * PRIVATE function: getFeatureInfoTolerances\n   * Get tolerances for point, line and polygon\n   * as configured with lizmap plugin, or default\n   * if no configuration found.\n   * Returns:\n   * {Object} The tolerances for point, line and polygon\n   */\n  function getFeatureInfoTolerances(){\n\n    var tolerances = defaultGetFeatureInfoTolerances;\n    if( 'pointTolerance' in config.options\n        && 'lineTolerance' in config.options\n        && 'polygonTolerance' in config.options\n    ){\n      tolerances = {\n        'FI_POINT_TOLERANCE': config.options.pointTolerance,\n        'FI_LINE_TOLERANCE': config.options.lineTolerance,\n        'FI_POLYGON_TOLERANCE': config.options.polygonTolerance\n      };\n    }\n    return tolerances;\n\n  }\n\n  /* PRIVATE function: isHighDensity\n   * Return True when the screen is of high density\n   * Returns:\n   * Boolean\n   */\n  function isHighDensity(){\n    return ((window.matchMedia && (window.matchMedia('only screen and (min-resolution: 124dpi), only screen and (min-resolution: 1.3dppx), only screen and (min-resolution: 48.8dpcm)').matches || window.matchMedia('only screen and (-webkit-min-device-pixel-ratio: 1.3), only screen and (-o-min-device-pixel-ratio: 2.6/2), only screen and (min--moz-device-pixel-ratio: 1.3), only screen and (min-device-pixel-ratio: 1.3)').matches)) || (window.devicePixelRatio && window.devicePixelRatio > 1.3));\n  }\n\n  function deactivateMaplayerFilter (layername) {\n    var layerN = layername;\n    var layer = null;\n    var layers = map.getLayersByName( cleanName(layername) );\n    if( layers.length == 1) {\n      layer = layers[0];\n    }\n\n    // Remove layer filter\n    delete layer.params['FILTER'];\n    delete layer.params['FILTERTOKEN'];\n    delete layer.params['EXP_FILTER'];\n    if( !('request_params' in config.layers[layername]) ){\n      config.layers[layername]['request_params'] = {};\n    }\n    config.layers[layername]['request_params']['exp_filter'] = null;\n    config.layers[layername]['request_params']['filtertoken'] = null;\n    config.layers[layername]['request_params']['filter'] = null;\n    layer.redraw();\n  }\n\n  function triggerLayerFilter (layername, filter) {\n      // Get layer information\n      var layerN = layername;\n      var layer = null;\n      var layers = map.getLayersByName( cleanName(layername) );\n      if( layers.length == 1) {\n        layer = layers[0];\n      }\n      if(!layer)\n          return false;\n      if( layer.params) {\n        layerN = layer.params['LAYERS'];\n      }\n\n      // Add filter to the layer\n      if( !filter || filter == ''){\n        filter = null;\n        var lfilter = null;\n\n      }else{\n        var lfilter = layerN + ':' + filter;\n      }\n      layer.params['FILTER'] = lfilter;\n      if( !('request_params' in config.layers[layername]) ){\n        config.layers[layername]['request_params'] = {};\n      }\n\n      // Add WFS exp_filter param\n      config.layers[layername]['request_params']['exp_filter'] = filter;\n\n      // Get WMS filter token ( used via GET in GetMap or GetPrint )\n      var surl = OpenLayers.Util.urlAppend(lizUrls.wms\n        ,OpenLayers.Util.getParameterString(lizUrls.params)\n      );\n      var sdata = {\n        service: 'WMS',\n        request: 'GETFILTERTOKEN',\n        typename: layername,\n        filter: lfilter\n      };\n      $.post(surl, sdata, function(result){\n        var filtertoken = result.token;\n        // Add OpenLayers layer parameter\n        delete layer.params['FILTER'];\n        layer.params['FILTERTOKEN'] = filtertoken\n        config.layers[layername]['request_params']['filtertoken'] = filtertoken;\n\n        // Redraw openlayers layer\n        if( config.layers[layername]['geometryType']\n          && config.layers[layername]['geometryType'] != 'none'\n          && config.layers[layername]['geometryType'] != 'unknown'\n        ){\n            //layer.redraw(true);\n          layer.redraw();\n        }\n\n        // Tell popup to be aware of the filter\n        lizMap.events.triggerEvent(\"layerFilterParamChanged\",\n          {\n            'featureType': layername,\n            'filter': lfilter,\n            'updateDrawing': false\n          }\n        );\n      });\n\n      return true;\n  }\n\n  // creating the lizMap object\n  var obj = {\n    /**\n     * Property: map\n     * {<OpenLayers.Map>} The map\n     */\n    map: null,\n    /**\n     * Property: layers\n     * {Array(<OpenLayers.Layer>)} The layers\n     */\n    layers: null,\n    /**\n     * Property: baselayers\n     * {Array(<OpenLayers.Layer>)} The base layers\n     */\n    baselayers: null,\n    /**\n     * Property: events\n     * {<OpenLayers.Events>} An events object that handles all\n     *                       events on the lizmap\n     */\n    events: null,\n    /**\n     * Property: config\n     * {Object} The map config\n     */\n    config: null,\n    /**\n     * Property: dictionnary\n     * {Object} The map dictionnary\n     */\n    dictionary: null,\n    /**\n     * Property: tree\n     * {Object} The map tree\n     */\n    tree: null,\n    /**\n     * Property: lizmapLayerFilterActive\n     * {Object} Contains main filtered layer if filter is active\n     */\n    lizmapLayerFilterActive: null,\n\n    /**\n     * Method: checkMobile\n     */\n    checkMobile: function() {\n      return mCheckMobile();\n    },\n\n    /**\n     * Method: cleanName\n     */\n    cleanName: function( aName ) {\n      return cleanName( aName );\n    },\n\n    /**\n     * Method: getNameByCleanName\n     */\n    getNameByCleanName: function( cleanName ) {\n      return getNameByCleanName( cleanName );\n    },\n\n    /**\n     * Method: getNameByShortName\n     */\n    getNameByShortName: function( shortName ) {\n      return getNameByShortName( shortName );\n    },\n\n    /**\n     * Method: getNameByTypeName\n     */\n    getNameByTypeName: function( typeName ) {\n      return getNameByTypeName( typeName );\n    },\n\n    /**\n     * Method: getLayerNameByCleanName\n     */\n    getLayerNameByCleanName: function( cleanName ) {\n      return getLayerNameByCleanName( cleanName );\n    },\n\n    /**\n     * Method: addMessage\n     */\n    addMessage: function( aMessage, aType, aClose ) {\n      return mAddMessage( aMessage, aType, aClose );\n    },\n\n    /**\n     * Method: updateMiniDockSize\n     */\n    updateMiniDockSize: function() {\n      return updateMiniDockSize();\n    },\n\n    /**\n     * Method: transformBounds\n     */\n    loadProjDefinition: function( aCRS, aCallback ) {\n      return loadProjDefinition( aCRS, aCallback );\n    },\n\n\n    /**\n     * Method: updateContentSize\n     */\n    updateContentSize: function() {\n      return updateContentSize();\n    },\n\n    /**\n     * Method: clearDrawLayer\n     */\n    clearDrawLayer: function(layerName) {\n      return clearDrawLayer(layerName);\n    },\n\n    /**\n     * Method: getLayerFeature\n     */\n    getLayerFeature: function( featureType, fid, aCallback, aCallbackNotfound, forceToLoad ) {\n      getLayerFeature( featureType, fid, aCallback, aCallbackNotfound, forceToLoad );\n    },\n\n    /**\n     * Method: getFeatureData\n     */\n    getFeatureData: function(aName, aFilter, aFeatureID, aGeometryName, restrictToMapExtent, startIndex, maxFeatures, aCallBack) {\n      getFeatureData(aName, aFilter, aFeatureID, aGeometryName, restrictToMapExtent, startIndex, maxFeatures, aCallBack);\n    },\n\n    /**\n     * Method: translateWfsFieldValues\n     */\n    translateWfsFieldValues: function(aName, fieldName, fieldValue, translation_dict) {\n      return translateWfsFieldValues(aName, fieldName, fieldValue, translation_dict);\n    },\n\n    /**\n     * Method: zoomToFeature\n     */\n    zoomToFeature: function( featureType, fid, zoomAction ) {\n      zoomToFeature( featureType, fid, zoomAction );\n    },\n\n\n    /**\n     * Method: getPrintGridInterval\n     */\n    getPrintGridInterval: function(aLayout, aScale, aScales) {\n      return getPrintGridInterval(aLayout, aScale, aScales);\n    },\n\n\n    /**\n     * Method: getPrintCapabilities\n     */\n    getPrintCapabilities: function() {\n      return printCapabilities;\n    },\n\n\n    /**\n     * Method: getExternalBaselayersReplacement\n     */\n    getExternalBaselayersReplacement: function() {\n      return externalBaselayersReplacement;\n    },\n\n    /**\n     * Method: launchTooltipLayer\n     */\n    launchTooltipLayer: function( aLayerName ) {\n        var tlOptions = $('#tooltip-layer-list option[value=\"'+aLayerName+'\"]');\n        if ( tlOptions.length == 1 && $('#tooltip-layer-list').val() != aLayerName)\n            $('#tooltip-layer-list').val( aLayerName ).change();\n        else if ( tlOptions.length != 1 && $('#tooltip-layer-list').val() != '' )\n            $('#tooltip-layer-list').val('').change();\n        return ($('#tooltip-layer-list').val() == aLayerName);\n    },\n\n\n    launchEdition: function() {\n        return false;\n    },\n\n    deleteEditionFeature: function(){\n        return false;\n    },\n\n    deactivateToolControls: function( evt ) {\n      return deactivateToolControls( evt );\n    },\n\n    /**\n     * Method: exportVectorLayer\n     */\n    exportVectorLayer: function( aName, eformat, restrictToMapExtent ) {\n      return exportVectorLayer( aName, eformat, restrictToMapExtent );\n    },\n\n    /**\n     * Method: getVectorLayerWfsUrl\n     */\n    getVectorLayerWfsUrl: function( aName, aFilter, aFeatureId, geometryName, restrictToMapExtent ) {\n      return getVectorLayerWfsUrl( aName, aFilter, aFeatureId, geometryName, restrictToMapExtent );\n    },\n\n    /**\n     * Method: getVectorLayerFeatureType\n     * @returns {Array} Array of FeatureType Elements\n     */\n    getVectorLayerFeatureTypes: function() {\n      return getVectorLayerFeatureTypes();\n    },\n\n    /**\n     * Method: getVectorLayerResultFormat\n     * @returns {string[]} Array of format for file export\n     */\n    getVectorLayerResultFormat: function() {\n      return getVectorLayerResultFormat();\n    },\n\n    /**\n     * Method: getLayerConfigById\n     */\n    getLayerConfigById: function( aLayerId, aConfObjet, aIdAttribute ) {\n      return getLayerConfigById( aLayerId, aConfObjet, aIdAttribute );\n    },\n\n    /**\n     * Method: getFeaturePopupContent\n     */\n    getFeaturePopupContent: function( aName, feat, aCallback) {\n      return getFeaturePopupContent(aName, feat, aCallback);\n    },\n\n    /**\n     * Method: getFeaturePopupContentByFeatureIntersection\n     */\n    getFeaturePopupContentByFeatureIntersection: function( aName, feat, aCallback) {\n      return getFeaturePopupContentByFeatureIntersection(aName, feat, aCallback);\n    },\n\n    /**\n     * Method: selectLayerFeaturesFromSelectionFeature\n     */\n    selectLayerFeaturesFromSelectionFeature: function (targetFeatureType, selectionFeature, geomOperator = 'intersects') {\n      return selectLayerFeaturesFromSelectionFeature(targetFeatureType, selectionFeature, geomOperator);\n    },\n\n    /**\n     * Method: addGeometryFeatureInfo\n     */\n    addGeometryFeatureInfo: function(popup, containerId){\n      return addGeometryFeatureInfo(popup, containerId);\n    },\n\n    /**\n     * Method: addChildrenFeatureInfo\n     */\n    addChildrenFeatureInfo: function(popup, containerId){\n      return addChildrenFeatureInfo(popup, containerId);\n    },\n\n    /**\n     * Method: addChildrenDatavizFilteredByPopupFeature\n     */\n    addChildrenDatavizFilteredByPopupFeature: function(popup, containerId){\n      return addChildrenDatavizFilteredByPopupFeature(popup, containerId);\n    },\n\n    /**\n     * Method: addDock\n     */\n    addDock: function( dname, dlabel, dtype, dcontent, dicon){\n      return addDock(dname, dlabel, dtype, dcontent, dicon);\n    },\n\n    /**\n     * Method: getHashParamFromUrl\n     * Utility function to get searched key in URL's hash\n     * @param {string} hash_key - searched key in hash\n     * @return {string} value for searched key\n     * @example\n     * URL: https://liz.map/index.php/view/map/?repository=demo&project=cats#fid:v_cat20180426181713938.16,other_param:foo\n     * console.log(getHashParamFromUrl('fid'))\n     * returns 'v_cat20180426181713938.16'\n     */\n    getHashParamFromUrl: function (hash_key) {\n      var ret_val = null;\n      var hash = location.hash.replace('#', '');\n      var hash_items = hash.split(',');\n      for (var i in hash_items) {\n        var item = hash_items[i];\n        var param = item.split(':');\n        if (param.length == 2) {\n          var key = param[0];\n          var val = param[1];\n          if (key == hash_key) {\n            return val;\n          }\n        }\n      }\n      return ret_val;\n    },\n\n\n    /**\n     * Apply the global filter on a OpenLayer layer\n     * Only used by filter.js and timemanager.js\n     */\n    triggerLayerFilter: function (layername, filter) {\n      return triggerLayerFilter(layername, filter);\n    },\n\n    /**\n     * Deactivate the global filter on a OpenLayer layer\n     * Only used by filter.js and timemanager.js\n     */\n    deactivateMaplayerFilter: function (layername) {\n      // Get layer information\n      return deactivateMaplayerFilter(layername);\n    },\n\n\n\n    /**\n     * Method: init\n     */\n    init: function() {\n      var self = this;\n\n      var service = OpenLayers.Util.urlAppend(lizUrls.wms\n        , OpenLayers.Util.getParameterString(lizUrls.params)\n      );\n\n      // Get config\n      const configRequest = fetch(OpenLayers.Util.urlAppend(lizUrls.config, OpenLayers.Util.getParameterString(lizUrls.params))).then(function (response) {\n        return response.json()\n      });\n\n      // Get WMS, WMTS, WFS capabilities\n      const WMSRequest = fetch(OpenLayers.Util.urlAppend(service, OpenLayers.Util.getParameterString({ SERVICE: 'WMS', REQUEST: 'GetCapabilities', VERSION: '1.3.0' }))).then(function (response) {\n        return response.text()\n      });\n      const WMTSRequest = fetch(OpenLayers.Util.urlAppend(service, OpenLayers.Util.getParameterString({ SERVICE: 'WMTS', REQUEST: 'GetCapabilities', VERSION: '1.0.0' }))).then(function (response) {\n        return response.text()\n      });\n      const WFSRequest = fetch(OpenLayers.Util.urlAppend(service, OpenLayers.Util.getParameterString({ SERVICE: 'WFS', REQUEST: 'GetCapabilities', VERSION: '1.0.0' }))).then(function (response) {\n        return response.text()\n      });\n\n      // Request config and capabilities in parallel\n      Promise.all([configRequest, WMSRequest, WMTSRequest, WFSRequest]).then(responses => {\n        // config is defined globally\n        config = responses[0];\n\n        const domparser = new DOMParser();\n\n        const wmsCapaData = responses[1];\n        const wmtsCapaData = responses[2];\n        const wfsCapaData = responses[3];\n\n        config.options.hasOverview = false;\n\n        // store layerIDs\n        if ('useLayerIDs' in config.options && config.options.useLayerIDs == 'True') {\n          for (var layerName in config.layers) {\n            var configLayer = config.layers[layerName];\n            layerIdMap[configLayer.id] = layerName;\n          }\n        }\n        // store shortnames and shortnames\n        for (var layerName in config.layers) {\n          var configLayer = config.layers[layerName];\n          if ('shortname' in configLayer && configLayer.shortname != '')\n            shortNameMap[configLayer.shortname] = layerName;\n          configLayer.cleanname = cleanName(layerName);\n        }\n\n        //parse capabilities\n        if (!parseData(wmsCapaData))\n          return true;\n\n        var wmtsFormat = new OpenLayers.Format.WMTSCapabilities({});\n        wmtsCapabilities = wmtsFormat.read(wmtsCapaData);\n        if ('exceptionReport' in wmtsCapabilities) {\n          var wmtsElem = $('#metadata-wmts-getcapabilities-url');\n          if (wmtsElem.length != 0) {\n            wmtsElem.before('<i title=\"' + wmtsCapabilities.exceptionReport.exceptions[0].texts[0] + '\" class=\"icon-warning-sign\"></i>&nbsp;');\n          }\n          wmtsCapabilities = null;\n        }\n\n        wfsCapabilities = domparser.parseFromString(wfsCapaData, \"application/xml\");\n        var featureTypes = getVectorLayerFeatureTypes();\n\n        for (const featureType of featureTypes) {\n          var typeName = featureType.getElementsByTagName('Name')[0].textContent;\n          var layerName = lizMap.getNameByTypeName(typeName);\n          if (!layerName) {\n            if (typeName in config.layers)\n              layerName = typeName\n            else if ((typeName in shortNameMap) && (shortNameMap[typeName] in config.layers))\n              layerName = shortNameMap[typeName];\n            else {\n              for (l in config.layers) {\n                if (l.split(' ').join('_') == typeName) {\n                  layerName = l;\n                  break;\n                }\n              }\n            }\n          }\n\n          if (!(layerName in config.layers))\n            continue;\n\n          var configLayer = config.layers[layerName];\n          configLayer.typename = typeName;\n          typeNameMap[typeName] = layerName;\n        }\n\n        //set title and abstract coming from capabilities\n        $('#abstract').html(capabilities.abstract ? capabilities.abstract : '');\n\n        // get and analyse tree\n        var capability = capabilities.capability;\n\n        // Copy QGIS project's projection\n        config.options.qgisProjectProjection = Object.assign({}, config.options.projection);\n\n        beforeLayerTreeCreated();\n        var firstLayer = capability.nestedLayers[0];\n        getLayerTree(firstLayer, tree);\n        analyseNode(tree);\n        self.config = config;\n        self.tree = tree;\n        self.events.triggerEvent(\"treecreated\", self);\n\n        // create the map\n        initProjections(firstLayer);\n        createMap();\n        self.map = map;\n        self.layers = layers;\n        self.baselayers = baselayers;\n        self.controls = controls;\n        self.events.triggerEvent(\"mapcreated\", self);\n\n        // create the switcher\n        createSwitcher();\n        self.events.triggerEvent(\"layersadded\", self);\n\n\n        // Verifying z-index\n        var lastLayerZIndex = map.layers[map.layers.length - 1].getZIndex();\n        if (lastLayerZIndex > map.Z_INDEX_BASE['Feature'] - 100) {\n          map.Z_INDEX_BASE['Feature'] = lastLayerZIndex + 100;\n          map.Z_INDEX_BASE['Popup'] = map.Z_INDEX_BASE['Feature'] + 25;\n          if (map.Z_INDEX_BASE['Popup'] > map.Z_INDEX_BASE['Control'] - 25)\n            map.Z_INDEX_BASE['Control'] = map.Z_INDEX_BASE['Popup'] + 25;\n        }\n\n        // initialize the map\n        // Set map extent depending on options\n        var verifyingVisibility = true;\n        var hrefParam = OpenLayers.Util.getParameters(window.location.href);\n        if (!map.getCenter()) {\n          if (hrefParam.bbox || hrefParam.BBOX) {\n            var hrefBbox = null;\n            if (hrefParam.bbox)\n              hrefBbox = OpenLayers.Bounds.fromArray(hrefParam.bbox);\n            if (hrefParam.BBOX)\n              hrefBbox = OpenLayers.Bounds.fromArray(hrefParam.BBOX);\n\n            if (hrefParam.crs && hrefParam.crs != map.getProjection())\n              hrefBbox.transform(hrefParam.crs, map.getProjection())\n            if (hrefParam.CRS && hrefParam.CRS != map.getProjection())\n              hrefBbox.transform(hrefParam.CRS, map.getProjection())\n            if (map.restrictedExtent.containsBounds(hrefBbox))\n              map.zoomToExtent(hrefBbox, true);\n            else {\n              var projBbox = $('#metadata .bbox').text();\n              projBbox = OpenLayers.Bounds.fromString(projBbox);\n              if (projBbox.containsBounds(hrefBbox)) {\n                var projProj = $('#metadata .proj').text();\n                loadProjDefinition(projProj, function (aProj) {\n                  hrefBbox.transform(aProj, map.getProjection());\n                  map.zoomToExtent(hrefBbox, true);\n                });\n              } else {\n                map.zoomToExtent(map.initialExtent);\n              }\n            }\n          } else {\n            map.zoomToExtent(map.initialExtent);\n          }\n          verifyingVisibility = false;\n        }\n\n        updateContentSize();\n        map.events.triggerEvent(\"zoomend\", { \"zoomChanged\": true });\n\n        // create navigation and toolbar\n        createNavbar();\n        createToolbar();\n        self.events.triggerEvent(\"toolbarcreated\", self);\n\n        // create permalink\n        createPermalink();\n\n        // Toggle OpenLayers visibility to true for legend checkboxes\n        // 1/ Check permalink is used or not\n        var layersHaveBeenActivatedByPermalink = false;\n        var uparams = getUrlParameters();\n        if ('layers' in uparams) {\n          var players = uparams.layers;\n          for (var i = 0; i < map.layers.length; i++) {\n            var l = map.layers[i];\n            var lbase = l.isBaseLayer;\n            if (!lbase) {\n              if (players[i] == 'T') {\n                layersHaveBeenActivatedByPermalink = true;\n                l.setVisibility(true);\n              }\n            }\n          }\n          runPermalink(uparams);\n        }\n\n        // 2/ Toggle checkboxes\n        $('#switcher button.checkbox[name=\"layer\"]').each(function () {\n          var cb = $(this);\n          var cleanName = cb.val();\n          var oLayer = map.getLayersByName(cleanName)[0];\n          if (oLayer) {\n            // toggle checked class for permalink layers\n            // because OL has already drawn them in map\n            cb.toggleClass('checked', oLayer.visibility);\n\n            // Check layers wich are not yet checked but need to ( for normal behaviour outside permalink )\n            // This will trigger layers to be drawn\n            if (!cb.hasClass('checked') && oLayer.isVisible && !layersHaveBeenActivatedByPermalink) {\n              cb.click();\n            }\n          }\n\n        });\n\n        // verifying the layer visibility for permalink\n        if (verifyingVisibility) {\n          map.getControlsByClass('OpenLayers.Control.ArgParser')[0].configureLayers();\n          for (var i = 0, len = layers.length; i < len; i++) {\n            var l = layers[i];\n            var btn = $('#switcher button.checkbox[name=\"layer\"][value=\"' + l.name + '\"]');\n            if ((hrefParam.layers && l.getVisibility() != btn.hasClass('checked')))\n              $('#switcher button.checkbox[name=\"layer\"][value=\"' + l.name + '\"]').click();\n          }\n        }\n\n        // checked all toggled layer\n        $('#switcher button.checkbox.disabled[name=\"layer\"]:not(.checked)').each(function () {\n          var cb = $(this);\n          var cleanName = cb.val();\n          var name = cleanName;\n          if (cleanName in cleanNameMap)\n            name = getLayerNameByCleanName(cleanName);\n          if (name in config.layers) {\n            var layerConfig = config.layers[name];\n            if (layerConfig.toggled == \"True\")\n              cb.addClass('checked');\n          }\n        });\n\n        // finalize slider\n        $('#navbar div.slider').slider(\"value\", map.getZoom());\n        map.events.on({\n          zoomend: function () {\n            // Update legends\n            $('#switcher table.tree tr.legendGraphics.initialized').each(function () {\n              var self = $(this);\n              var name = self.attr('id').replace('legend-', '');\n              var url = getLayerLegendGraphicUrl(name, true);\n              if (url != null && url != '') {\n                // Change image attribute data-src\n                self.find('div.legendGraphics img').attr('data-src', url);\n                // Only change image attribute src if legend is displayed\n                if (self.hasClass('visible')) {\n                  self.find('div.legendGraphics img').attr('src', url);\n                }\n              }\n            });\n            // update slider position\n            $('#navbar div.slider').slider(\"value\", this.getZoom());\n          }\n        });\n\n        // Connect signal/slot when layer style is changed\n        lizMap.events.on({\n          'layerstylechanged': function (evt) {\n\n            // Change legend data-src and legend src if legend is visible\n            var name = evt.featureType;\n            var url = getLayerLegendGraphicUrl(name, true);\n            if (url != null && url != '') {\n              var lSel = '#switcher table.tree tr#legend-' + name + ' div.legendGraphics img';\n              $(lSel).attr('data-src', url);\n              if ($('#switcher table.tree tr#legend-' + name).hasClass('visible'))\n                $(lSel).attr('src', url);\n            }\n          }\n        });\n\n        // Toggle locate\n        $('#mapmenu ul').on('click', 'li.nav-minidock > a', function () {\n          var self = $(this);\n          var parent = self.parent();\n          var id = self.attr('href').substr(1);\n          var tab = $('#nav-tab-' + id);\n          if (parent.hasClass('active')) {\n            $('#' + id).removeClass('active');\n            tab.removeClass('active');\n            parent.removeClass('active');\n            lizMap.events.triggerEvent(\"minidockclosed\", { 'id': id });\n          } else {\n            var oldActive = $('#mapmenu li.nav-minidock.active');\n            if (oldActive.length != 0) {\n              oldActive.removeClass('active');\n              lizMap.events.triggerEvent(\"minidockclosed\", { 'id': oldActive.children('a').first().attr('href').substr(1) });\n            }\n            tab.children('a').first().click();\n            parent.addClass('active');\n            lizMap.events.triggerEvent(\"minidockopened\", { 'id': id });\n            updateMiniDockSize();\n          }\n          self.blur();\n\n          return false;\n        });\n\n        // Show locate by layer\n        if (!('locateByLayer' in config))\n          $('#button-locate').parent().hide();\n        else\n          $('#button-locate').click();\n\n        // hide mini-dock if no tool is active\n        if ($('#mapmenu ul li.nav-minidock.active').length == 0) {\n          $('#mini-dock-content > .tab-pane.active').removeClass('active');\n          $('#mini-dock-tabs li.active').removeClass('active');\n        }\n\n        $('#mapmenu ul').on('click', 'li.nav-dock > a', function () {\n          var self = $(this);\n          var parent = self.parent();\n          var id = self.attr('href').substr(1);\n          var tab = $('#nav-tab-' + id);\n          var lizmapEvent = '';\n          if (parent.hasClass('active')) {\n            $('#' + id).removeClass('active');\n            tab.removeClass('active');\n            parent.removeClass('active');\n            lizmapEvent = 'dockclosed';\n          } else {\n            var oldActive = $('#mapmenu li.nav-dock.active');\n            if (oldActive.length != 0) {\n              oldActive.removeClass('active');\n              lizMap.events.triggerEvent(\"dockclosed\", { 'id': oldActive.children('a').first().attr('href').substr(1) });\n            }\n            tab.show();\n            tab.children('a').first().click();\n            parent.addClass('active');\n            lizmapEvent = 'dockopened';\n          }\n          self.blur();\n\n          var dock = $('#dock');\n          if ($('#dock-tabs .active').length == 0)\n            dock.hide();\n          else if (!dock.is(':visible'))\n            dock.show();\n\n          // trigger event\n          if (lizmapEvent != '')\n            lizMap.events.triggerEvent(lizmapEvent, { 'id': id });\n\n          return false;\n        });\n\n        $('#mapmenu ul').on('click', 'li.nav-right-dock > a', function () {\n          var self = $(this);\n          var parent = self.parent();\n          var id = self.attr('href').substr(1);\n          var tab = $('#nav-tab-' + id);\n          var lizmapEvent = '';\n          if (parent.hasClass('active')) {\n            $('#' + id).removeClass('active');\n            tab.removeClass('active');\n            parent.removeClass('active');\n            var lizmapEvent = 'rightdockclosed';\n          } else {\n            var oldActive = $('#mapmenu li.nav-right-dock.active');\n            if (oldActive.length != 0) {\n              oldActive.removeClass('active');\n              lizMap.events.triggerEvent(\"rightdockclosed\", { 'id': oldActive.children('a').first().attr('href').substr(1) });\n            }\n            tab.show();\n            tab.children('a').first().click();\n            parent.addClass('active');\n            var lizmapEvent = 'rightdockopened';\n          }\n          self.blur();\n\n          var dock = $('#right-dock');\n          if ($('#right-dock-tabs .active').length == 0) {\n            dock.hide();\n            $('#content').removeClass('right-dock-visible');\n            updateContentSize();\n          } else if (!dock.is(':visible')) {\n            $('#content').addClass('right-dock-visible');\n            dock.show();\n            updateContentSize();\n          }\n\n          // trigger event\n          if (lizmapEvent != '')\n            lizMap.events.triggerEvent(lizmapEvent, { 'id': id });\n          return false;\n        });\n\n        // Toggle menu visibility\n        $('#menuToggle').click(function(){\n          $(this).toggleClass('opened');\n        });\n\n        // Hide mapmenu when menu item is clicked in mobile context\n        $('#menuToggle:visible ~ #mapmenu ul').on('click', 'li > a', function () {\n          $('#menuToggle').removeClass('opened');\n        });\n\n        // Show layer switcher\n        $('#button-switcher').click();\n        updateContentSize();\n\n        $('#headermenu .navbar-inner .nav a[rel=\"tooltip\"]').tooltip();\n        $('#mapmenu .nav a[rel=\"tooltip\"]').tooltip();\n        self.events.triggerEvent(\"uicreated\", self);\n\n        $('body').css('cursor', 'auto');\n        $('#loading').dialog('close');\n      });\n    }\n  };\n  // initializing the lizMap events\n  obj.events = new OpenLayers.Events(\n      obj, null,\n      ['treecreated','mapcreated','layersadded','uicreated',\n       'dockopened','dockclosed'],\n      true,\n      {includeXY: true}\n    );\n  return obj;\n}();\n/*\n * it's possible to add event listener\n * before the document is ready\n * but after this file\n */\nlizMap.events.on({\n    'mapcreated':function(evt){\n      // Add empty baselayer to the map\n      if ( ('emptyBaselayer' in evt.config.options)\n         && evt.config.options.emptyBaselayer == 'True') {\n        // creating the empty base layer\n        layerConfig = {};\n        layerConfig.title = lizDict['baselayer.empty.title'];\n        layerConfig.name = 'emptyBaselayer';\n        evt.config.layers['emptyBaselayer'] = layerConfig;\n\n        evt.baselayers.push(new OpenLayers.Layer.Vector('emptyBaselayer',{\n          isBaseLayer: true\n         ,maxExtent: evt.map.maxExtent\n         ,maxScale: evt.map.maxScale\n         ,minScale: evt.map.minScale\n         ,numZoomLevels: evt.map.numZoomLevels\n         ,scales: evt.map.scales\n         ,projection: evt.map.projection\n         ,units: evt.map.projection.proj.units\n        }));\n        evt.map.allOverlays = false;\n      }\n\n      // Add OpenStreetMap, Google Maps, Bing Maps, IGN Geoportail\n      // baselayers to the map\n      if (\n    (('osmMapnik' in evt.config.options)\n    && evt.config.options.osmMapnik == 'True') ||\n    (('osmStamenToner' in evt.config.options)\n     && evt.config.options.osmStamenToner == 'True') ||\n    (('osmCyclemap' in evt.config.options)\n     && evt.config.options.osmCyclemap == 'True'\n     && ('OCMKey' in evt.config.options)) ||\n    (('googleStreets' in evt.config.options)\n     && evt.config.options.googleStreets == 'True') ||\n    (('googleSatellite' in evt.config.options)\n     && evt.config.options.googleSatellite == 'True') ||\n    (('googleHybrid' in evt.config.options)\n     && evt.config.options.googleHybrid == 'True') ||\n    (('googleTerrain' in evt.config.options)\n     && evt.config.options.googleTerrain == 'True') ||\n    (('bingStreets' in evt.config.options)\n     && evt.config.options.bingStreets == 'True'\n     && ('bingKey' in evt.config.options)) ||\n    (('bingSatellite' in evt.config.options)\n     && evt.config.options.bingSatellite == 'True'\n     && ('bingKey' in evt.config.options)) ||\n    (('bingHybrid' in evt.config.options)\n     && evt.config.options.bingHybrid == 'True'\n     && ('bingKey' in evt.config.options)) ||\n    (('ignTerrain' in evt.config.options)\n     && evt.config.options.ignTerrain == 'True') ||\n    (('ignStreets' in evt.config.options)\n     && evt.config.options.ignStreets == 'True') ||\n    (('ignSatellite' in evt.config.options)\n     && evt.config.options.ignSatellite == 'True') ||\n    (('ignCadastral' in evt.config.options)\n     && evt.config.options.ignCadastral == 'True')\n    ) {\n      //adding baselayers\n      var maxExtent = null;\n      if ( OpenLayers.Projection.defaults['EPSG:900913'].maxExtent )\n        maxExtent = new OpenLayers.Bounds(OpenLayers.Projection.defaults['EPSG:900913'].maxExtent);\n      else if ( OpenLayers.Projection.defaults['EPSG:3857'].maxExtent )\n        maxExtent = new OpenLayers.Bounds(OpenLayers.Projection.defaults['EPSG:3857'].maxExtent);\n\n      var lOptions = {zoomOffset:0,maxResolution:156543.03390625};\n      if (('resolutions' in evt.config.options)\n          && evt.config.options.resolutions.length != 0 ){\n        var resolutions = evt.config.options.resolutions;\n        var maxRes = resolutions[0];\n        var numZoomLevels = resolutions.length;\n        var zoomOffset = 0;\n        var res = 156543.03390625;\n        while ( res > maxRes ) {\n          zoomOffset += 1;\n          res = 156543.03390625 / Math.pow(2, zoomOffset);\n        }\n        lOptions['zoomOffset'] = zoomOffset;\n        lOptions['maxResolution'] = maxRes;\n        lOptions['numZoomLevels'] = numZoomLevels;\n      }\n\n      if (('osmMapnik' in evt.config.options) && evt.config.options.osmMapnik == 'True') {\n        evt.map.allOverlays = false;\n        var options = {\n          zoomOffset: 0,\n          maxResolution:156543.03390625,\n          numZoomLevels:23\n        };\n        if (lOptions.zoomOffset != 0) {\n          options.zoomOffset = lOptions.zoomOffset;\n          options.maxResolution = lOptions.maxResolution;\n        }\n        if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n          options.numZoomLevels = lOptions.numZoomLevels;\n        else\n          options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n        var osm = new OpenLayers.Layer.OSM('osm',\n            [\n            \"https://a.tile.openstreetmap.org/${z}/${x}/${y}.png\",\n            \"https://b.tile.openstreetmap.org/${z}/${x}/${y}.png\",\n            \"https://c.tile.openstreetmap.org/${z}/${x}/${y}.png\"\n            ]\n            ,options\n            );\n        osm.maxExtent = maxExtent;\n        var osmCfg = {\n             \"name\":\"osm\"\n            ,\"title\":\"OpenStreetMap\"\n            ,\"type\":\"baselayer\"\n        };\n        evt.config.layers['osm'] = osmCfg;\n        evt.baselayers.push(osm);\n      }\n\n      if (('osmStamenToner' in evt.config.options) && evt.config.options.osmStamenToner == 'True') {\n        evt.map.allOverlays = false;\n        var options = {\n          zoomOffset: 0,\n          maxResolution:156543.03390625,\n          numZoomLevels:23\n        };\n        if (lOptions.zoomOffset != 0) {\n          options.zoomOffset = lOptions.zoomOffset;\n          options.maxResolution = lOptions.maxResolution;\n        }\n        if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n          options.numZoomLevels = lOptions.numZoomLevels;\n        else\n          options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n        var stamenToner = new OpenLayers.Layer.OSM('osm-toner',\n            [\"https://stamen-tiles-a.a.ssl.fastly.net/toner-lite/${z}/${x}/${y}.png\",\n            \"https://stamen-tiles-b.a.ssl.fastly.net/toner-lite/${z}/${x}/${y}.png\",\n            \"https://stamen-tiles-c.a.ssl.fastly.net/toner-lite/${z}/${x}/${y}.png\",\n            \"https://stamen-tiles-d.a.ssl.fastly.net/toner-lite/${z}/${x}/${y}.png\"]\n            ,options\n            );\n        stamenToner.maxExtent = maxExtent;\n        var stamenTonerCfg = {\n          \"name\":\"osm-toner\"\n            ,\"title\":\"OSM Stamen Toner\"\n            ,\"type\":\"baselayer\"\n        };\n        evt.config.layers['osm-toner'] = stamenTonerCfg;\n        evt.baselayers.push(stamenToner);\n      }\n\n      if (('osmCyclemap' in evt.config.options) && evt.config.options.osmCyclemap == 'True' && ('OCMKey' in evt.config.options)) {\n        evt.map.allOverlays = false;\n        var options = {\n          zoomOffset: 0,\n          maxResolution:156543.03390625,\n          numZoomLevels:23\n        };\n        if (lOptions.zoomOffset != 0) {\n          options.zoomOffset = lOptions.zoomOffset;\n          options.maxResolution = lOptions.maxResolution;\n        }\n        if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n          options.numZoomLevels = lOptions.numZoomLevels;\n        else\n          options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n        var cyclemap = new OpenLayers.Layer.OSM('osm-cyclemap','https://tile.thunderforest.com/cycle/${z}/${x}/${y}.png?apiKey='+evt.config.options.OCMKey,options);\n        cyclemap.maxExtent = maxExtent;\n        var cyclemapCfg = {\n             \"name\":\"osm-cycle\"\n            ,\"title\":\"OSM CycleMap\"\n            ,\"type\":\"baselayer\"\n        };\n        evt.config.layers['osm-cycle'] = cyclemapCfg;\n        evt.baselayers.push(cyclemap);\n      }\n      try {\n        if (('googleSatellite' in evt.config.options) && evt.config.options.googleSatellite == 'True') {\n          var options = {\n            zoomOffset: 0,\n            maxResolution:156543.03390625,\n            numZoomLevels:21\n          };\n          if (lOptions.zoomOffset != 0) {\n            options.zoomOffset = lOptions.zoomOffset;\n            options.maxResolution = lOptions.maxResolution;\n          }\n          if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n            options.numZoomLevels = lOptions.numZoomLevels;\n          else\n            options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n          var gsat = new OpenLayers.Layer.Google(\n              \"gsat\",\n              {type: google.maps.MapTypeId.SATELLITE\n                , numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel:options.zoomOffset}\n              );\n          gsat.maxExtent = maxExtent;\n          var gsatCfg = {\n               \"name\":\"gsat\"\n              ,\"title\":\"Google Satellite\"\n            ,\"type\":\"baselayer\"\n          };\n          evt.config.layers['gsat'] = gsatCfg;\n          evt.baselayers.push(gsat);\n          evt.map.allOverlays = false;\n          evt.map.zoomDuration = 0;\n        }\n        if (('googleHybrid' in evt.config.options) && evt.config.options.googleHybrid == 'True') {\n          var options = {\n            zoomOffset: 0,\n            maxResolution:156543.03390625,\n            numZoomLevels:20\n          };\n          if (lOptions.zoomOffset != 0) {\n            options.zoomOffset = lOptions.zoomOffset;\n            options.maxResolution = lOptions.maxResolution;\n          }\n          if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n            options.numZoomLevels = lOptions.numZoomLevels;\n          else\n            options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n          var ghyb = new OpenLayers.Layer.Google(\n              \"ghyb\",\n              {type: google.maps.MapTypeId.HYBRID\n                , numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel:options.zoomOffset}\n              );\n          ghyb.maxExtent = maxExtent;\n          var ghybCfg = {\n               \"name\":\"ghyb\"\n              ,\"title\":\"Google Hybrid\"\n            ,\"type\":\"baselayer\"\n          };\n          evt.config.layers['ghyb'] = ghybCfg;\n          evt.baselayers.push(ghyb);\n          evt.map.allOverlays = false;\n          evt.map.zoomDuration = 0;\n        }\n        if (('googleTerrain' in evt.config.options) && evt.config.options.googleTerrain == 'True') {\n          var options = {\n            zoomOffset: 0,\n            maxResolution:156543.03390625,\n            numZoomLevels:16\n          };\n          if (lOptions.zoomOffset != 0) {\n            options.zoomOffset = lOptions.zoomOffset;\n            options.maxResolution = lOptions.maxResolution;\n          }\n          if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n            options.numZoomLevels = lOptions.numZoomLevels;\n          else\n            options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n          var gphy = new OpenLayers.Layer.Google(\n              \"gphy\",\n              {type: google.maps.MapTypeId.TERRAIN\n              , numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel:options.zoomOffset}\n              );\n          gphy.maxExtent = maxExtent;\n          var gphyCfg = {\n               \"name\":\"gphy\"\n              ,\"title\":\"Google Terrain\"\n            ,\"type\":\"baselayer\"\n          };\n          evt.config.layers['gphy'] = gphyCfg;\n          evt.baselayers.push(gphy);\n          evt.map.allOverlays = false;\n          evt.map.zoomDuration = 0;\n       }\n       if (('googleStreets' in evt.config.options) && evt.config.options.googleStreets == 'True') {\n          var options = {\n            zoomOffset: 0,\n            maxResolution:156543.03390625,\n            numZoomLevels:20\n          };\n          if (lOptions.zoomOffset != 0) {\n            options.zoomOffset = lOptions.zoomOffset;\n            options.maxResolution = lOptions.maxResolution;\n          }\n          if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n            options.numZoomLevels = lOptions.numZoomLevels;\n          else\n            options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n         var gmap = new OpenLayers.Layer.Google(\n             \"gmap\", // the default\n             {numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel:options.zoomOffset}\n             );\n         gmap.maxExtent = maxExtent;\n         var gmapCfg = {\n              \"name\":\"gmap\"\n             ,\"title\":\"Google Streets\"\n             ,\"type\":\"baselayer\"\n         };\n         evt.config.layers['gmap'] = gmapCfg;\n         evt.baselayers.push(gmap);\n         evt.map.allOverlays = false;\n         evt.map.zoomDuration = 0;\n       }\n       if (('bingStreets' in evt.config.options) && evt.config.options.bingStreets == 'True' && ('bingKey' in evt.config.options))  {\n          var options = {\n            zoomOffset: 0,\n            maxResolution:156543.03390625,\n            numZoomLevels:23\n          };\n          if (lOptions.zoomOffset != 0) {\n            options.zoomOffset = lOptions.zoomOffset;\n            options.maxResolution = lOptions.maxResolution;\n          }\n          if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n            options.numZoomLevels = lOptions.numZoomLevels;\n          else\n            options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n          var bmap = new OpenLayers.Layer.Bing({\n             key: evt.config.options.bingKey,\n             type: \"Road\",\n             name: \"Bing Road\", // the default\n             numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel:options.zoomOffset\n          });\n          bmap.maxExtent = maxExtent;\n          var bmapCfg = {\n             \"name\":\"bmap\"\n            ,\"title\":\"Bing Road\"\n            ,\"type\":\"baselayer\"\n          };\n          evt.config.layers['bmap'] = bmapCfg;\n          evt.baselayers.push(bmap);\n          evt.map.allOverlays = false;\n       }\n       if (('bingSatellite' in evt.config.options) && evt.config.options.bingSatellite == 'True' && ('bingKey' in evt.config.options))  {\n          var options = {\n            zoomOffset: 0,\n            maxResolution:156543.03390625,\n            numZoomLevels:23\n          };\n          if (lOptions.zoomOffset != 0) {\n            options.zoomOffset = lOptions.zoomOffset;\n            options.maxResolution = lOptions.maxResolution;\n          }\n          if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n            options.numZoomLevels = lOptions.numZoomLevels;\n          else\n            options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n          var baerial = new OpenLayers.Layer.Bing({\n             key: evt.config.options.bingKey,\n             type: \"Aerial\",\n             name: \"Bing Aerial\", // the default\n             numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel:options.zoomOffset\n          });\n          baerial.maxExtent = maxExtent;\n          var baerialCfg = {\n             \"name\":\"baerial\"\n            ,\"title\":\"Bing Aerial\"\n            ,\"type\":\"baselayer\"\n          };\n          evt.config.layers['baerial'] = baerialCfg;\n          evt.baselayers.push(baerial);\n          evt.map.allOverlays = false;\n       }\n       if (('bingHybrid' in evt.config.options) && evt.config.options.bingHybrid == 'True' && ('bingKey' in evt.config.options))  {\n          var options = {\n            zoomOffset: 0,\n            maxResolution:156543.03390625,\n            numZoomLevels:23\n          };\n          if (lOptions.zoomOffset != 0) {\n            options.zoomOffset = lOptions.zoomOffset;\n            options.maxResolution = lOptions.maxResolution;\n          }\n          if (lOptions.zoomOffset+lOptions.numZoomLevels <= options.numZoomLevels)\n            options.numZoomLevels = lOptions.numZoomLevels;\n          else\n            options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n          var bhybrid = new OpenLayers.Layer.Bing({\n             key: evt.config.options.bingKey,\n             type: \"AerialWithLabels\",\n             name: \"Bing Hybrid\", // the default\n             numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel:options.zoomOffset\n          });\n          bhybrid.maxExtent = maxExtent;\n          var bhybridCfg = {\n             \"name\":\"bhybrid\"\n            ,\"title\":\"Bing Hybrid\"\n            ,\"type\":\"baselayer\"\n          };\n          evt.config.layers['bhybrid'] = bhybridCfg;\n          evt.baselayers.push(bhybrid);\n          evt.map.allOverlays = false;\n       }\n\n       var ignAttribution = '<a href=\"http://www.ign.fr\" target=\"_blank\"><img width=\"25\" src=\"https://wxs.ign.fr/static/logos/IGN/IGN.gif\" title=\"Institut national de l\\'information géographique et forestière\" alt=\"IGN\"></a>';\n\n       // IGN base layers\n        if ('ignKey' in evt.config.options){\n          var ignKey = evt.config.options.ignKey;\n\n          if (('ignTerrain' in evt.config.options) && evt.config.options.ignTerrain == 'True') {\n            var options = {\n              zoomOffset: 0,\n              maxResolution: 156543.03390625,\n              numZoomLevels: 18\n            };\n            if (lOptions.zoomOffset != 0) {\n              options.zoomOffset = lOptions.zoomOffset;\n              options.maxResolution = lOptions.maxResolution;\n            }\n            if (lOptions.zoomOffset + lOptions.numZoomLevels <= options.numZoomLevels)\n              options.numZoomLevels = lOptions.numZoomLevels;\n            else\n              options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n            var ignmap = new OpenLayers.Layer.WMTS({\n              name: \"ignmap\",\n              url: \"https://wxs.ign.fr/\" + ignKey + \"/geoportail/wmts\",\n              layer: \"GEOGRAPHICALGRIDSYSTEMS.MAPS\",\n              matrixSet: \"PM\",\n              style: \"normal\",\n              projection: new OpenLayers.Projection(\"EPSG:3857\"),\n              attribution: ignAttribution\n              , numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel: options.zoomOffset\n              , zoomOffset: options.zoomOffset\n\n            });\n            ignmap.maxExtent = maxExtent;\n            var ignmapCfg = {\n              \"name\": \"ignmap\"\n              , \"title\": \"IGN Scan\"\n              , \"type\": \"baselayer\"\n            };\n            evt.config.layers['ignmap'] = ignmapCfg;\n            evt.baselayers.push(ignmap);\n            evt.map.allOverlays = false;\n          }\n        }\n        if (('ignStreets' in evt.config.options) && evt.config.options.ignStreets == 'True') {\n          var options = {\n            zoomOffset: 0,\n            maxResolution: 156543.03390625,\n            numZoomLevels: 18\n          };\n          if (lOptions.zoomOffset != 0) {\n            options.zoomOffset = lOptions.zoomOffset;\n            options.maxResolution = lOptions.maxResolution;\n          }\n          if (lOptions.zoomOffset + lOptions.numZoomLevels <= options.numZoomLevels)\n            options.numZoomLevels = lOptions.numZoomLevels;\n          else\n            options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n          var ignplan = new OpenLayers.Layer.WMTS({\n            name: \"ignplan\",\n            url: \"https://wxs.ign.fr/cartes/geoportail/wmts\",\n            layer: \"GEOGRAPHICALGRIDSYSTEMS.PLANIGNV2\",\n            matrixSet: \"PM\",\n            style: \"normal\",\n            format: \"image/png\",\n            projection: new OpenLayers.Projection(\"EPSG:3857\"),\n            attribution: ignAttribution\n            , numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel: options.zoomOffset\n            , zoomOffset: options.zoomOffset\n\n          });\n          ignplan.maxExtent = maxExtent;\n          var ignplanCfg = {\n            \"name\": \"ignplan\"\n            , \"title\": \"IGN Plan\"\n            , \"type\": \"baselayer\"\n          };\n          evt.config.layers['ignplan'] = ignplanCfg;\n          evt.baselayers.push(ignplan);\n          evt.map.allOverlays = false;\n        }\n        if (('ignSatellite' in evt.config.options) && evt.config.options.ignSatellite == 'True') {\n          var options = {\n            zoomOffset: 0,\n            maxResolution: 156543.03390625,\n            numZoomLevels: 22\n          };\n          if (lOptions.zoomOffset != 0) {\n            options.zoomOffset = lOptions.zoomOffset;\n            options.maxResolution = lOptions.maxResolution;\n          }\n          if (lOptions.zoomOffset + lOptions.numZoomLevels <= options.numZoomLevels)\n            options.numZoomLevels = lOptions.numZoomLevels;\n          else\n            options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n          var ignphoto = new OpenLayers.Layer.WMTS({\n            name: \"ignphoto\",\n            url: \"https://wxs.ign.fr/ortho/geoportail/wmts\",\n            layer: \"ORTHOIMAGERY.ORTHOPHOTOS\",\n            matrixSet: \"PM\",\n            style: \"normal\",\n            projection: new OpenLayers.Projection(\"EPSG:3857\"),\n            attribution: ignAttribution\n            , numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel: options.zoomOffset\n            , zoomOffset: options.zoomOffset\n\n          });\n          ignphoto.maxExtent = maxExtent;\n          var ignphotoCfg = {\n            \"name\": \"ignphoto\"\n            , \"title\": \"IGN Photos\"\n            , \"type\": \"baselayer\"\n          };\n          evt.config.layers['ignphoto'] = ignphotoCfg;\n          evt.baselayers.push(ignphoto);\n          evt.map.allOverlays = false;\n        }\n        if (('ignCadastral' in evt.config.options) && evt.config.options.ignCadastral == 'True') {\n          var options = {\n            zoomOffset: 0,\n            maxResolution: 156543.03390625,\n            numZoomLevels: 20\n          };\n          if (lOptions.zoomOffset != 0) {\n            options.zoomOffset = lOptions.zoomOffset;\n            options.maxResolution = lOptions.maxResolution;\n          }\n          if (lOptions.zoomOffset + lOptions.numZoomLevels <= options.numZoomLevels)\n            options.numZoomLevels = lOptions.numZoomLevels;\n          else\n            options.numZoomLevels = options.numZoomLevels - lOptions.zoomOffset;\n          var igncadastral = new OpenLayers.Layer.WMTS({\n            name: \"igncadastral\",\n            url: \"https://wxs.ign.fr/parcellaire/geoportail/wmts\",\n            layer: \"CADASTRALPARCELS.PARCELLAIRE_EXPRESS\",\n            matrixSet: \"PM\",\n            style: \"normal\",\n            format: \"image/png\",\n            projection: new OpenLayers.Projection(\"EPSG:3857\"),\n            attribution: ignAttribution\n            , numZoomLevels: options.numZoomLevels, maxResolution: options.maxResolution, minZoomLevel: options.zoomOffset\n            , zoomOffset: options.zoomOffset\n\n          });\n          igncadastral.maxExtent = maxExtent;\n          var igncadastralCfg = {\n            \"name\": \"igncadastral\"\n            , \"title\": \"IGN Cadastre\"\n            , \"type\": \"baselayer\"\n          };\n          evt.config.layers['igncadastral'] = igncadastralCfg;\n          evt.baselayers.push(igncadastral);\n          evt.map.allOverlays = false;\n        }\n      } catch(e) {\n       }\n     }\n\n      if('lizmapExternalBaselayers' in evt.config){\n\n        var externalService = OpenLayers.Util.urlAppend(lizUrls.wms\n          ,OpenLayers.Util.getParameterString(lizUrls.params)\n        );\n        if (lizUrls.publicUrlList && lizUrls.publicUrlList.length > 1 ) {\n            externalService = [];\n            for (var j=0, jlen=lizUrls.publicUrlList.length; j<jlen; j++) {\n              externalService.push(\n                OpenLayers.Util.urlAppend(\n                  lizUrls.publicUrlList[j],\n                  OpenLayers.Util.getParameterString(lizUrls.params)\n                )\n              );\n            }\n        }\n\n        // Add lizmap external baselayers\n        for (var id in evt.config['lizmapExternalBaselayers']) {\n\n          var layerConfig = evt.config['lizmapExternalBaselayers'][id];\n\n          if (!('repository' in layerConfig) || !('project' in layerConfig))\n            continue;\n\n          var layerName = evt.cleanName(layerConfig.layerName);\n\n          var layerWmsParams = {\n            layers:layerConfig.layerName\n            ,version:'1.3.0'\n            ,exceptions:'application/vnd.ogc.se_inimage'\n            ,format:(layerConfig.layerImageFormat) ? 'image/'+layerConfig.layerImageFormat : 'image/png'\n            ,dpi:96\n          };\n          if (layerWmsParams.format != 'image/jpeg')\n            layerWmsParams['transparent'] = true;\n\n          // Change repository and project in service URL\n          var reg = new RegExp('repository\\=(.+)&project\\=(.+)', 'g');\n          if (! (externalService instanceof Array) )\n            var url = externalService.replace(reg, 'repository='+layerConfig.repository+'&project='+layerConfig.project);\n          else\n            var url = jQuery.map(externalService, function(element) { return element.replace(reg, 'repository='+layerConfig.repository+'&project='+layerConfig.project) });\n\n          // creating the base layer\n          layerConfig.title = layerConfig.layerTitle\n          layerConfig.name = layerConfig.layerName\n          layerConfig.baselayer = true;\n          layerConfig.singleTile = \"False\";\n          evt.config.layers[layerName] = layerConfig;\n          evt.baselayers.push(new OpenLayers.Layer.WMS(layerName,url\n            ,layerWmsParams\n            ,{isBaseLayer:true\n            ,gutter:(layerConfig.cached == 'True') ? 0 : 5\n            ,buffer:0\n            ,singleTile:(layerConfig.singleTile == 'True')\n            ,ratio:1\n          }));\n          evt.map.allOverlays = false;\n\n        }\n      }\n\n    }\n   ,\n   'uicreated': function(evt){\n     var map = evt.map;\n     if ( map.id in OpenLayers.Layer.Google.cache ) {\n        google.maps.event.addListenerOnce(OpenLayers.Layer.Google.cache[map.id].mapObject, 'tilesloaded', function() {\n            var olLayers = map.layers;\n            var gVisibility = false;\n            for (var i=olLayers.length-1; i>=0; --i) {\n                var layer = olLayers[i];\n                if (layer instanceof OpenLayers.Layer.Google &&\n                            layer.visibility === true && layer.inRange === true) {\n                    layer.redraw(true);\n                    gVisibility = true;\n                    break;\n                }\n            }\n            if (!gVisibility) {\n                for (var i=olLayers.length-1; i>=0; --i) {\n                    var layer = olLayers[i];\n                    if (layer instanceof OpenLayers.Layer.Google) {\n                        layer.display(false);\n                        break;\n                    }\n                }\n            }\n        });\n     }\n\n      // Update legend if mobile\n      if( lizMap.checkMobile() ){\n        if( $('#button-switcher').parent().hasClass('active') )\n          $('#button-switcher').click();\n      }\n\n      // Connect dock close button\n      $('#dock-close').click(function(){ $('#mapmenu .nav-list > li.active.nav-dock > a').click(); });\n      $('#right-dock-close').click(function(){ $('#mapmenu .nav-list > li.active.nav-right-dock > a').click(); });\n   }\n\n});\n\n$(document).ready(function () {\n  // start waiting\n  $('body').css('cursor', 'wait');\n  $('#loading').dialog({\n    modal: true\n    , draggable: false\n    , resizable: false\n    , closeOnEscape: false\n    , dialogClass: 'liz-dialog-wait'\n    , minHeight: 128\n  })\n  .parent().removeClass('ui-corner-all')\n  .children('.ui-dialog-titlebar').removeClass('ui-corner-all');\n  // configurate OpenLayers\n  OpenLayers.DOTS_PER_INCH = 96;\n  // initialize LizMap\n  lizMap.init();\n  $( \"#loading\" ).css('min-height','128px');\n});\n"],"names":["window","lizMap","config","capabilities","wmtsCapabilities","wfsCapabilities","map","baselayers","layers","controls","printCapabilities","scales","layouts","tree","type","defaultGetFeatureInfoTolerances","externalBaselayersReplacement","startupBaselayersReplacement","cleanNameMap","layerIdMap","shortNameMap","typeNameMap","permalinkArgs","layerCleanNames","cleanName","aName","undefined","console","log","theCleanName","accentMap","term","ret","i","length","charAt","normalize","reg","RegExp","replace","performCleanName","nCleanName","getLayerNameByCleanName","layerName","updateContentSize","isMobile","mCheckMobile","$","hasClass","addClass","parent","click","is","hide","append","attr","show","removeClass","insertBefore","h","innerHeight","height","css","outerHeight","w","offsetWidth","parseInt","width","wmsMaxWidth","wmsMaxHeight","options","Number","removeSingleTile","newMapSize","getCurrentSize","replaceSingleTileSize","clone","wmsMaxMax","Math","max","wmsMinMax","min","mapMax","mapMin","OpenLayers","Size","round","len","layer","Layer","WMS","qgisName","name","configLayer","params","singleTile","addOptions","tileSize","ratio","center","getCenter","updateSize","setCenter","baseLayer","redraw","updateMiniDockSize","updateMapSize","mdmcv","getLayerLegendGraphicUrl","withScale","each","l","layerConfig","externalWmsToggle","externalAccess","legendParams","SERVICE","VERSION","REQUEST","LAYER","STYLE","styles","SLD_VERSION","EXCEPTIONS","FORMAT","TRANSPARENT","WIDTH","DPI","legendParamsString","Util","getParameterString","urlAppend","url","LAYERFONTSIZE","ITEMFONTSIZE","SYMBOLSPACE","ICONLABELSPACE","RULELABEL","id","getScale","service","lizUrls","wms","getLayerScale","nested","minScale","maxScale","nestedLayers","qgisLayerName","useLayerIDs","getLayerOrder","layersOrder","order","lOrder","getLayerTree","pNode","children","publicUrlList","j","jlen","push","wmtsFormat","Format","WMTSCapabilities","serviceUrl","toLowerCase","groupAsLayer","wmsStyles","s","qgisServerVersion","startsWith","node","lizLayerStyles","layerWmsParams","version","exceptions","format","imageFormat","dpi","attribution","href","indexOf","title","split","wmtsLayer","cached","contents","identifier","wmtsOptions","matrixSet","projection","ref","isBaseLayer","alwaysInRange","inArray","toUpperCase","resolutions","maxRes","numZoomLevels","zoomOffset","res","pow","createLayer","yx","reverseAxisOrder","projCode","this","getCode","parseFloat","Projection","defaults","extConfig","decodeURI","crs","transparent","lizLayerFilter","isVisible","toggled","visibility","transitionEffect","removeBackBufferDelay","gutter","buffer","wmsLayer","bbox","hasOverview","analyseNode","aNode","nodeConfig","result","removeIdx","analyse","reverse","splice","getSwitcherLine","aParent","str","html","parentConfig","geometryType","displayInLegend","mutuallyExclusive","lizDict","abstract","text","substr","n","legendLink","link","noLegendImage","basepath","getSwitcherNode","aLevel","child","updateLocateFeatureList","locate","locateByLayer","features","fid","filterValue","filterFieldName","val","feat","properties","vectorjoins","vectorjoin","jName","joinLayer","jLocate","jVal","jFeat","targetFieldName","joinFieldName","fieldName","clearDrawLayer","layer_name","getLayersByName","destroyFeatures","zoomToLocateFeature","proj","events","triggerEvent","GeoJSON","ignoreExtraDims","read","geometry","transform","getProjection","displayGeom","getFeatureUrlData","getVectorLayerWfsUrl","join","post","data","JSON","parse","addFeatures","fail","zoomToExtent","getBounds","getLocateFeature","fields","filterjoins","filterjoin","lConfig","loadProjDefinition","sort","a","b","aProperty","bProperty","isNaN","localeCompare","filterPlaceHolder","filterFieldAlias","fOptions","fValue","before","change","combobox","position","my","at","evt","ui","item","self","uiItem","setTimeout","autocomplete","placeHolder","fieldAlias","toString","oldVal","blur","minLength","createSwitcher","treeTable","stringExpand","stringCollapse","onNodeShow","find","limg","onNodeHide","on","event","which","isSelected","parents","toggleClass","itemType","itemName","childrenOf","siblings","descendantsOf","descendants","concat","parentOf","classNames","className","key","match","substring","ancestorsOf","ancestors","selfTr","first","parentTr","siblingsTr","c","childrenParentTr","siblingTr","setVisibility","slen","siblingButt","mutuallyExclusiveGroups","tr","butt","pId","count","checked","pchecked","trDesc","trd","trButt","windowLink","test","media","open","removeCache","confirm","mapSize","size","select","baselayer","units","addLayer","blConfig","e","blName","setBaseLayer","startupBaselayer","Vector","maxExtent","loadstart","object","loadend","aConfig","locateByLayerList","lname","locateContent","styleMap","StyleMap","pointRadius","fill","stroke","strokeWidth","strokeColor","strokeOpacity","featureTypes","getVectorLayerFeatureTypes","remove","featureType","typeName","getElementsByTagName","textContent","getNameByTypeName","lbl","getAttribute","lName","layerId","joinLayerId","lizmapLayerFilterActive","tooltip","viewport","deactivateToolControls","ctrl","Control","TYPE_TOOL","deactivate","createPermalinkArgs","args","Permalink","prototype","createParams","apply","arguments","getExtent","toBBOX","filter","style","opacity","getUrlParameters","oParametre","location","search","aItKey","nKeyId","aCouples","decodeURIComponent","updatePermalinkInputs","pHref","iframeSize","pIframe","onMapChangelayer","property","lconfig","bindGeobookmarkEvents","gburl","gbparams","geobookmark","q","repository","project","get","setGeobookmarkContent","geoparams","runPermalink","gbData","unbind","pparams","players","slist","layerStyles","lstyles","olist","layerOpacities","lopacities","btn","setOpacity","sp","flayer","ffids","Bounds","fromString","addGeometryFeatureInfo","popup","containerId","selector","geometries","minx","miny","maxx","maxy","geom","projLoaded","aProj","geomInfo","Geometry","fromWKT","Feature","fidInput","bounds","fromArray","eHtml","popupButtonBar","next","after","placement","hover","addChildrenDatavizFilteredByPopupFeature","mydiv","getLayerId","popupId","getLayerConfig","getLayerConfigById","relations","getLayerFeature","plotLayers","datavizLayers","lrelations","nbPlotByLayer","x","rel","getChildrenId","referencingLayer","referencingField","referencedField","layer_id","plot_config","popup_display_child_plot","plot_id","String","Date","valueOf","btoa","random","phtml","lizDataviz","buildPlotContainerHtml","haspc","getPlot","addChildrenFeatureInfo","pop","popupDisplayChildren","popupMaxFeatures","popupChidrenRequests","rConfigLayerAll","relation","rGetLayerConfig","rConfigLayer","clname","shortname","cleanname","wmsOptions","request_params","parentDiv","fetch","URLSearchParams","then","response","Promise","allSettled","popupChildrenData","childPopupElements","index","popupChildData","value","popupReg","childPopup","popupSource","popupDiv","prop","prepend","unwrap","tChildPopup","appendTo","oldPopupChild","parentPopupElement","getPrintScale","aScales","newScales","scale","scaleIdx","drawPrintBox","aLayout","aLayer","aScale","getUnits","unitsRatio","INCHES_PER_UNIT","printInProjectProjection","qgisProjectProjection","lon","lat","toGeometry","getCenterLonLat","drawFeature","getPrintGridInterval","refScale","theScale","aLayerId","aConfObjet","aIdAttribute","lx","aCRS","aCallback","Proj4js","defs","aText","mAddMessage","aMessage","aType","aClose","mType","mClose","elt","downloadFile","parameters","callback","xhr","XMLHttpRequest","responseType","onload","status","filename","disposition","getResponseHeader","matches","exec","navigator","userAgent","blob","File","downloadUrl","URL","createObjectURL","document","createElement","download","dispatchEvent","MouseEvent","revokeObjectURL","parenthesis_regex","error_message","setRequestHeader","send","param","getVectorLayerSelectionFeatureIdsString","featureidParameter","fids","aFilter","aFeatureId","geometryName","restrictToMapExtent","startIndex","maxFeatures","getNameByCleanName","getNameByShortName","typename","wfsOptions","filterParam","extent","projFeat","featureDataPool","callFeatureDataCallBacks","poolId","callbacksData","callbacks","forEach","alias","getFeatureData","aFeatureID","aGeometryName","aCallBack","stringify","featureCrs","describe","aliases","types","columns","aCallbackNotfound","forceToLoad","featureId","cFeatures","cAliases","addDock","dname","dlabel","dtype","dcontent","dicon","dockli","docktab","docktabli","obj","dictionary","checkMobile","shortName","addMessage","translateWfsFieldValues","fieldValue","translation_dict","zoomToFeature","zoomAction","feature","lonlat","zoomToOlFeature","getPrintCapabilities","getExternalBaselayersReplacement","launchTooltipLayer","aLayerName","tlOptions","launchEdition","deleteEditionFeature","exportVectorLayer","eformat","exportLayers","selectionLayer","config_layer","is_spatial","has_selection_token","has_parenthesis","selection_token","getVectorLayerResultFormat","formats","tagName","getFeaturePopupContent","popups","removePopup","pkey","attributeLayers","atlas","Array","isArray","primaryKey","getFeaturePopupContentByFeatureIntersection","getResolutionFromScale","geomType","CLASS_NAME","vert","getVertices","middlePoint","floor","LonLat","y","gfiCrs","getProjectionObject","selectLayerFeaturesFromSelectionFeature","targetFeatureType","selectionFeature","geomOperator","gml3","GML","v3","internalProjection","externalProjection","srsName","gml","writeNode","spatialFilter","XML","write","rFilter","eFilter","limitDataToBbox","geomBounds","tfeatures","sfIds","mainLizmap","selectionTool","newAddRemoveSelected","asfIds","asfIdIdx","getHashParamFromUrl","hash_key","hash_items","hash","triggerLayerFilter","layername","layerN","lfilter","surl","sdata","request","filtertoken","token","deactivateMaplayerFilter","init","configRequest","json","WMSRequest","WMTSRequest","WFSRequest","all","responses","domparser","DOMParser","wmsCapaData","wmtsCapaData","wfsCapaData","aData","WMSCapabilities","capability","wmtsElem","exceptionReport","texts","parseFromString","Object","assign","osmMapnik","osmStamenToner","osmCyclemap","googleStreets","googleSatellite","googleHybrid","googleTerrain","bingStreets","bingSatellite","bingHybrid","ignTerrain","ignStreets","ignSatellite","ignCadastral","proj4","projOSM","toArray","mapScales","zoomLevelNumber","initialExtent","initBbox","hasBaselayers","emptyBaselayer","minRes","getScaleFromResolution","beforeLayerTreeCreated","firstLayer","lizProj4","wmsBbox","wmsBounds","intersectsBounds","initProjections","restrictedExtent","mapHeight","clientHeight","nScales","IMAGE_RELOAD_ATTEMPTS","DEFAULT_PRECISION","Map","Navigation","mouseWheelOptions","interval","tileManager","eventListeners","zoomend","inRange","collapse","aDesc","allOverlays","addControl","Attribution","div","getElementById","addEventListener","createMap","lastLayerZIndex","getZIndex","Z_INDEX_BASE","configOptions","info","verifyingVisibility","hrefParam","getParameters","BBOX","hrefBbox","CRS","containsBounds","projBbox","slider","orientation","getZoom","zoom","zoomTo","navCtrl","getControlsByClass","zoomBox","keyMask","zoomBoxKeyMask","handler","dragHandler","handlers","wheel","activate","edition","active","featureInfo","url_params","zoomIn","zoomOut","hCtrl","NavigationHistory","addControls","previousStack","previousTrigger","previous","nextStack","nextTrigger","moveend","createNavbar","popupsAvailable","editionLayer","editionLayers","modifyGeometry","modifyAttribute","deleteFeature","popupLocation","pcontent","tolerances","fiurl","lastLonLatInfo","WMSGetFeatureInfo","TYPE_TOGGLE","queryVisible","infoFormat","vendorParams","pointTolerance","lineTolerance","polygonTolerance","handlerOptions","pixelTolerance","getfeatureinfo","eventLonLatInfo","getLonLatFromPixel","xy","popupContainerId","hasPopupContent","Popup","LizmapAnchored","panMapIfOutOfView","addPopup","preventDefault","tab","verifySize","layerUrls","refreshGetFeatureInfo","updateDrawing","lastPx","getPixelFromLonLat","refreshInfo","findLayers","candidates","WMTS","getVisibility","calculateInRange","drillDown","requestParams","addFeatureInfo","printTemplates","pTemplates","pTemplate","enabled","ptTomm","scaleOptions","scaleText","toLocaleString","pMap","pMapIdx","pOverview","maps","mapWidth","grid","Style","fillColor","fillOpacity","layout","dragCtrl","DragFeature","geometryTypes","template","labels","tLabel","htmlState","pTableVectorLayers","tables","t","composerMap","mapId","vectorLayer","project_projection","project_proj","printParams","querySelector","gridInterval","printLayers","styleLayers","opacityLayers","lst","activeBaseLayerName","exbl","activeBaseLayerConfig","overviewId","oExtent","unshift","customPrintLabels","querySelectorAll","label","selection","formatWKT","WKT","highlightGeom","highlightSymbol","digitizing","featureDrawn","featureDrawnVisibility","draw_feature","getFeatureDrawnSLD","printLaunch","disabled","classList","add","minidockopened","minidockclosed","addPrintControl","tooltipLayers","tooltipLayersDic","tooltipLayersSorted","ttl","tooltipStyleMap","cursor","tlayer","tooltipControl","HighlightFeature","displayPopup","popupOffset","popupTitle","popupSize","addInfoPopup","tf","trim","tooltipFields","hiddenFields","attributes","oMapExtent","nReso","getResolution","oPopupPos","left","top","tpopup","Anchored","offset","autoSize","backgroundColor","featureid","fName","fFilter","fFeatures","fAliases","tconfig","colorGeom","removeAttr","addTooltipControl","addRules","Rule","symbolizer","graphicName","strokeDashstyle","measureControls","Measure","Handler","Path","persist","geodesic","immediate","layerOptions","area","Polygon","perimeter","angle","maxVertices","handleMeasurements","measure","out","components","invert","firstComponent","secondComponent","move","A","B","C","AB","sqrt","BC","AC","angleInDegrees","acos","PI","toFixed","element","eventType","stat","getBestLength","control","activeCtrl","addMeasureControls","pLink","eLink","target","submit","bname","afilter","createPermalink","layersHaveBeenActivatedByPermalink","uparams","cb","oLayer","configureLayers","lSel","oldActive","lizmapEvent","dock","dialog","Events","includeXY","lOptions","maxResolution","osm","OSM","stamenToner","cyclemap","OCMKey","gsat","Google","google","MapTypeId","SATELLITE","minZoomLevel","zoomDuration","ghyb","HYBRID","gphy","TERRAIN","gmap","bmap","Bing","bingKey","baerial","bhybrid","ignAttribution","ignKey","ignmap","ignplan","ignphoto","igncadastral","externalService","layerImageFormat","jQuery","layerTitle","cache","addListenerOnce","mapObject","olLayers","gVisibility","display","ready","modal","draggable","resizable","closeOnEscape","dialogClass","minHeight","DOTS_PER_INCH"],"sourceRoot":""}